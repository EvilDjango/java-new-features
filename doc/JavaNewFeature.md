# Java æ–°ç‰¹æ€§å®æ“æ‰‹å†Œ (Java 8 -> 24)

æœ¬æ–‡æ¡£æ˜¯ä¸€ä»½è¯¦å°½çš„å®æ“æŒ‡å—ï¼Œæ—¨åœ¨æ·±å…¥ã€é€å½»åœ°è®²è§£ä» Java 8 åˆ° Java 24 çš„æ ¸å¿ƒæ–°ç‰¹æ€§ã€‚å®ƒä¸ä»…åŒ…å«ç‰¹æ€§çš„åŸºæœ¬ç”¨æ³•ï¼Œæ›´æ²‰æ·€äº†æˆ‘ä»¬å…³äºå®ç°åŸç†ã€æœ€ä½³å®è·µã€å¸¸è§é™·é˜±å’Œæ€§èƒ½å½±å“çš„æ·±å…¥æ¢è®¨ï¼Œå¯ä½œä¸ºæ‚¨åœ¨æ—¥å¸¸å¼€å‘å’Œæ¶æ„è®¾è®¡ä¸­çš„å‚è€ƒæ‰‹å†Œã€‚

> **ğŸ“– æ–‡æ¡£ä½¿ç”¨æŒ‡å—**
> - æ€»è®¡çº¦ 5700 è¡Œï¼Œæ¶µç›– 26 ä¸ªæ ¸å¿ƒç‰¹æ€§
> - æ¯ä¸ªç‰¹æ€§éƒ½åŒ…å«å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
> - å»ºè®®ä½¿ç”¨ Ctrl+F (æˆ– Cmd+F) å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šå†…å®¹
> - ç‚¹å‡»ç›®å½•é“¾æ¥å¯ç›´æ¥è·³è½¬åˆ°å¯¹åº”ç« èŠ‚

---

## ğŸš€ å¿«é€Ÿå¯¼èˆª

### æŒ‰ Java ç‰ˆæœ¬å¿«é€ŸæŸ¥æ‰¾
| Java ç‰ˆæœ¬ | ä¸»è¦ç‰¹æ€§ | ç›´æ¥é“¾æ¥ |
|-----------|---------|---------|
| Java 9 | æ¨¡å—åŒ–ã€é›†åˆå·¥å‚ã€JShell | [æ¨¡å—åŒ–ç³»ç»Ÿ](#18-æ¨¡å—åŒ–ç³»ç»Ÿ-project-jigsaw-java-9) \| [é›†åˆå·¥å‚æ–¹æ³•](#15-é›†åˆå·¥å‚æ–¹æ³•-collection-factory-methods-java-9) \| [JShell](#23-jshell-java-repl-å·¥å…·-java-9) |
| Java 10 | `var` ç±»å‹æ¨æ–­ | [å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­](#1-å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­-var-java-10) |
| Java 11 | HTTP å®¢æˆ·ç«¯ã€å•æ–‡ä»¶å¯åŠ¨ã€JFR | [HTTP å®¢æˆ·ç«¯](#14-http-å®¢æˆ·ç«¯-standard-http-client-java-11) \| [å•æ–‡ä»¶å¯åŠ¨](#24-å•æ–‡ä»¶æºç ç¨‹åºå¯åŠ¨-java-11) \| [JFR](#26-é£è¡Œè®°å½•å™¨-jfr-java-11) |
| Java 14 | Switch è¡¨è¾¾å¼ã€è¯¦å°½ NPE | [Switch è¡¨è¾¾å¼](#2-switch-è¡¨è¾¾å¼-java-14) \| [è¯¦å°½ NPE](#25-æ›´è¯¦å°½çš„-nullpointerexception-java-14) |
| Java 15 | æ–‡æœ¬å—ã€æ–° GC | [æ–‡æœ¬å—](#3-æ–‡æœ¬å—-text-blocks-java-15) \| [æ–°åƒåœ¾æ”¶é›†å™¨](#19-æ–°çš„åƒåœ¾æ”¶é›†å™¨-zgc--shenandoah-java-15) |
| Java 16 | è®°å½•ç±»ã€æ¨¡å¼åŒ¹é… | [è®°å½•ç±»](#4-è®°å½•ç±»-record-java-16) \| [æ¨¡å¼åŒ¹é…](#6-æ¨¡å¼åŒ¹é…-pattern-matching-java-16-23) |
| Java 17 | å¯†å°ç±» | [å¯†å°ç±»](#5-å¯†å°ç±»å’Œæ¥å£-sealed-classes-java-17) |
| Java 21 | è™šæ‹Ÿçº¿ç¨‹ã€æœ‰åºé›†åˆ | [è™šæ‹Ÿçº¿ç¨‹](#10-è™šæ‹Ÿçº¿ç¨‹-virtual-threads-java-21-æ­£å¼) \| [æœ‰åºé›†åˆ](#13-æœ‰åºé›†åˆ-sequenced-collections-java-21) |
| Java 22 | FFI & Memory APIã€ç»“æ„åŒ–å¹¶å‘ | [å¤–éƒ¨å‡½æ•°ä¸å†…å­˜ API](#20-å¤–éƒ¨å‡½æ•°ä¸å†…å­˜-api-foreign-function--memory-api-java-22-æ­£å¼) \| [ç»“æ„åŒ–å¹¶å‘](#11-ç»“æ„åŒ–å¹¶å‘-structured-concurrency-java-22-é¢„è§ˆ) |
| Java 24 | Vector APIã€Class-File APIã€Stream Gatherers | [å‘é‡ API](#21-å‘é‡-api-vector-api-java-24-ç¬¬ä¹è½®å­µåŒ–) \| [ç±»æ–‡ä»¶ API](#22-ç±»æ–‡ä»¶-api-class-file-api-java-24-æ­£å¼) \| [Stream èšåˆå™¨](#17-stream-èšåˆå™¨-stream-gatherers-java-24-æ­£å¼) |

### æŒ‰åŠŸèƒ½åˆ†ç±»å¿«é€ŸæŸ¥æ‰¾
| åˆ†ç±» | ç›¸å…³ç‰¹æ€§ | ç›´æ¥é“¾æ¥ |
|------|---------|---------|
| ğŸ¯ è¯­æ³•å¢å¼º | varã€Switchè¡¨è¾¾å¼ã€æ–‡æœ¬å—ã€è®°å½•ç±»ã€å¯†å°ç±» | [è¯­è¨€æ ¸å¿ƒç‰¹æ€§](#ä¸€-è¯­è¨€æ ¸å¿ƒä¸è¯­æ³•) |
| âš¡ å¹¶å‘æ€§èƒ½ | è™šæ‹Ÿçº¿ç¨‹ã€ç»“æ„åŒ–å¹¶å‘ã€ä½œç”¨åŸŸå€¼ã€æ–°GC | [å¹¶å‘ä¸æ€§èƒ½](#äºŒ-å¹¶å‘ä¸æ€§èƒ½) |
| ğŸ“š API å¢å¼º | HTTPå®¢æˆ·ç«¯ã€é›†åˆå¢å¼ºã€Streamå¢å¼º | [API ä¸æ ‡å‡†åº“](#ä¸‰-api-ä¸åº“) |
| ğŸ—ï¸ å¹³å°æ¶æ„ | æ¨¡å—åŒ–ã€FFIã€Vector APIã€Class-File API | [å¹³å°ä¸æ¶æ„](#å››-jvm-ä¸åº•å±‚) |
| ğŸ› ï¸ å¼€å‘å·¥å…· | JShellã€å•æ–‡ä»¶å¯åŠ¨ã€è¯¦å°½NPEã€JFR | [å¼€å‘ä½“éªŒä¸å·¥å…·](#äº”-å¼€å‘ä½“éªŒä¸å·¥å…·) |

---

## ğŸ“‹ è¯¦ç»†ç›®å½•

*   [**ä¸€ã€ è¯­è¨€æ ¸å¿ƒç‰¹æ€§**](#ä¸€-è¯­è¨€æ ¸å¿ƒä¸è¯­æ³•)
    *   [1. å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­ (`var`) (Java 10)](#1-å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­-var-java-10)
    *   [2. Switch è¡¨è¾¾å¼ (Java 14)](#2-switch-è¡¨è¾¾å¼-java-14)
    *   [3. æ–‡æœ¬å— (Text Blocks) (Java 15)](#3-æ–‡æœ¬å—-text-blocks-java-15)
    *   [4. è®°å½•ç±» (`record`) (Java 16)](#4-è®°å½•ç±»-record-java-16)
    *   [5. å¯†å°ç±»å’Œæ¥å£ (Sealed Classes) (Java 17)](#5-å¯†å°ç±»å’Œæ¥å£-sealed-classes-java-17)
    *   [6. æ¨¡å¼åŒ¹é… (Pattern Matching) (Java 16-23)](#6-æ¨¡å¼åŒ¹é…-pattern-matching-java-16-23)
    *   [7. æœªå‘½åæ¨¡å¼å’Œå˜é‡ (Unnamed Patterns & Variables) (Java 22, æ­£å¼)](#7-æœªå‘½åæ¨¡å¼å’Œå˜é‡-unnamed-patterns--variables-java-22-æ­£å¼)
    *   [8. æœªå‘½åç±»å’Œå®ä¾‹ main æ–¹æ³• (Unnamed Classes and Instance Main Methods) (Java 21, é¢„è§ˆ)](#8-æœªå‘½åç±»å’Œå®ä¾‹-main-æ–¹æ³•-unnamed-classes-and-instance-main-methods-java-21-é¢„è§ˆ)
    *   [9. `super(...)` ä¹‹å‰çš„è¯­å¥ (Statements before `super(...)`) (Java 22, é¢„è§ˆ)](#9-super-ä¹‹å‰çš„è¯­å¥-statements-before-super-java-22-é¢„è§ˆ)
*   [**äºŒã€ å¹¶å‘ä¸æ€§èƒ½**](#äºŒ-å¹¶å‘ä¸æ€§èƒ½)
    *   [10. è™šæ‹Ÿçº¿ç¨‹ (Virtual Threads) (Java 21, æ­£å¼)](#10-è™šæ‹Ÿçº¿ç¨‹-virtual-threads-java-21-æ­£å¼)
    *   [11. ç»“æ„åŒ–å¹¶å‘ (Structured Concurrency) (Java 22, é¢„è§ˆ)](#11-ç»“æ„åŒ–å¹¶å‘-structured-concurrency-java-22-é¢„è§ˆ)
    *   [12. ä½œç”¨åŸŸå€¼ (Scoped Values) (Java 22, é¢„è§ˆ)](#12-ä½œç”¨åŸŸå€¼-scoped-values-java-22-é¢„è§ˆ)
    *   [19. æ–°çš„åƒåœ¾æ”¶é›†å™¨ (ZGC & Shenandoah) (Java 15)](#19-æ–°çš„åƒåœ¾æ”¶é›†å™¨-zgc--shenandoah-java-15)
*   [**ä¸‰ã€ API ä¸æ ‡å‡†åº“**](#ä¸‰-api-ä¸åº“)
    *   [13. æœ‰åºé›†åˆ (Sequenced Collections) (Java 21)](#13-æœ‰åºé›†åˆ-sequenced-collections-java-21)
    *   [14. HTTP å®¢æˆ·ç«¯ (Standard HTTP Client) (Java 11)](#14-http-å®¢æˆ·ç«¯-standard-http-client-java-11)
    *   [15. é›†åˆå·¥å‚æ–¹æ³• (Collection Factory Methods) (Java 9)](#15-é›†åˆå·¥å‚æ–¹æ³•-collection-factory-methods-java-9)
    *   [16. Stream, Optional, String ç­‰ API å¢å¼º (Java 9+)](#16-stream-optional-string-ç­‰-api-å¢å¼º-java-9)
    *   [17. Stream èšåˆå™¨ (Stream Gatherers) (Java 24, æ­£å¼)](#17-stream-èšåˆå™¨-stream-gatherers-java-24-æ­£å¼)
*   [**å››ã€ å¹³å°ä¸æ¶æ„**](#å››-jvm-ä¸åº•å±‚)
    *   [18. æ¨¡å—åŒ–ç³»ç»Ÿ (Project Jigsaw) (Java 9)](#18-æ¨¡å—åŒ–ç³»ç»Ÿ-project-jigsaw-java-9)
    *   [20. å¤–éƒ¨å‡½æ•°ä¸å†…å­˜ API (Foreign Function & Memory API) (Java 22, æ­£å¼)](#20-å¤–éƒ¨å‡½æ•°ä¸å†…å­˜-api-foreign-function--memory-api-java-22-æ­£å¼)
    *   [21. å‘é‡ API (Vector API) (Java 24, ç¬¬ä¹è½®å­µåŒ–)](#21-å‘é‡-api-vector-api-java-24-ç¬¬ä¹è½®å­µåŒ–)
    *   [22. ç±»æ–‡ä»¶ API (Class-File API) (Java 24, æ­£å¼)](#22-ç±»æ–‡ä»¶-api-class-file-api-java-24-æ­£å¼)
*   [**äº”ã€ å¼€å‘ä½“éªŒä¸å·¥å…·**](#äº”-å¼€å‘ä½“éªŒä¸å·¥å…·)
    *   [23. JShell: Java REPL å·¥å…· (Java 9)](#23-jshell-java-repl-å·¥å…·-java-9)
    *   [24. å•æ–‡ä»¶æºç ç¨‹åºå¯åŠ¨ (Java 11)](#24-å•æ–‡ä»¶æºç ç¨‹åºå¯åŠ¨-java-11)
    *   [25. æ›´è¯¦å°½çš„ NullPointerException (Java 14)](#25-æ›´è¯¦å°½çš„-nullpointerexception-java-14)
    *   [26. é£è¡Œè®°å½•å™¨ (JFR) (Java 11)](#26-é£è¡Œè®°å½•å™¨-jfr-java-11)

---

## ä¸€ã€ è¯­è¨€æ ¸å¿ƒä¸è¯­æ³•

### 1. å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­ (`var`) (Java 10)

*   **æ¼”è¿›**: Java 10 æ­£å¼å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: åœ¨å£°æ˜å±€éƒ¨å˜é‡æ—¶ï¼Œä½¿ç”¨ `var` æ›¿ä»£å…·ä½“ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®å³ä¾§çš„åˆå§‹åŒ–è¡¨è¾¾å¼è‡ªåŠ¨æ¨æ–­å‡ºå˜é‡çš„å‡†ç¡®ç±»å‹ã€‚

    > **æ³¨æ„**: è¿™ä¸æ˜¯åŠ¨æ€ç±»å‹ï¼`var` å£°æ˜çš„å˜é‡ç±»å‹åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šï¼Œåç»­ä¸èƒ½å†èµ‹ä¸åŒç±»å‹çš„å€¼ã€‚

*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **ç®€æ´æ€§**: æå¤§å‡å°‘äº†å†—é•¿çš„ç±»å‹å£°æ˜ï¼Œå°¤å…¶åœ¨é¢å¯¹å¤æ‚çš„æ³›å‹ç±»å‹æ—¶æ•ˆæœæ˜¾è‘—ã€‚
    *   **å¯è¯»æ€§**: å½“å˜é‡åå·²æ¸…æ™°è¡¨è¾¾æ„å›¾æ—¶ï¼Œçœç•¥ç±»å‹å£°æ˜èƒ½è®©ä»£ç æ›´èšç„¦äºä¸šåŠ¡é€»è¾‘ã€‚

*   **ä»£ç å®æˆ˜å¯¹æ¯”**:
    ```java
    // Java 10 ä¹‹å‰ï¼Œç±»å‹å£°æ˜éå¸¸å†—é•¿
    Map<String, List<Integer>> transactionsByMerchant = new HashMap<String, List<Integer>>();
    
    // ä½¿ç”¨ varï¼Œä»£ç æ›´æ•´æ´ï¼Œæ„å›¾åŒæ ·æ¸…æ™°
    var transactionsByMerchant = new HashMap<String, List<Integer>>();
    ```

*   **å®æ“é™åˆ¶ä¸è§„åˆ™**:
    *   **å¿…é¡»åˆå§‹åŒ–**: å£°æ˜æ—¶å¿…é¡»ç«‹å³åˆå§‹åŒ–ï¼Œå¦åˆ™ç¼–è¯‘å™¨æ— æ³•æ¨æ–­ç±»å‹ã€‚
    *   **ä»…é™å±€éƒ¨ä½¿ç”¨**: åªèƒ½ç”¨äºæ–¹æ³•å†…çš„å±€éƒ¨å˜é‡ã€`for` å¾ªç¯ã€`try-with-resources` è¯­å¥ç­‰ã€‚
    *   **ç¦æ­¢ç”¨äº**: ç±»æˆå‘˜å˜é‡ï¼ˆå­—æ®µï¼‰ã€æ–¹æ³•å‚æ•°ã€æ–¹æ³•è¿”å›ç±»å‹ã€‚

### 2. Switch è¡¨è¾¾å¼ (Java 14)

*   **æ¼”è¿›**: Java 14 æ­£å¼å‘å¸ƒã€‚
*   **æ ¸å¿ƒç†å¿µ**: å¯¹ä¼ ç»Ÿ `switch` è¯­å¥çš„å¢å¼ºï¼Œä½¿å…¶å¯ä»¥ä½œä¸ºè¡¨è¾¾å¼ä½¿ç”¨ï¼Œèƒ½å¤Ÿè¿”å›å€¼ã€‚è¿™è®©ä»£ç æ›´ç®€æ´ã€æ›´å®‰å…¨ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **è¡¨è¾¾å¼è¿”å›å€¼**: å¯å°† `switch` çš„ç»“æœç›´æ¥èµ‹å€¼ç»™å˜é‡ã€‚
    *   **ç®€æ´å®‰å…¨**: ä½¿ç”¨ `->` ç®­å¤´è¯­æ³•æ›¿ä»£ `case...break`ï¼Œä»æ ¹æœ¬ä¸Šé¿å…äº†å› å¿˜è®° `break` å¯¼è‡´çš„â€œè´¯ç©¿â€é”™è¯¯ã€‚
    *   **ç¼–è¯‘æœŸè¯¦å°½æ€§**: ä½œä¸ºè¡¨è¾¾å¼ä½¿ç”¨æ—¶ï¼Œç¼–è¯‘å™¨å¼ºåˆ¶è¦æ±‚è¦†ç›–æ‰€æœ‰å¯èƒ½æƒ…å†µï¼ˆæˆ–æä¾› `default`ï¼‰ï¼Œå°†æ½œåœ¨çš„è¿è¡Œæ—¶é”™è¯¯æå‰åˆ°ç¼–è¯‘æœŸå‘ç°ã€‚

*   **ä»£ç å®æˆ˜å¯¹æ¯”**:
    ```java
    // ä¼ ç»Ÿ Switch è¯­å¥ï¼Œéœ€è¦ä¸´æ—¶å˜é‡ï¼Œä¸”æœ‰ break é—æ¼é£é™©
    DayOfWeek day = DayOfWeek.TUESDAY;
    int numLetters;
    switch (day) {
        case MONDAY:
        case FRIDAY:
        case SUNDAY:
            numLetters = 6;
            break;
        case TUESDAY:
            numLetters = 7;
            break;
        case THURSDAY:
        case SATURDAY:
            numLetters = 8;
            break;
        case WEDNESDAY:
            numLetters = 9;
            break;
        default:
            throw new IllegalStateException("Invalid day: " + day);
    }
    
    // ä½¿ç”¨ Switch è¡¨è¾¾å¼ï¼Œä»£ç æ›´ç´§å‡‘ã€æ›´å®‰å…¨
    int numLetters2 = switch (day) {
        case MONDAY, FRIDAY, SUNDAY -> 6;
        case TUESDAY                -> 7;
        case THURSDAY, SATURDAY     -> 8;
        case WEDNESDAY              -> 9;
        default -> throw new IllegalStateException("Invalid day: " + day);
    };
    ```
    > **æ³¨æ„**: `switch` çš„æ¨¡å¼åŒ¹é…èƒ½åŠ›æ˜¯å…¶æ›´å¼ºå¤§çš„æ‰©å±•ï¼Œæˆ‘ä»¬åœ¨ [ç¬¬6èŠ‚](#6-æ¨¡å¼åŒ¹é…-pattern-matching-java-16-23) ä¸­ç»Ÿä¸€è¯¦ç»†è®²è§£ã€‚

### 3. æ–‡æœ¬å— (Text Blocks) (Java 15)

*   **æ¼”è¿›**: Java 15 æ­£å¼å‘å¸ƒã€‚
*   **æ ¸å¿ƒç†å¿µ**: ä½¿ç”¨ä¸‰ä¸ªåŒå¼•å· `"""` åŒ…è£¹ï¼Œè½»æ¾å®šä¹‰å¤šè¡Œå­—ç¬¦ä¸²å­—é¢é‡ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **å¯è¯»æ€§**: ç¼–å†™ SQLã€JSONã€HTML ç­‰å¤šè¡Œæ–‡æœ¬æ—¶ï¼Œæ ¼å¼æ‰€è§å³æ‰€å¾—ï¼Œæ— éœ€ `\n` å’Œ `+` æ‹¼æ¥ã€‚
    *   **æ™ºèƒ½ç¼©è¿›**: è‡ªåŠ¨ç§»é™¤æ‰€æœ‰è¡Œå…±æœ‰çš„â€œé™„å¸¦â€å‰å¯¼ç©ºæ ¼ï¼Œåªä¿ç•™å¼€å‘è€…çœŸæ­£æƒ³è¦çš„â€œå¿…è¦â€ç›¸å¯¹ç¼©è¿›ï¼Œä¿æŒä»£ç ç¾è§‚å’Œå†…å®¹çº¯å‡€ã€‚

*   **ä»£ç å®æˆ˜å¯¹æ¯”**:
    ```java
    // ä¼ ç»Ÿæ–¹å¼æ‹¼æ¥ JSONï¼Œå¯è¯»æ€§å·®ä¸”å®¹æ˜“å‡ºé”™
    String json = "{\n" +
                  "  \"name\": \"å§œå“¥\",\n" +
                  "  \"role\": \"Developer\"\n" +
                  "}";
    
    // ä½¿ç”¨æ–‡æœ¬å—ï¼Œç»“æ„æ¸…æ™°ï¼Œæ‰€è§å³æ‰€å¾—
    String textBlockJson = """
                           {
                             "name": "å§œå“¥",
                             "role": "Developer"
                           }
                           """;
    ```

### 4. è®°å½•ç±» (`record`) (Java 16)

* **æ¼”è¿›**: Java 16 æ­£å¼å‘å¸ƒã€‚
* **æ ¸å¿ƒç†å¿µ**: ä¸€ç§ç”¨äºå£°æ˜**ä¸å¯å˜æ•°æ®èšåˆä½“**çš„ç®€æ´è¯­æ³•ã€‚å®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„ã€`final` çš„ç±»ã€‚
* **æ ¸å¿ƒä¼˜åŠ¿**: å½»åº•æ¶ˆé™¤åˆ›å»º DTOã€POJO ç­‰æ•°æ®è½½ä½“ç±»æ—¶æ‰€éœ€çš„å¤§é‡æ ·æ¿ä»£ç ï¼Œè®©ä»£ç æ›´ç®€æ´ã€æ›´å®‰å…¨ã€æ›´ä¸“æ³¨äºæ•°æ®æœ¬èº«ã€‚

* **ä»£ç å®æˆ˜å¯¹æ¯”**:
    ```java
    // Java 16 ä¹‹å‰ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–å†™å¤§é‡æ ·æ¿ä»£ç çš„ POJO
    public final class PointPojo {
        private final int x;
        private final int y;
    
        public PointPojo(int x, int y) {
            this.x = x;
            this.y = y;
        }
    
        public int x() { return x; }
        public int y() { return y; }
    
        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (o == null || getClass() != o.getClass()) return false;
            PointPojo pointPojo = (PointPojo) o;
            return x == pointPojo.x && y == pointPojo.y;
        }
    
        @Override
        public int hashCode() {
            return java.util.Objects.hash(x, y);
        }
    
        @Override
        public String toString() {
            return "PointPojo[" +
                   "x=" + x + ", " +
                   "y=" + y + "]";
        }
    }
    
    // ä½¿ç”¨ recordï¼Œä¸€è¡Œä»£ç å³å¯è·å¾—åŠŸèƒ½å®Œå¤‡çš„ä¸å¯å˜ç±»
    record Point(int x, int y) {}
    ```

* **è‡ªåŠ¨ç”Ÿæˆä¸è‡ªå®šä¹‰**: ç¼–è¯‘å™¨ä¼šä¸ºä½ ç”Ÿæˆæ‰€æœ‰ç»„ä»¶çš„ `private final` å­—æ®µã€ä¸€ä¸ªå…¨å‚æ•°å…¬å…±æ„é€ å™¨ã€æ¯ä¸ªç»„ä»¶çš„å…¬å…±è®¿é—®å™¨æ–¹æ³•ï¼ˆå¦‚ `point.x()`ï¼‰ã€ä»¥åŠåŸºäºæ‰€æœ‰ç»„ä»¶å®ç°çš„ `equals()`, `hashCode()`, `toString()` æ–¹æ³•ã€‚åŒæ—¶ï¼Œä½ ä»ç„¶å¯ä»¥æ·»åŠ é™æ€å­—æ®µ/æ–¹æ³•ã€å®ä¾‹æ–¹æ³•ï¼Œæˆ–é€šè¿‡â€œç´§å‡‘æ„é€ å‡½æ•°â€æ¥æ·»åŠ æ ¡éªŒé€»è¾‘ã€‚

    ```java
    // ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„ Point record
    record PointWithValidation(int x, int y) {
        // ç´§å‡‘æ„é€ å‡½æ•°ï¼Œç”¨äºæ ¡éªŒ
        public PointWithValidation {
            if (x < 0 || y < 0) {
                throw new IllegalArgumentException("åæ ‡ä¸èƒ½ä¸ºè´Ÿæ•°");
            }
            // æ— éœ€ this.x = x; èµ‹å€¼æ˜¯è‡ªåŠ¨çš„
        }
    
        // è‡ªå®šä¹‰å®ä¾‹æ–¹æ³•
        public double distanceToOrigin() {
            return Math.sqrt(x * x + y * y);
        }
    }
    ```

### 5. å¯†å°ç±»å’Œæ¥å£ (Sealed Classes) (Java 17)

*   **æ¼”è¿›**: Java 17 æ­£å¼å‘å¸ƒã€‚
*   **æ ¸å¿ƒç†å¿µ**: é€šè¿‡ `sealed` å’Œ `permits` å…³é”®å­—ï¼Œç²¾ç¡®åœ°æ§åˆ¶ä¸€ä¸ªç±»æˆ–æ¥å£çš„ç»§æ‰¿ä½“ç³»ï¼Œæœ‰ä¸”åªæœ‰ `permits` åˆ—è¡¨ä¸­æŒ‡å®šçš„å­ç±»å¯ä»¥ç»§æ‰¿æˆ–å®ç°å®ƒã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **æ¶æ„æ¸…æ™°**: ä½œè€…å¯ä»¥æ˜ç¡®è¡¨è¾¾ç»§æ‰¿çš„è®¾è®¡æ„å›¾ï¼Œé˜²æ­¢è¢«æ„å¤–æˆ–æ¶æ„æ‰©å±•ã€‚
    *   **ç¼–è¯‘æœŸå®‰å…¨**: ä¸ `switch` æ¨¡å¼åŒ¹é…å®Œç¾ç»“åˆã€‚å½“å¯¹ä¸€ä¸ª `sealed` ç±»å‹è¿›è¡Œ `switch` æ—¶ï¼Œå¦‚æœè¦†ç›–äº†æ‰€æœ‰ `permits` çš„å­ç±»ï¼Œåˆ™**æ— éœ€ `default` åˆ†æ”¯**ï¼Œç¼–è¯‘å™¨ä¼šè¿›è¡Œè¯¦å°½æ€§æ£€æŸ¥ï¼Œä¿è¯ä»£ç å®Œå¤‡ã€‚

*   **è®¾è®¡å“²å­¦ä¸åŠ¨æœº**:
    *   **å»ºæ¨¡ç²¾ç¡®æ€§**: å…è®¸åº“ä½œè€…å®šä¹‰â€œä»£æ•°æ•°æ®ç±»å‹â€(ADT)ï¼Œå³ä¸€ä¸ªç±»å‹çš„å¯èƒ½å½¢æ€æ˜¯æœ‰é™ä¸”å·²çŸ¥çš„é›†åˆã€‚è¿™åœ¨å»ºæ¨¡é¢†åŸŸç‰¹å®šè¯­è¨€æˆ–çŠ¶æ€æœºæ—¶éå¸¸å¼ºå¤§ã€‚
    *   **API æ¼”åŒ–æ§åˆ¶**: é˜²æ­¢å¤–éƒ¨å®¢æˆ·ç«¯éšæ„æ‰©å±•æ ¸å¿ƒç±»ï¼Œç¡®ä¿äº†åº“çš„å°è£…æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ä½œè€…å¯ä»¥å®‰å…¨åœ°æ·»åŠ æ–°çš„ `permits` å­ç±»ï¼Œè€Œä¸ç”¨æ‹…å¿ƒç ´åæœªçŸ¥å®ç°è€…çš„ä»£ç ã€‚
    *   **èµ‹èƒ½æ¨¡å¼åŒ¹é…**: è¿™æ˜¯ `sealed` æœ€ç›´æ¥çš„ä¼˜åŠ¿ã€‚å®ƒå‘ç¼–è¯‘å™¨æä¾›äº†å®Œæ•´çš„ç»§æ‰¿ä¿¡æ¯ï¼Œä½¿å¾— `switch` æ¨¡å¼åŒ¹é…å¯ä»¥è¿›è¡Œè¯¦å°½æ€§æ£€æŸ¥ã€‚å¦‚æœæ‰€æœ‰å…è®¸çš„å­ç±»å‹éƒ½è¢«è¦†ç›–ï¼Œå°±ä¸å†éœ€è¦ `default` åˆ†æ”¯ï¼Œä»è€Œå†™å‡ºæ›´å®‰å…¨ã€æ›´å…·è¡¨ç°åŠ›çš„ä»£ç ã€‚

*   **å­ç±»è§„åˆ™ä¸ä»£ç ç¤ºä¾‹**: `permits` åˆ—è¡¨ä¸­çš„æ¯ä¸ªå­ç±»ï¼Œå¿…é¡»æ˜¯ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€ï¼š
    1.  `final`: ç»§æ‰¿é“¾åˆ°æ­¤ç»ˆæ­¢ã€‚
    2.  `sealed`: ç»§ç»­å¯†å°ï¼Œå¿…é¡»æŒ‡å®šè‡ªå·±çš„ `permits` åˆ—è¡¨ã€‚
    3.  `non-sealed`: æ‰“ç ´å¯†å°ï¼Œå›å½’ä¼ ç»Ÿï¼Œä»»ä½•ç±»éƒ½å¯ä»¥ç»§æ‰¿å®ƒã€‚

    ```java
    // ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ªå¯†å°çš„ Vehicle æ¥å£
    sealed interface Vehicle permits Car, Bicycle {}
    
    final class Car implements Vehicle { /* ... */ }
    
    non-sealed class Bicycle implements Vehicle { /* ... */ }
    
    // MountainBike å¯ä»¥è‡ªç”±ç»§æ‰¿ non-sealed çš„ Bicycle
    class MountainBike extends Bicycle { /* ... */ }
    ```
### 6. æ¨¡å¼åŒ¹é… (Pattern Matching) (Java 16-23)

æ¨¡å¼åŒ¹é…æ˜¯ Java è¿‘å¹´æ¥æœ€é‡è¦çš„ä¸€ç»„è¯­è¨€å¢å¼ºï¼Œå®ƒæ—¨åœ¨ä»¥æ›´å®‰å…¨ã€æ›´ç®€æ´ã€æ›´å…·è¡¨ç°åŠ›çš„æ–¹å¼æ£€æŸ¥å¯¹è±¡çš„â€œæ¨¡å¼â€ï¼ˆå³ç»“æ„æˆ–ç±»å‹ï¼‰ï¼Œå¹¶åœ¨åŒ¹é…æˆåŠŸæ—¶è‡ªåŠ¨æå–å…¶ä¸­çš„æ•°æ®ã€‚

#### 6.1 `instanceof` çš„æ¨¡å¼åŒ¹é… (Java 16)
* **æ¼”è¿›**: Java 16 æ­£å¼å‘å¸ƒã€‚
* **æ ¸å¿ƒç†å¿µ**: æå¤§åœ°ç®€åŒ–äº†â€œæ£€æŸ¥ç±»å‹-å¼ºåˆ¶è½¬æ¢-ä½¿ç”¨â€è¿™ä¸€ç»å…¸ç¹çæµç¨‹ã€‚
* **å®æ“**: åœ¨ `instanceof` æ£€æŸ¥ä¸º `true` æ—¶ï¼Œè‡ªåŠ¨å®Œæˆç±»å‹è½¬æ¢ï¼Œå¹¶å°†ç»“æœèµ‹ç»™ä½ å£°æ˜çš„æ¨¡å¼å˜é‡ã€‚è¯¥å˜é‡çš„ä½œç”¨åŸŸè¢«æ™ºèƒ½åœ°é™åˆ¶åœ¨å®ƒèƒ½è¢«ç¡®å®šèµ‹å€¼çš„åœ°æ–¹ã€‚

```java
// ç¤ºä¾‹ï¼šinstanceof çš„æ¨¡å¼åŒ¹é…
Object obj = "Hello";
if (obj instanceof String s) {
    // æ— éœ€å¼ºè½¬ï¼Œå˜é‡ s ç›´æ¥å¯ç”¨
    System.out.println(s.toUpperCase());
}
```

#### 6.2 `switch` çš„æ¨¡å¼åŒ¹é… (Java 21)
* **æ¼”è¿›**: Java 21 æ­£å¼å‘å¸ƒã€‚
* **æ ¸å¿ƒç†å¿µ**: å°†æ¨¡å¼åŒ¹é…çš„èƒ½åŠ›å…¨é¢å¼•å…¥ `switch`ï¼Œä½¿å…¶èƒ½æ ¹æ®å¯¹è±¡çš„ç±»å‹å’Œç»“æ„è¿›è¡Œåˆ†æ”¯é€‰æ‹©ã€‚
* **å…³é”®èƒ½åŠ›**:
    1. **`case null`**: `switch` å¯ä»¥ç›´æ¥å¤„ç† `null` é€‰æ‹©å™¨ã€‚è‹¥é€‰æ‹©å™¨ä¸º `null` ä¸”æ—  `case null` åˆ†æ”¯ï¼Œä¾ç„¶æŠ›å‡º `NullPointerException`ã€‚
    2. **ç±»å‹æ¨¡å¼ (Type Patterns)**: `case String s -> ...` ä¼šè‡ªåŠ¨æ£€æŸ¥å¯¹è±¡æ˜¯å¦ä¸º `String`ï¼Œè‹¥æ˜¯åˆ™è‡ªåŠ¨è½¬æ¢å¹¶ç»‘å®šåˆ°å˜é‡ `s`ã€‚
    3. **å®ˆæŠ¤æ¨¡å¼ (Guarded Patterns)**: `case Type t when condition -> ...` å…è®¸åœ¨æ¨¡å¼åŒ¹é…æˆåŠŸåï¼Œå¢åŠ ä¸€ä¸ªé¢å¤–çš„å¸ƒå°”æ¡ä»¶åˆ¤æ–­ï¼Œå®ç°æ›´ç²¾ç»†çš„æ§åˆ¶ã€‚

#### 6.3 è®°å½•æ¨¡å¼ (Record Patterns) (Java 21)
* **æ¼”è¿›**: Java 21 æ­£å¼å‘å¸ƒã€‚
* **æ ¸å¿ƒç†å¿µ**: å¯¹è®°å½•æ¨¡å¼çš„æ·±åº¦æ”¯æŒï¼Œå…è®¸åœ¨åŒ¹é… `record` ç±»å‹æ—¶ç›´æ¥â€œè§£æ„â€å®ƒï¼Œæå–å…¶ç»„ä»¶ã€‚
* **å®æ“**: `case Point(int x, int y) -> ...`ï¼Œå½“ `switch` çš„å¯¹è±¡åŒ¹é… `Point` ç±»å‹æ—¶ï¼Œå®ƒçš„ç»„ä»¶ `x` å’Œ `y` ä¼šè¢«è‡ªåŠ¨æå–åˆ°åŒåçš„å±€éƒ¨å˜é‡ä¸­ï¼Œå¯ä»¥ç›´æ¥åœ¨ `->` å³ä¾§ä½¿ç”¨ã€‚

```java
// å®æˆ˜ç¤ºä¾‹ï¼šç»Ÿä¸€å±•ç¤º Switch çš„å¤šç§æ¨¡å¼åŒ¹é…
sealed interface Shape permits Circle, Rectangle {}
record Circle(double radius) implements Shape {}
record Rectangle(double length, double width) implements Shape {}

double getArea(Shape shape) {
    return switch (shape) {
        // 1. null æ¨¡å¼
        case null -> 0;
        // 2. è®°å½•æ¨¡å¼ (è§£æ„)
        case Circle(double r) -> Math.PI * r * r;
        // 3. å®ˆæŠ¤æ¨¡å¼
        case Rectangle(double l, double w) when l == w -> l * w; // æ­£æ–¹å½¢
        // 4. ç±»å‹æ¨¡å¼
        case Rectangle r -> r.length() * r.width(); // æ™®é€šçŸ©å½¢
    };
}
```

#### 6.4 åŸå§‹ç±»å‹æ¨¡å¼ (Primitive Types in Patterns) (Java 23, é¢„è§ˆ)

*   **æ¼”è¿›**: Java 23 ä½œä¸ºé¢„è§ˆç‰¹æ€§å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: å°†æ¨¡å¼åŒ¹é…çš„èƒ½åŠ›æ— ç¼æ‰©å±•åˆ°æ‰€æœ‰ 8 ç§åŸå§‹ç±»å‹ï¼ˆ`boolean`, `byte`, `short`, `int`, `long`, `float`, `double`, `char`ï¼‰ã€‚
*   **è§£å†³çš„ç—›ç‚¹**: åœ¨æ­¤ä¹‹å‰ï¼Œ`switch` æ¨¡å¼åŒ¹é…ä¸»è¦é’ˆå¯¹å¼•ç”¨ç±»å‹ï¼Œå¯¼è‡´å¤„ç†åŸå§‹ç±»å‹æ—¶è¯­æ³•ä¸ç»Ÿä¸€ï¼Œæ— æ³•ä½¿ç”¨ `when` ç­‰é«˜çº§å­å¥ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **è¯­æ³•ç»Ÿä¸€**: `switch` è¯­å¥ç°åœ¨å¯ä»¥ä¸€è‡´åœ°å¤„ç†ä»»ä½•ç±»å‹ï¼ˆåŸå§‹ç±»å‹æˆ–å¼•ç”¨ç±»å‹ï¼‰ï¼Œæˆä¸ºæ›´é€šç”¨çš„æ§åˆ¶æµå·¥å…·ã€‚
    *   **è¡¨ç°åŠ›å¢å¼º**: å…è®¸å¯¹åŸå§‹ç±»å‹ä½¿ç”¨ `when` å®ˆæŠ¤å­å¥ï¼Œå¯ä»¥ç¼–å†™å‡ºæ›´ç²¾ç‚¼ã€æ›´æ¸…æ™°çš„åˆ¤æ–­é€»è¾‘ã€‚

*   **å¯ç”¨æ–¹å¼**: ä½œä¸ºä¸€ä¸ªé¢„è§ˆåŠŸèƒ½ï¼Œä½ å¿…é¡»åœ¨æ„å»ºå·¥å…·ä¸­æ·»åŠ  `--enable-preview` ç¼–è¯‘å’Œè¿è¡Œå‚æ•°ã€‚

*   **ä»£ç å®æˆ˜ï¼šç»Ÿä¸€å¤„ç†ä¸åŒç±»å‹**

    ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä¸€ä¸ª `switch` è¡¨è¾¾å¼æ¥ç»Ÿä¸€å¤„ç†åŒ…å«åŸå§‹ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„ `Object`ï¼Œå¹¶å¯¹ `double` ç±»å‹ä½¿ç”¨äº† `when` å­å¥è¿›è¡Œæ¡ä»¶åˆ†æ”¯ã€‚

    ```java
    // æ¼”ç¤ºä»£ç æ¥è‡ª JavaNewFeatureTest.java
    String checkPrimitiveType(Object obj) {
        return switch (obj) {
            // 1. å¯¹åŸå§‹ç±»å‹ int è¿›è¡Œæ¨¡å¼åŒ¹é…
            case int i -> STR."è¿™æ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹ int: \{i}";
    
            // 2. å¯¹åŸå§‹ç±»å‹ double ä½¿ç”¨ 'when' å­å¥è¿›è¡Œæ¨¡å¼åŒ¹é…
            case double d when d > 100.0 -> STR."è¿™æ˜¯ä¸€ä¸ªå¤§çš„ double å€¼: \{d}";
            case double d -> STR."è¿™æ˜¯ä¸€ä¸ª double å€¼: \{d}";
    
            // 3. å¯¹å¼•ç”¨ç±»å‹è¿›è¡Œæ¨¡å¼åŒ¹é… (ä»¥ç¤ºå¯¹æ¯”)
            case String s -> STR."è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé•¿åº¦ä¸º: \{s.length()}";
    
            // å…¶ä»–ç±»å‹çš„é»˜è®¤æƒ…å†µ
            default -> STR."æ˜¯å…¶ä»–ç±»å‹: \{obj.getClass().getName()}";
        };
    }
    
    @Test
    void primitiveTypePatternsTest() {
        System.out.println(checkPrimitiveType(101));        // -> è¿™æ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹ int: 101
        System.out.println(checkPrimitiveType(250.5));      // -> è¿™æ˜¯ä¸€ä¸ªå¤§çš„ double å€¼: 250.5
        System.out.println(checkPrimitiveType(42.0));       // -> è¿™æ˜¯ä¸€ä¸ª double å€¼: 42.0
        System.out.println(checkPrimitiveType("ä½ å¥½!"));    // -> è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé•¿åº¦ä¸º: 3
    }
    ```

### 7. æœªå‘½åæ¨¡å¼å’Œå˜é‡ (Unnamed Patterns & Variables) (Java 22, æ­£å¼)

*   **æ¼”è¿›**: Java 22 æ­£å¼å‘å¸ƒã€‚
*   **æ ¸å¿ƒç†å¿µ**: å¼•å…¥ä¸‹åˆ’çº¿ `_` ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°ï¼Œç”¨äºè¡¨ç¤ºä½ **åˆ»æ„å¿½ç•¥**çš„æ¨¡å¼å˜é‡æˆ–æ™®é€šå˜é‡ï¼Œä»¥æå‡ä»£ç æ¸…æ™°åº¦å¹¶æ¶ˆé™¤ç¼–è¯‘å™¨è­¦å‘Šã€‚
*   **è§£å†³çš„ç—›ç‚¹**: åœ¨ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›å¿…é¡»å£°æ˜ä½†åˆä»æœªä½¿ç”¨è¿‡çš„å˜é‡ï¼ˆå¦‚ `catch` å—çš„å¼‚å¸¸å˜é‡ã€lambda çš„æœªä½¿ç”¨å‚æ•°ç­‰ï¼‰ï¼Œå®ƒä»¬ä¼šäº§ç”Ÿç¼–è¯‘å™¨è­¦å‘Šï¼Œä¹Ÿè®©ä»£ç æ˜¾å¾—æ‚ä¹±ã€‚

#### æœªå‘½åå˜é‡

å½“ä¸€ä¸ªå˜é‡å¿…é¡»è¢«å£°æ˜ï¼Œä½†å…¶å€¼åœ¨åç»­é€»è¾‘ä¸­æ°¸è¿œä¸ä¼šè¢«ä½¿ç”¨æ—¶ï¼Œå¯ä»¥ç”¨ `_` ä»£æ›¿å…¶åç§°ã€‚

```java
// ç¤ºä¾‹ï¼šåœ¨ for-each å’Œ catch å—ä¸­ä½¿ç”¨
// 1. åœ¨ for-each å¾ªç¯ä¸­å¿½ç•¥å…ƒç´ 
var numbers = java.util.List.of(10, 20, 30);
int count = 0;
for (var _ : numbers) {
    count++;
}

// 2. åœ¨ lambda è¡¨è¾¾å¼ä¸­å¿½ç•¥å‚æ•°
var map = new java.util.HashMap<String, String>();
map.forEach((key, _) -> System.out.println("Key: " + key));

// 3. åœ¨ try-catch ä¸­å¿½ç•¥å¼‚å¸¸å˜é‡
try {
    throw new RuntimeException("ä¸€ä¸ªæˆ‘ä»¬ä¸å…³å¿ƒçš„å¼‚å¸¸");
} catch (RuntimeException _) {
    System.out.println("æˆåŠŸæ•è·å¹¶å¿½ç•¥äº†å¼‚å¸¸ã€‚");
}
```

#### æœªå‘½åæ¨¡å¼

åœ¨æ¨¡å¼åŒ¹é…ï¼ˆ`instanceof` æˆ– `switch`ï¼‰çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå½“ä¸‹åˆ’çº¿ `_` ç”¨äºæ¨¡å¼å˜é‡æ—¶ï¼Œå®ƒè¡¨ç¤ºæˆ‘ä»¬åªå…³å¿ƒç±»å‹æˆ–ç»“æ„çš„åŒ¹é…ï¼Œè€Œä¸å…³å¿ƒåŒ¹é…åˆ°çš„å€¼æœ¬èº«ã€‚

```java
// ç¤ºä¾‹ï¼šåœ¨ switch ä¸­è§£æ„ record æ—¶å¿½ç•¥ç»„ä»¶
record Point(int x, int y) {}
var point = new Point(10, 20);
switch (point) {
    // æˆ‘ä»¬åªå…³å¿ƒ x åæ ‡ï¼Œå¿½ç•¥ y
    case Point(int x, int _) -> System.out.println("x-coordinate: " + x);
}
```

### 8. æœªå‘½åç±»å’Œå®ä¾‹ main æ–¹æ³• (Unnamed Classes and Instance Main Methods) (Java 21, é¢„è§ˆ)

*   **æ¼”è¿›**: Java 21 ä½œä¸ºé¢„è§ˆç‰¹æ€§å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æ—¨åœ¨å¤§å¹…ç®€åŒ– Java çš„å…¥é—¨ä½“éªŒï¼Œè®©åˆå­¦è€…å¯ä»¥ç¼–å†™å‡ºæœ€ç®€å•çš„ç¨‹åºï¼Œè€Œæ— éœ€ç†è§£ `class`, `public`, `static` ç­‰å¤æ‚çš„ä¿®é¥°ç¬¦ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **é™ä½å­¦ä¹ æ›²çº¿**: ä½¿å¾—ç¬¬ä¸€ä¸ª "Hello, World!" ç¨‹åºæå…¶ç®€æ´ï¼Œæ›´æ¥è¿‘è„šæœ¬è¯­è¨€çš„ä½“éªŒã€‚
    *   **å¹³æ»‘è¿‡æ¸¡**: å­¦ç”Ÿå¯ä»¥ä»æœ€ç®€å•çš„ `main` æ–¹æ³•å¼€å§‹ï¼Œéšç€å­¦ä¹ çš„æ·±å…¥ï¼Œå†é€æ­¥ã€è‡ªç„¶åœ°å¼•å…¥ `class`ã€`static` ç­‰æ¦‚å¿µã€‚
*   **å¯ç”¨æ–¹å¼**: ä½œä¸ºä¸€ä¸ªé¢„è§ˆåŠŸèƒ½ï¼Œå¿…é¡»ä½¿ç”¨ `java` å¯åŠ¨å™¨ç›´æ¥è¿è¡Œæºæ–‡ä»¶ï¼Œå¹¶æ·»åŠ  `--enable-preview` å’Œ `--source` å‚æ•°ã€‚
    ```shell
    # å‡è®¾æ–‡ä»¶åä¸º HelloWorld.java
    java --source 21 --enable-preview HelloWorld.java
    ```

*   **ä»£ç å®æˆ˜å¯¹æ¯”**:

    ```java
    // Java 21 ä¹‹å‰ï¼Œç»å…¸çš„ "Hello, World!"
    public class HelloWorld {
        public static void main(String[] args) {
            System.out.println("Hello, World!");
        }
    }
    ```

    ```java
    // ä½¿ç”¨æœªå‘½åç±»å’Œå®ä¾‹ main æ–¹æ³•
    // æ•´ä¸ªæ–‡ä»¶å°±æ˜¯è¿™æ ·ï¼Œæ²¡æœ‰ class å£°æ˜
    void main() {
        System.out.println("Hello, World!");
    }
    ```

*   **å·¥ä½œåŸç†**:
    *   å½“ä½ ä½¿ç”¨ `java` å‘½ä»¤è¿è¡Œè¿™æ ·çš„æºæ–‡ä»¶æ—¶ï¼ŒJava ç¼–è¯‘å™¨åœ¨åå°ä¼šä¸ºä½ è‡ªåŠ¨åˆæˆä¸€ä¸ªæœªå‘½åçš„ç±»ï¼Œå¹¶å°†ä½ çš„ `main` æ–¹æ³•ä½œä¸ºå®ƒçš„ä¸€ä¸ªå®ä¾‹æ–¹æ³•ã€‚ç„¶åï¼ŒJVM ä¼šåˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹å¹¶è°ƒç”¨è¯¥ `main` æ–¹æ³•ã€‚

*   **é™åˆ¶ä¸è§„åˆ™**:
    *   ä¸€ä¸ªæºæ–‡ä»¶æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªæœªå‘½åç±»ã€‚
    *   æœªå‘½åç±»ä¸­çš„æ–¹æ³•ä¸èƒ½æ˜¯ `static` çš„ï¼ˆé™¤äº†å°†æ¥å¯èƒ½çš„é™æ€è¾…åŠ©æ–¹æ³•ï¼‰ã€‚
    *   å®ƒæ˜¯ä¸€ä¸ªé¢„è§ˆç‰¹æ€§ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ä»£ç ä¸­ä½¿ç”¨ã€‚

### 9. `super(...)` ä¹‹å‰çš„è¯­å¥ (Statements before `super(...)`) (Java 22, é¢„è§ˆ)

*   **æ¼”è¿›**: Java 22 ä½œä¸ºé¢„è§ˆç‰¹æ€§å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: é€‚åº¦æ”¾å®½äº† Java è¯­è¨€ä¸­â€œæ„é€ å‡½æ•°çš„ç¬¬ä¸€æ¡è¯­å¥å¿…é¡»æ˜¯ `this(...)` æˆ– `super(...)`â€çš„ä¸¥æ ¼é™åˆ¶ã€‚
*   **è§£å†³çš„ç—›ç‚¹**: åœ¨æ­¤ä¹‹å‰ï¼Œä»»ä½•éœ€è¦åœ¨è°ƒç”¨çˆ¶ç±»æ„é€ å™¨å‰æ‰§è¡Œçš„å‚æ•°æ ¡éªŒæˆ–è½¬æ¢é€»è¾‘ï¼Œéƒ½å¿…é¡»è¢«å°è£…åœ¨ `static` è¾…åŠ©æ–¹æ³•ä¸­ï¼Œå¯¼è‡´ä»£ç ç¹çä¸”å¯è¯»æ€§ä¸‹é™ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **ä»£ç æ›´è‡ªç„¶**: å…è®¸åœ¨è°ƒç”¨ `super(...)` ä¹‹å‰ï¼Œç›´æ¥åœ¨æ„é€ å‡½æ•°ä¸­ç¼–å†™ä¸ä¾èµ–äºå½“å‰å®ä¾‹ (`this`) çš„å‡†å¤‡ä»£ç ï¼Œå¦‚å‚æ•°æ ¡éªŒã€ä¸­é—´å˜é‡è®¡ç®—ã€æ—¥å¿—è®°å½•ç­‰ã€‚
    *   **æ¶ˆé™¤æ ·æ¿ä»£ç **: ä¸å†éœ€è¦ä¸ºäº†ç®€å•çš„é¢„å¤„ç†é€»è¾‘è€Œåˆ›å»ºä¸å¿…è¦çš„ `static` è¾…åŠ©æ–¹æ³•ï¼Œä½¿æ„é€ å‡½æ•°é€»è¾‘æ›´å†…èšã€æ›´æ¸…æ™°ã€‚
*   **å®‰å…¨é™åˆ¶**: ç¼–è¯‘å™¨ä¼šä¸¥æ ¼ç¡®ä¿åœ¨ `super(...)` è°ƒç”¨ä¹‹å‰çš„ä»£ç **ä¸èƒ½è®¿é—® `this`**ï¼Œå³ä¸èƒ½å¼•ç”¨å½“å‰æ­£åœ¨åˆ›å»ºçš„å®ä¾‹çš„ä»»ä½•å­—æ®µã€æ–¹æ³•æˆ–å†…éƒ¨ç±»ã€‚è¿™ä¿è¯äº†å¯¹è±¡åœ¨è‡ªèº«çŠ¶æ€å¯ç”¨ä¹‹å‰ï¼Œå…¶çˆ¶ç±»çŠ¶æ€æ€»æ˜¯å…ˆè¢«å®Œå…¨åˆå§‹åŒ–ã€‚

*   **å¯ç”¨æ–¹å¼**: ä½œä¸ºä¸€ä¸ªé¢„è§ˆåŠŸèƒ½ï¼Œä½ å¿…é¡»åœ¨æ„å»ºå·¥å…·ä¸­æ·»åŠ  `--enable-preview` ç¼–è¯‘å’Œè¿è¡Œå‚æ•°ã€‚

*   **ä»£ç å®æˆ˜ï¼šåœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œé¢„å¤„ç†**

    ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†å¦‚ä½•åœ¨å­ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œå…ˆå¯¹å‚æ•°è¿›è¡Œæ ¡éªŒå’Œè®¡ç®—ï¼Œç„¶åå†å°†è®¡ç®—ç»“æœä¼ é€’ç»™çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚

    ```java
    // æ¼”ç¤ºä»£ç æ¥è‡ª JavaNewFeatureTest.java
    class ParentWithInfo {
        private final String info;
        ParentWithInfo(String info) {
            System.out.println(STR."çˆ¶ç±»æ„é€ å™¨è¢«è°ƒç”¨ï¼Œä¼ å…¥ä¿¡æ¯: '\{info}'");
            this.info = info;
        }
        String getInfo() { return info; }
    }
    
    class ChildWithPreSuperLogic extends ParentWithInfo {
        ChildWithPreSuperLogic(String part1, int part2) {
            // 1. åœ¨ super() è°ƒç”¨å‰æ‰§è¡Œé€»è¾‘
            System.out.println("å­ç±»æ„é€ å™¨å¼€å§‹æ‰§è¡Œ...");
            String validatedPart1 = java.util.Objects.requireNonNull(part1, "Part1 cannot be null");
            String combinedInfo = STR."\{validatedPart1}-\{part2 * 2}";
            System.out.println(STR."åœ¨ super() ä¹‹å‰å®Œæˆè®¡ç®—ï¼Œå‡†å¤‡ä¼ å…¥: '\{combinedInfo}'");
    
            // 2. è°ƒç”¨ super()ï¼Œä¸å†éœ€è¦æ˜¯ç¬¬ä¸€è¡Œ
            super(combinedInfo);
    
            // 3. super() ä¹‹åçš„é€»è¾‘
            System.out.println("å­ç±»æ„é€ å™¨å®Œæˆã€‚");
        }
    }
    
    @Test
    void statementsBeforeSuperTest() {
        var child = new ChildWithPreSuperLogic("data", 21);
        // è¾“å‡ºå±•ç¤ºäº†æ¸…æ™°çš„æ‰§è¡Œé¡ºåº
    }
    ```

---

[**ğŸ”™ è¿”å›ç›®å½•**](#ğŸ“‹-è¯¦ç»†ç›®å½•)

---

## äºŒã€ å¹¶å‘ä¸æ€§èƒ½

### 10. è™šæ‹Ÿçº¿ç¨‹ (Virtual Threads) (Java 21, æ­£å¼)

*   **æ¼”è¿›**: Java 21 æ­£å¼å‘å¸ƒï¼ŒProject Loom çš„æ ¸å¿ƒæˆæœã€‚
*   **æ ¸å¿ƒä»·å€¼**: å…è®¸å¼€å‘è€…ç»§ç»­ä½¿ç”¨ç®€å•ã€ç›´è§‚ã€æ˜“äºè°ƒè¯•çš„**åŒæ­¥é˜»å¡å¼ä»£ç é£æ ¼**ï¼Œæ¥ç¼–å†™å…·æœ‰æé«˜å¹¶å‘ååé‡çš„ I/O å¯†é›†å‹åº”ç”¨ï¼Œè€Œæ— éœ€è¢«è¿«è½¬å‘å¤æ‚ä¸”æ˜“é”™çš„å›è°ƒå¼æˆ–å“åº”å¼ç¼–ç¨‹æ¨¡å‹ã€‚

#### å®ç°åŸç†ä¸æ ¸å¿ƒç†å¿µ

è™šæ‹Ÿçº¿ç¨‹æ˜¯ç”± JVM è°ƒåº¦å’Œç®¡ç†çš„ã€æå…¶è½»é‡çº§çš„ç”¨æˆ·æ€çº¿ç¨‹ã€‚å…¶æ ¸å¿ƒåœ¨äºï¼Œå½“è™šæ‹Ÿçº¿ç¨‹é‡åˆ°å—æ”¯æŒçš„é˜»å¡æ“ä½œï¼ˆå¦‚ç½‘ç»œ I/Oï¼‰æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨**â€œè®©å‡ºâ€ (unmount/yield)** å…¶åº•å±‚çš„å¹³å°çº¿ç¨‹ï¼ˆOS çº¿ç¨‹ï¼‰ï¼Œè€Œä¸ä¼šåƒä¼ ç»Ÿçº¿ç¨‹é‚£æ ·é˜»å¡å®ƒã€‚

*   **M:N è°ƒåº¦**: å¤§é‡ï¼ˆMï¼‰çš„è™šæ‹Ÿçº¿ç¨‹ï¼Œè¿è¡Œåœ¨å°‘é‡ï¼ˆNï¼‰çš„å¹³å°çº¿ç¨‹ä¸Šã€‚é»˜è®¤çš„è°ƒåº¦å™¨æ˜¯ `ForkJoinPool`ã€‚
*   **Continuation**: è¿™æ˜¯å®ç°è™šæ‹Ÿçº¿ç¨‹é­”æ³•çš„åº•å±‚æœºåˆ¶ã€‚æ¯ä¸ªè™šæ‹Ÿçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå…³è”çš„ `Continuation` å¯¹è±¡ï¼Œç”¨äºä¿å­˜å…¶å½“å‰çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆè°ƒç”¨æ ˆç­‰ï¼‰ã€‚å½“è™šæ‹Ÿçº¿ç¨‹è®©å‡ºæ—¶ï¼Œå®ƒçš„çŠ¶æ€è¢«ä¿å­˜åœ¨ `Continuation` ä¸­ï¼›å½“å®ƒå¯ä»¥ç»§ç»­æ‰§è¡Œæ—¶ï¼ŒJVM ä¼šæ¢å¤è¯¥ `Continuation`ï¼Œè®©å®ƒåœ¨æŸä¸ªå¯ç”¨çš„å¹³å°çº¿ç¨‹ä¸Šç»§ç»­è¿è¡Œã€‚

#### åˆ›å»ºä¸ä½¿ç”¨æ–¹å¼

æœ‰å¤šç§æ–¹å¼å¯ä»¥åˆ›å»ºå’Œå¯åŠ¨è™šæ‹Ÿçº¿ç¨‹ï¼Œä½†å®˜æ–¹å¼ºçƒˆæ¨èä½¿ç”¨ `ExecutorService`ã€‚

```java
// æ–¹å¼ä¸€ï¼šç›´æ¥å¯åŠ¨ (é€‚åˆç®€å•ã€ä¸€æ¬¡æ€§çš„ä»»åŠ¡)
Thread.startVirtualThread(() -> {
    System.out.println("Hello from a virtual thread!");
});

// æ–¹å¼äºŒï¼šä½¿ç”¨ Thread.Builder (éœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¦‚å‘½å)
Thread virtualThread = Thread.ofVirtual().name("MyVirtualThread").unstarted(() -> {
    // ...
});
virtualThread.start();

// æ–¹å¼ä¸‰ï¼šæœ€ä½³å®è·µ - ä½¿ç”¨ ExecutorService
// è¿™æ˜¯ç®¡ç†å¤§é‡ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸçš„é¦–é€‰æ–¹å¼
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    for (int i = 0; i < 10_000; i++) {
        executor.submit(() -> {
            // æ¨¡æ‹Ÿæ‰§è¡Œä¸€ä¸ªè€—æ—¶1ç§’çš„ç½‘ç»œè¯·æ±‚
            Thread.sleep(Duration.ofSeconds(1));
            return "Task Complete";
        });
    }
} // try-with-resources ä¼šè‡ªåŠ¨å…³é—­ executor
```

#### æ ¸å¿ƒé€‚ç”¨åœºæ™¯

è™šæ‹Ÿçº¿ç¨‹çš„â€œè¶…èƒ½åŠ›â€ä¸“é—¨ç”¨äºè§£å†³ç‰¹å®šé—®é¢˜ï¼Œå¹¶éä¸‡èƒ½çµè¯ã€‚

*   **éå¸¸é€‚åˆ**: **I/O å¯†é›†å‹ä»»åŠ¡**ã€‚
    *   **åœºæ™¯**: å¤§é‡å¹¶å‘çš„ç½‘ç»œè¯·æ±‚ï¼ˆå¾®æœåŠ¡è°ƒç”¨ã€æ•°æ®åº“è¿æ¥ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…ï¼‰ã€è®¿é—®æ…¢é€Ÿå¤–éƒ¨ç³»ç»Ÿç­‰ã€‚
    *   **åŸå› **: åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œçº¿ç¨‹ç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…æ•°æ®è¿”å›ï¼Œè€Œä¸æ˜¯åœ¨åšè®¡ç®—ã€‚è™šæ‹Ÿçº¿ç¨‹å¯ä»¥å°†è¿™äº›â€œç­‰å¾…æ—¶é—´â€é«˜æ•ˆåˆ©ç”¨èµ·æ¥ï¼Œè®©å¹³å°çº¿ç¨‹å»æœåŠ¡å…¶ä»–å°±ç»ªçš„ä»»åŠ¡ã€‚

*   **ä¸é€‚åˆ**: **CPU å¯†é›†å‹ä»»åŠ¡**ã€‚
    *   **åœºæ™¯**: å¤æ‚çš„æ•°å­¦è®¡ç®—ã€è§†é¢‘ç¼–ç ã€å¤§æ•°æ®å¤„ç†ç­‰éœ€è¦æŒç»­å ç”¨ CPU çš„ä»»åŠ¡ã€‚
    *   **åŸå› **: è™šæ‹Ÿçº¿ç¨‹å¹¶ä¸ä¼šå¸¦æ¥é¢å¤–çš„è®¡ç®—èƒ½åŠ›ã€‚å¯¹äº CPU å¯†é›†å‹ä»»åŠ¡ï¼Œæœ€ä½³çš„çº¿ç¨‹æ•°é€šå¸¸ç­‰äºæˆ–æ¥è¿‘ CPU æ ¸å¿ƒæ•°ã€‚ä½¿ç”¨è¶…è¿‡æ ¸å¿ƒæ•°çš„è™šæ‹Ÿçº¿ç¨‹ï¼ˆæˆ–å¹³å°çº¿ç¨‹ï¼‰ä¸ä»…æ²¡æœ‰å¥½å¤„ï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢è€Œé™ä½æ€§èƒ½ã€‚å¯¹äºæ­¤ç±»ä»»åŠ¡ï¼Œåº”ç»§ç»­ä½¿ç”¨ä¼ ç»Ÿçš„å¹³å°çº¿ç¨‹æ± ã€‚

#### å®æˆ˜ç¤ºä¾‹ï¼šé«˜å¹¶å‘ I/O æ¨¡æ‹Ÿ

ä¸‹é¢çš„ä»£ç ç›´è§‚åœ°å±•ç¤ºäº†è™šæ‹Ÿçº¿ç¨‹çš„å¨åŠ›ã€‚å®ƒå¯åŠ¨äº† 10,000 ä¸ªå¹¶å‘ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡æ¨¡æ‹Ÿä¸€æ¬¡è€—æ—¶ 1 ç§’çš„ I/O æ“ä½œã€‚å¦‚æœä½¿ç”¨å¹³å°çº¿ç¨‹ï¼Œè¿™ä¼šç«‹åˆ»è€—å°½ç³»ç»Ÿèµ„æºï¼›è€Œä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ï¼Œåˆ™å¯ä»¥è½»æ¾åº”å¯¹ã€‚

```java
@Test
void highConcurrencyIoSimulationTest() throws InterruptedException {
    // ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œå™¨
    try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
        // å¯åŠ¨ 10,000 ä¸ªå¹¶å‘ä»»åŠ¡
        for (int i = 0; i < 10_000; i++) {
            final int taskNumber = i;
            executor.submit(() -> {
                System.out.println("å¼€å§‹æ‰§è¡Œä»»åŠ¡: " + taskNumber + " on thread: " + Thread.currentThread());
                try {
                    // æ¨¡æ‹Ÿè€—æ—¶ 1 ç§’çš„ I/O æ“ä½œ
                    Thread.sleep(Duration.ofSeconds(1));
                } catch (InterruptedException e) {
                    // ...
                }
                System.out.println("ä»»åŠ¡å®Œæˆ: " + taskNumber);
            });
        }
    }
    // æ‰§è¡Œå™¨å…³é—­åï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å·²æäº¤
    // åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½éœ€è¦ç­‰å¾…ä»»åŠ¡å®Œæˆ
}
```
> **è§‚å¯Ÿè¾“å‡º**: ä½ ä¼šå‘ç°ï¼Œå°½ç®¡æœ‰ä¸Šä¸‡ä¸ªä»»åŠ¡åœ¨â€œåŒæ—¶â€è¿è¡Œï¼Œä½†åº•å±‚çš„å¹³å°çº¿ç¨‹ï¼ˆè¾“å‡ºä¸­çš„ `ForkJoinPool-1-worker-X`ï¼‰æ•°é‡éå¸¸å°‘ã€‚è¿™è¯æ˜äº†è™šæ‹Ÿçº¿ç¨‹åœ¨ç­‰å¾… I/O æ—¶è®©å‡ºäº†å¹³å°çº¿ç¨‹ã€‚

#### æ·±å…¥è¾¨æ 1ï¼šé˜»å¡æ“ä½œçš„åˆ†ç±»ä¸åæœ

åœ¨è™šæ‹Ÿçº¿ç¨‹çš„ä¸–ç•Œé‡Œï¼Œâ€œé˜»å¡â€ä¸å†æ˜¯ä¸€ä¸ªå•ä¸€æ¦‚å¿µï¼Œå¿…é¡»å°†å…¶ç»†åˆ†ä¸ºä¸‰ç±»ï¼š
| ç­‰å¾…ç±»å‹                  | ä¾‹å­                                                        | å¤„ç†æœºåˆ¶                 | å¯¹å¹³å°çº¿ç¨‹çš„å½±å“          | ç»“è®º                                 |
|:----------------------|:----------------------------------------------------------|:---------------------|:------------------|:-----------------------------------:|
| **I/O æˆ– JUC é˜»å¡**      | `Socket.read()`, `lock.lock()`, `queue.take()`, `sleep()` | è™šæ‹Ÿçº¿ç¨‹è¢«**æŒ‚èµ·/å¸è½½**       | **æ— å½±å“** (å¹³å°çº¿ç¨‹è¢«é‡Šæ”¾) | **The Good Guys** - è¿™æ˜¯è™šæ‹Ÿçº¿ç¨‹çš„ç†æƒ³å·¥ä½œåœºæ™¯ã€‚ |
| **`synchronized` é˜»å¡** | `synchronized` { `sleep()` }                              | è™šæ‹Ÿçº¿ç¨‹è¢«**é’‰ä½ (Pinned)** | **é˜»å¡** (å¹³å°çº¿ç¨‹è¢«æµªè´¹)  | **The Bad Guys** - è™šæ‹Ÿçº¿ç¨‹ä¼˜åŠ¿å°½å¤±ï¼Œæ€§èƒ½é€€åŒ–ã€‚  |
| **æœ¬åœ°æ–¹æ³•é˜»å¡**            | è°ƒç”¨ JNI é˜»å¡æ–¹æ³•                                               | è™šæ‹Ÿçº¿ç¨‹è¢«**é’‰ä½ (Pinned)** | **é˜»å¡** (å¹³å°çº¿ç¨‹è¢«æµªè´¹)  | **The Bad Guys** - å¿…é¡»è­¦æƒ•ã€‚           |

#### æ·±å…¥è¾¨æ 2ï¼šçº¿ç¨‹â€œé’‰ä½â€çš„å®Œç¾æ¼”ç¤º

```java
// å…³é”®æ¼”ç¤ºä»£ç 
@Test
void pinningDemonstrationTest() {
    // åœºæ™¯ä¸€ï¼šReentrantLock - ä¸é’‰ä½ï¼Œé«˜å¹¶å‘
    // 100,000 ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡ sleep(200)ï¼Œæ€»è€—æ—¶æçŸ­ï¼ˆå¦‚ 955msï¼‰ã€‚
    // sleep() è®©å‡ºå¹³å°çº¿ç¨‹ï¼Œæ‰€æœ‰ä»»åŠ¡è¿‘ä¼¼å¹¶å‘æ‰§è¡Œã€‚
    try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
        for (int i = 0; i < 100_000; i++) {
            var lock = new ReentrantLock(); // å…³é”®ï¼šæ— å…±äº«é”
            executor.submit(() -> {
                lock.lock();
                try {
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                } finally {
                    lock.unlock();
                }
            });
        }
    }

    // åœºæ™¯äºŒï¼šsynchronized - é’‰ä½ï¼Œæ€§èƒ½ç¾éš¾
    // 1,000 ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡ sleep(200)ï¼Œæ€»è€—æ—¶æé•¿ï¼ˆå¦‚ 14666msï¼‰ã€‚
    // synchronized é’‰ä½äº†è™šæ‹Ÿçº¿ç¨‹ï¼Œsleep() çœŸå®é˜»å¡äº†å¹³å°çº¿ç¨‹ã€‚
    // å¹³å°çº¿ç¨‹æ± è¢«è¿…é€Ÿè€—å°½ï¼Œä»»åŠ¡åªèƒ½åˆ†æ‰¹ä¸²è¡Œæ‰§è¡Œã€‚
    try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
        for (int i = 0; i < 1000; i++) {
            var monitor = new Object(); // å…³é”®ï¼šæ— å…±äº«ç›‘è§†å™¨
            executor.submit(() -> {
                synchronized (monitor) {
                    try {
                        Thread.sleep(200);
                    } catch (InterruptedException e) {
                    }
                }
            });
        }
    }
}
```

#### æ·±å…¥è¾¨æ 3ï¼šç¬¬ä¸‰æ–¹åº“ä¸æ–‡ä»¶ I/O çš„å…¼å®¹æ€§

*   **ç¬¬ä¸‰æ–¹åº“**: ç»å¤§å¤šæ•°ä¾èµ– JDK æ ‡å‡†**ç½‘ç»œ API**çš„åº“ï¼ˆJDBC, HTTP å®¢æˆ·ç«¯ç­‰ï¼‰éƒ½èƒ½**è‡ªåŠ¨å—ç›Š**äºè™šæ‹Ÿçº¿ç¨‹ã€‚éœ€è­¦æƒ•åœ¨å…³é”®è·¯å¾„ä½¿ç”¨ `synchronized` çš„è€æ—§åº“ã€‚
*   **æ–‡ä»¶ I/O çš„é‡è¦ä¾‹å¤–**:
    *   æ ‡å‡†çš„ `java.io.File*` å’Œ `java.nio.file.Files` API åœ¨æ‰§è¡Œæ–‡ä»¶æ“ä½œæ—¶ï¼Œ**ä¼šé˜»å¡å¹³å°çº¿ç¨‹**ï¼è¿™æ˜¯å½“å‰æ“ä½œç³»ç»Ÿå±‚é¢çš„é™åˆ¶ã€‚
    *   **æœ€ä½³å®è·µ**: åœ¨éœ€è¦é«˜å¹¶å‘æ–‡ä»¶ I/O çš„åœºæ™¯ï¼Œ**å¿…é¡»ä½¿ç”¨ `java.nio.channels.AsynchronousFileChannel`**ï¼Œå¹¶ç»“åˆ `Future.get()` æ¥ç­‰å¾…ç»“æœã€‚è¿™æ˜¯ç›®å‰å”¯ä¸€ä¸è™šæ‹Ÿçº¿ç¨‹å®Œç¾é…åˆçš„æ ‡å‡†æ–‡ä»¶ I/O æ–¹å¼ã€‚

#### æ·±å…¥è¾¨æ 4ï¼šä¸ Go åç¨‹çš„å¯¹æ¯”

| å¯¹æ¯”ç»´åº¦     | Go åç¨‹ (Goroutine)                  | Java è™šæ‹Ÿçº¿ç¨‹ (Virtual Thread)  |
|:---------|:-----------------------------------|:----------------------------|
| **è°ƒåº¦æ¨¡å‹** | **æŠ¢å å¼** (è¿è¡Œæ—¶å¯å¼ºåˆ¶åˆ‡æ¢é•¿æ—¶é—´è¿è¡Œçš„ Goroutine) | **åä½œå¼** (åªåœ¨æ˜ç¡®çš„â€œè®©å‡ºç‚¹â€åˆ‡æ¢)      |
| **åˆ›å»ºæ–¹å¼** | è¯­è¨€çº§ `go` å…³é”®å­—                       | åº“çº§ `Thread`/`Executors` API |
| **é€šä¿¡èŒƒå¼** | æ¨å´‡ **Channels** (é€šè¿‡é€šä¿¡å…±äº«å†…å­˜)         | æ¨å´‡ **å…±äº«å†…å­˜ä¸é”**               |
| **è®¾è®¡å“²å­¦** | **å¹¶å‘åŸç”Ÿ**ï¼Œè‡ªä¸Šè€Œä¸‹ï¼Œä¸ºå¹¶å‘è€Œç”Ÿã€‚               | **å…¼å®¹ç”Ÿæ€**ï¼Œè‡ªä¸‹è€Œä¸Šï¼Œä¸ºèµ‹èƒ½ç°æœ‰ç”Ÿæ€è€Œç”Ÿã€‚    |

### 11. ç»“æ„åŒ–å¹¶å‘ (Structured Concurrency) (Java 22, é¢„è§ˆ)

*   **æ¼”è¿›**: Java 19 å¼•å…¥é¢„è§ˆï¼Œåœ¨ Java 22 ä¸­ç»§ç»­é¢„è§ˆï¼Œè‡³ Java 24 ä»ä¸ºé¢„è§ˆç‰¹æ€§ã€‚
*   **æ ¸å¿ƒç†å¿µ**: å°†ä¸åŒçº¿ç¨‹ä¸­è¿è¡Œçš„ç›¸å…³ä»»åŠ¡ç»„è§†ä¸ºä¸€ä¸ªå•ä¸€çš„ã€åŸå­æ€§çš„å·¥ä½œå•å…ƒã€‚å¦‚æœä¸€ç»„ä»»åŠ¡æ˜¯ä¸ºäº†åŒä¸€ä¸ªä¸šåŠ¡ç›®æ ‡è€ŒååŒå·¥ä½œçš„ï¼Œé‚£ä¹ˆå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå°±åº”è¯¥è¢«ç»‘å®šåœ¨ä¸€èµ·ã€‚
*   **è§£å†³çš„ç—›ç‚¹**:
    *   **çº¿ç¨‹æ³„æ¼**: åœ¨ä¼ ç»Ÿå¹¶å‘æ¨¡å‹ä¸­ï¼Œå¦‚æœå¯åŠ¨ä»»åŠ¡çš„çº¿ç¨‹æå‰é€€å‡ºï¼Œå·²æäº¤çš„å­ä»»åŠ¡ä¼šç»§ç»­è¿è¡Œï¼Œé€ æˆèµ„æºæµªè´¹ã€‚
    *   **é”™è¯¯å¤„ç†å¤æ‚**: å½“ä¸€ä¸ªå­ä»»åŠ¡å¤±è´¥æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–å†™å¤æ‚çš„é€»è¾‘å»å–æ¶ˆå…¶ä»–æ‰€æœ‰ç›¸å…³çš„å­ä»»åŠ¡ã€‚
    *   **ä»»åŠ¡å–æ¶ˆå›°éš¾**: ä¼ æ’­å–æ¶ˆä¿¡å·éå¸¸ç¹çï¼Œå®¹æ˜“å‡ºé”™ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **å¯é æ€§**: é€šè¿‡ `StructuredTaskScope` APIï¼Œå°†å¹¶å‘ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸä¸ä¸€ä¸ªæ¸…æ™°çš„è¯æ³•ä½œç”¨åŸŸï¼ˆ`try-with-resources` å—ï¼‰ç»‘å®šã€‚å½“ä»£ç æµç¦»å¼€è¯¥ä½œç”¨åŸŸæ—¶ï¼Œæ‰€æœ‰å­ä»»åŠ¡éƒ½ä¼šè¢«è‡ªåŠ¨ç»ˆç»“ï¼Œä»æ ¹æœ¬ä¸Šæœç»äº†çº¿ç¨‹æ³„æ¼ã€‚
    *   **å¯è§‚æµ‹æ€§**: ä»£ç çš„ç»“æ„ï¼ˆçˆ¶ä»»åŠ¡ä¸å­ä»»åŠ¡ï¼‰ä¸è¿è¡Œæ—¶çš„çº¿ç¨‹ç»“æ„ç›¸åŒ¹é…ï¼Œä½¿å¾—é€šè¿‡çº¿ç¨‹è½¬å‚¨ï¼ˆThread Dumpï¼‰æ¥è¯Šæ–­å¹¶å‘é—®é¢˜å˜å¾—æå…¶å®¹æ˜“ã€‚
    *   **ç®€åŒ–çš„é”™è¯¯å¤„ç†**: æä¾›äº†å¼€ç®±å³ç”¨çš„ç­–ç•¥ï¼Œå¦‚ `ShutdownOnFailure`ï¼Œåªè¦æœ‰ä¸€ä¸ªå­ä»»åŠ¡å¤±è´¥ï¼Œæ•´ä¸ªä½œç”¨åŸŸå°±ä¼šç«‹å³å…³é—­ï¼Œå¹¶è‡ªåŠ¨å–æ¶ˆæ‰€æœ‰å…¶ä»–æ­£åœ¨è¿è¡Œçš„å…„å¼Ÿä»»åŠ¡ã€‚

*   **ä»£ç å®æˆ˜ï¼šå¹¶å‘è·å–ç”¨æˆ·ä¿¡æ¯å’Œè®¢å•**

    ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†ä¸€ä¸ªç»å…¸åœºæ™¯ï¼šä¸ºäº†å“åº”ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦åŒæ—¶å»è·å–ç”¨æˆ·ä¿¡æ¯å’Œè®¢å•ä¿¡æ¯ï¼Œç„¶åå°†å®ƒä»¬ç»„åˆèµ·æ¥ã€‚`StructuredTaskScope` ç¡®ä¿äº†è¿™ä¸¤ä¸ªæ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆåœ¨ä»»ä½•ä¸€ä¸ªå¤±è´¥æ—¶å¦ä¸€ä¸ªä¼šè¢«ç«‹å³å–æ¶ˆã€‚

    ```java
    // æ¼”ç¤ºä»£ç æ¥è‡ª JavaNewFeatureTest.java
    @Test
    void structuredConcurrency_Success_Test() throws Exception {
        // ä½¿ç”¨ ShutdownOnFailure ç­–ç•¥ï¼Œä»»ä½•ä¸€ä¸ªå­ä»»åŠ¡å¤±è´¥ï¼Œæ•´ä¸ªä½œç”¨åŸŸéƒ½ä¼šå…³é—­
        try (var scope = new StructuredTaskScope.ShutdownOnFailure()) {
            // 1. fork: æäº¤ä¸€ä¸ªä»»åŠ¡å»è·å–ç”¨æˆ·ï¼Œè¿”å›ä¸€ä¸ª Subtask (ç±»ä¼¼ Future)
            Subtask<String> userSubtask = scope.fork(() -> {
                System.out.println("å¼€å§‹è·å–ç”¨æˆ·...");
                Thread.sleep(Duration.ofSeconds(1));
                System.out.println("è·å–ç”¨æˆ·æˆåŠŸ");
                return "å§œå“¥";
            });
    
            // 2. fork: åŒæ—¶æäº¤å¦ä¸€ä¸ªä»»åŠ¡å»è·å–è®¢å•
            Subtask<String> orderSubtask = scope.fork(() -> {
                System.out.println("å¼€å§‹è·å–è®¢å•...");
                Thread.sleep(Duration.ofSeconds(2));
                System.out.println("è·å–è®¢å•æˆåŠŸ");
                return "è®¢å•-88888";
            });
    
            // 3. join: ç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡å®Œæˆï¼Œæˆ–è€…ç­‰å¾… ShutdownOnFailure ç­–ç•¥è¢«è§¦å‘
            scope.join();
    
            // 4. throwIfFailed: å¦‚æœä»»ä½•å­ä»»åŠ¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œjoin()ä¼šæ•è·å®ƒï¼Œ
            //    ç„¶ååœ¨è¿™é‡Œç»Ÿä¸€æŠ›å‡ºï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨ä¸€ä¸ªåœ°æ–¹å¤„ç†æ‰€æœ‰å¹¶å‘é”™è¯¯ã€‚
            scope.throwIfFailed();
    
            // 5. ç»„åˆç»“æœ: å¦‚æœä»£ç èƒ½èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ‰€æœ‰å­ä»»åŠ¡éƒ½æˆåŠŸäº†
            String result = STR."\{userSubtask.get()} çš„ \{orderSubtask.get()}";
            System.out.println(STR."æœ€ç»ˆç»“æœ: \{result}");
        }
    }
    ```

### 12. ä½œç”¨åŸŸå€¼ (Scoped Values) (Java 22, é¢„è§ˆ)

*   **æ¼”è¿›**: Java 20 å¼•å…¥é¢„è§ˆï¼Œåœ¨ Java 22 ä¸­ç»§ç»­é¢„è§ˆï¼Œè‡³ Java 24 ä»ä¸ºé¢„è§ˆç‰¹æ€§ï¼Œæ˜¯ Project Loom å¹¶å‘æ”¹è¿›è®¡åˆ’çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›ä¸€ç§åœ¨è°ƒç”¨æ ˆä¸­å®‰å…¨ã€é«˜æ•ˆåœ°å…±äº«ä¸å¯å˜æ•°æ®çš„æœºåˆ¶ï¼Œæ˜¯å¯¹ `ThreadLocal` çš„ç°ä»£åŒ–æ›¿ä»£ï¼Œä¸“é—¨ä¸ºè™šæ‹Ÿçº¿ç¨‹å’Œç»“æ„åŒ–å¹¶å‘è€Œè®¾è®¡ã€‚

#### è§£å†³ ThreadLocal çš„å…³é”®é—®é¢˜

**1. è™šæ‹Ÿçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ€§èƒ½é—®é¢˜**
```java
// ThreadLocal åœ¨å¤§é‡è™šæ‹Ÿçº¿ç¨‹ä¸‹çš„é—®é¢˜
ThreadLocal<String> userId = new ThreadLocal<>();

// åˆ›å»ºç™¾ä¸‡è™šæ‹Ÿçº¿ç¨‹æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ ThreadLocal å‰¯æœ¬
// å†…å­˜å¼€é”€å·¨å¤§ï¼Œåƒåœ¾å›æ”¶å‹åŠ›å¾ˆå¤§
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    for (int i = 0; i < 1_000_000; i++) {
        executor.submit(() -> {
            userId.set("user-" + Thread.currentThread().getId());
            // ä¸šåŠ¡é€»è¾‘...
            userId.remove();  // å®¹æ˜“å¿˜è®°æ¸…ç†ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
        });
    }
}
```

**2. å†…å­˜æ³„æ¼é£é™©**
```java
// å¸¸è§çš„ ThreadLocal å†…å­˜æ³„æ¼åœºæ™¯
public class UserService {
    private static final ThreadLocal<User> CURRENT_USER = new ThreadLocal<>();
    
    public void processRequest(User user) {
        CURRENT_USER.set(user);
        // å¤„ç†ä¸šåŠ¡é€»è¾‘...
        // å¿˜è®°è°ƒç”¨ CURRENT_USER.remove(); â†’ å†…å­˜æ³„æ¼ï¼
    }
}
```

#### ScopedValue çš„è§£å†³æ–¹æ¡ˆ

**1. åŸºæœ¬è¯­æ³•ä¸ç”¨æ³•**
```java
// å£°æ˜ä½œç”¨åŸŸå€¼
private static final ScopedValue<String> USER_ID = ScopedValue.newInstance();

// ä½¿ç”¨ä½œç”¨åŸŸå€¼
public void handleRequest(String userId) {
    // åœ¨ç‰¹å®šä½œç”¨åŸŸå†…ç»‘å®šå€¼
    ScopedValue.where(USER_ID, userId)
              .run(() -> {
                  // åœ¨è¿™ä¸ªä½œç”¨åŸŸå†…ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥è®¿é—® USER_ID
                  processBusinessLogic();
              });
    // ä½œç”¨åŸŸç»“æŸåï¼Œå€¼è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†
}

private void processBusinessLogic() {
    String currentUserId = USER_ID.get();  // å®‰å…¨è®¿é—®
    System.out.println("å½“å‰ç”¨æˆ·ID: " + currentUserId);
    callDeepMethod();  // è°ƒç”¨æ ˆçš„ä»»ä½•æ·±åº¦éƒ½å¯ä»¥è®¿é—®
}
```

**2. å¤šä¸ªä½œç”¨åŸŸå€¼çš„ç»„åˆ**
```java
private static final ScopedValue<String> USER_ID = ScopedValue.newInstance();
private static final ScopedValue<String> REQUEST_ID = ScopedValue.newInstance();
private static final ScopedValue<String> TENANT_ID = ScopedValue.newInstance();

public void handleRequest(String userId, String requestId, String tenantId) {
    ScopedValue.where(USER_ID, userId)
              .where(REQUEST_ID, requestId)
              .where(TENANT_ID, tenantId)
              .run(() -> {
                  // æ‰€æœ‰ä¸‰ä¸ªå€¼éƒ½åœ¨ä½œç”¨åŸŸå†…å¯ç”¨
                  processRequest();
              });
}
```

**3. åµŒå¥—ä½œç”¨åŸŸçš„è¡Œä¸º**
```java
public void demonstrateNesting() {
    ScopedValue.where(USER_ID, "outer-user")
              .run(() -> {
                  System.out.println("å¤–å±‚: " + USER_ID.get()); // "outer-user"
                  
                  ScopedValue.where(USER_ID, "inner-user")
                            .run(() -> {
                                System.out.println("å†…å±‚: " + USER_ID.get()); // "inner-user"
                            });
                  
                  System.out.println("å›åˆ°å¤–å±‚: " + USER_ID.get()); // "outer-user"
              });
}
```

#### ä¸è™šæ‹Ÿçº¿ç¨‹çš„å®Œç¾ç»“åˆ

```java
private static final ScopedValue<String> USER_CONTEXT = ScopedValue.newInstance();

public void processUserRequests() {
    List<String> userIds = List.of("user1", "user2", "user3");
    
    try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
        for (String userId : userIds) {
            executor.submit(() -> {
                // æ¯ä¸ªè™šæ‹Ÿçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä½œç”¨åŸŸ
                ScopedValue.where(USER_CONTEXT, userId)
                          .run(() -> {
                              simulateBusinessLogic();
                          });
            });
        }
    }
}

private void simulateBusinessLogic() {
    String currentUser = USER_CONTEXT.get();
    System.out.println("å¤„ç†ç”¨æˆ·: " + currentUser);
    
    // è°ƒç”¨å…¶ä»–æœåŠ¡ï¼Œç”¨æˆ·ä¸Šä¸‹æ–‡è‡ªåŠ¨ä¼ é€’
    callDatabaseService();
    callExternalAPI();
}
```

#### æ ¸å¿ƒä¼˜åŠ¿

**1. æ€§èƒ½ä¼˜å¼‚**
- ä¸“ä¸ºè™šæ‹Ÿçº¿ç¨‹ä¼˜åŒ–ï¼Œå†…å­˜å ç”¨æå°
- è®¿é—®é€Ÿåº¦æ¥è¿‘å±€éƒ¨å˜é‡
- æ— éœ€æ‰‹åŠ¨æ¸…ç†ï¼Œè‡ªåŠ¨åƒåœ¾å›æ”¶

**2. ç±»å‹å®‰å…¨**
```java
private static final ScopedValue<Integer> COUNT = ScopedValue.newInstance();
private static final ScopedValue<String> NAME = ScopedValue.newInstance();

// ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œé¿å…ç±»å‹é”™è¯¯
Integer count = COUNT.get();  // è¿”å› Integer
String name = NAME.get();     // è¿”å› String
```

**3. ä¸å¯å˜æ€§ä¿è¯**
```java
// ä½œç”¨åŸŸå€¼ä¸­çš„æ•°æ®åº”è¯¥æ˜¯ä¸å¯å˜çš„
record UserContext(String userId, String tenantId, Instant timestamp) {}
private static final ScopedValue<UserContext> CONTEXT = ScopedValue.newInstance();

public void safeUsage() {
    UserContext context = new UserContext("user123", "tenant456", Instant.now());
    ScopedValue.where(CONTEXT, context)
              .run(() -> {
                  UserContext ctx = CONTEXT.get();
                  // ctx æ˜¯ä¸å¯å˜çš„ï¼Œçº¿ç¨‹å®‰å…¨
              });
}
```

**4. å®‰å…¨çš„ä½œç”¨åŸŸæ§åˆ¶**
```java
private static final ScopedValue<String> USER_ID = ScopedValue.newInstance();

public void safeAccess() {
    try {
        String userId = USER_ID.get();
        // ä½¿ç”¨ userId
    } catch (NoSuchElementException e) {
        // åœ¨ä½œç”¨åŸŸå¤–è®¿é—®ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ï¼Œé¿å…æ„å¤–ä½¿ç”¨ null å€¼
        System.out.println("æœªåœ¨ä½œç”¨åŸŸå†…ï¼Œæ— æ³•è·å–ç”¨æˆ·ID");
    }
}
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. Web è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†**
```java
@RestController
public class UserController {
    private static final ScopedValue<RequestContext> REQUEST_CONTEXT = 
        ScopedValue.newInstance();
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable String id, HttpServletRequest request) {
        RequestContext context = new RequestContext(
            request.getHeader("X-Request-ID"),
            request.getHeader("X-User-ID"),
            System.currentTimeMillis()
        );
        
        return ScopedValue.where(REQUEST_CONTEXT, context)
                         .call(() -> userService.findUser(id));
    }
}
```

**2. åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª**
```java
public class TraceContext {
    private static final ScopedValue<String> TRACE_ID = ScopedValue.newInstance();
    private static final ScopedValue<String> SPAN_ID = ScopedValue.newInstance();
    
    public static void withTrace(String traceId, String spanId, Runnable task) {
        ScopedValue.where(TRACE_ID, traceId)
                  .where(SPAN_ID, spanId)
                  .run(task);
    }
    
    public static String currentTraceId() {
        return TRACE_ID.get();
    }
}
```

#### æœ€ä½³å®è·µ

**1. å£°æ˜åŸåˆ™**
```java
// âœ… æ­£ç¡®ï¼šå£°æ˜ä¸º static final
private static final ScopedValue<String> USER_ID = ScopedValue.newInstance();

// âŒ é¿å…ï¼šéé™æ€å­—æ®µ
private ScopedValue<String> userId = ScopedValue.newInstance();
```

**2. ä¸å¯å˜æ•°æ®**
```java
// âœ… æ¨èï¼šä½¿ç”¨ä¸å¯å˜å¯¹è±¡
record UserContext(String userId, String tenantId) {}
private static final ScopedValue<UserContext> CONTEXT = ScopedValue.newInstance();

// âš ï¸ è°¨æ…ï¼šå¯å˜å¯¹è±¡å¯èƒ½å¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜
private static final ScopedValue<Map<String, Object>> MUTABLE_CONTEXT = 
    ScopedValue.newInstance();
```

#### ä¸ ThreadLocal çš„å…¨é¢å¯¹æ¯”

| ç‰¹æ€§ | ThreadLocal | ScopedValue |
|------|-------------|-------------|
| **å†…å­˜ç®¡ç†** | æ‰‹åŠ¨ `remove()` | è‡ªåŠ¨æ¸…ç† |
| **è™šæ‹Ÿçº¿ç¨‹æ€§èƒ½** | è¾ƒå·®ï¼Œå†…å­˜å¼€é”€å¤§ | ä¼˜ç§€ï¼Œä¸“é—¨ä¼˜åŒ– |
| **å†…å­˜æ³„æ¼é£é™©** | é«˜ | æ—  |
| **ä½œç”¨åŸŸæ§åˆ¶** | æ•´ä¸ªçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ | æ˜ç¡®çš„ä»£ç å— |
| **è®¿é—®å®‰å…¨æ€§** | å¯èƒ½è¿”å› `null` | æŠ›å‡ºæ˜ç¡®å¼‚å¸¸ |
| **å¯å˜æ€§** | æ”¯æŒå¯å˜å€¼ | æ¨èä¸å¯å˜å€¼ |
| **åµŒå¥—æ”¯æŒ** | éœ€è¦æ‰‹åŠ¨ç®¡ç† | å¤©ç„¶æ”¯æŒ |

#### è¿ç§»å»ºè®®

**ä» ThreadLocal è¿ç§»åˆ° ScopedValueï¼š**
```java
// æ—§ä»£ç  (ThreadLocal)
private static final ThreadLocal<String> USER_ID = new ThreadLocal<>();

public void oldWay(String userId) {
    USER_ID.set(userId);
    try {
        processRequest();
    } finally {
        USER_ID.remove();  // å®¹æ˜“å¿˜è®°
    }
}

// æ–°ä»£ç  (ScopedValue)
private static final ScopedValue<String> USER_ID = ScopedValue.newInstance();

public void newWay(String userId) {
    ScopedValue.where(USER_ID, userId)
              .run(() -> {
                  processRequest();
                  // è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€ finally å—
              });
}
```

ä½œç”¨åŸŸå€¼ä»£è¡¨äº† Java å¹¶å‘ç¼–ç¨‹çš„ç°ä»£åŒ–æ–¹å‘ï¼Œç‰¹åˆ«æ˜¯åœ¨è™šæ‹Ÿçº¿ç¨‹å¤§é‡ä½¿ç”¨çš„åœºæ™¯ä¸‹ï¼Œå®ƒæä¾›äº†æ¯” ThreadLocal æ›´å®‰å…¨ã€æ›´é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚

---

[**ğŸ”™ è¿”å›ç›®å½•**](#ğŸ“‹-è¯¦ç»†ç›®å½•)

---

## ä¸‰ã€ API ä¸åº“

### 13. æœ‰åºé›†åˆ (Sequenced Collections) (Java 21)

*   **æ¼”è¿›**: Java 21 æ­£å¼å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›ç»Ÿä¸€çš„ API æ¥å¤„ç†å…·æœ‰**ç¡®å®šé¡ºåº**çš„é›†åˆï¼Œæ— è®ºè¿™ä¸ªé¡ºåºæ˜¯æ’å…¥é¡ºåºã€æ’åºé¡ºåºè¿˜æ˜¯å…¶ä»–ç±»å‹çš„é¡ºåºã€‚

#### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

**1. ä¸ä¸€è‡´çš„ API**
```java
// Java 21 ä¹‹å‰ï¼Œè®¿é—®ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ çš„æ–¹å¼ä¸ç»Ÿä¸€
List<String> list = List.of("first", "middle", "last");
String first = list.get(0);              // List çš„æ–¹å¼
String last = list.get(list.size() - 1); // List çš„æ–¹å¼

Deque<String> deque = new ArrayDeque<>(list);
String firstInDeque = deque.getFirst();  // Deque çš„æ–¹å¼
String lastInDeque = deque.getLast();    // Deque çš„æ–¹å¼

LinkedHashSet<String> set = new LinkedHashSet<>(list);
String firstInSet = set.iterator().next(); // Set åªèƒ½é€šè¿‡è¿­ä»£å™¨
// æ²¡æœ‰ç›´æ¥è·å–æœ€åä¸€ä¸ªå…ƒç´ çš„æ–¹æ³•ï¼éœ€è¦éå†æ•´ä¸ªé›†åˆ
```

**2. ç¼ºä¹åå‘è®¿é—®èƒ½åŠ›**
```java
// åå‘éå†é›†åˆçš„å¤æ‚æ€§
List<String> list = List.of("a", "b", "c");

// åå‘éå† List - éœ€è¦ç´¢å¼•æ“ä½œ
for (int i = list.size() - 1; i >= 0; i--) {
    System.out.println(list.get(i));
}

// åå‘éå† LinkedHashSet - éå¸¸å¤æ‚
LinkedHashSet<String> set = new LinkedHashSet<>(list);
String[] array = set.toArray(new String[0]);
for (int i = array.length - 1; i >= 0; i--) {
    System.out.println(array[i]);
}
```

#### æ–°çš„æ¥å£å±‚æ¬¡ç»“æ„

**SequencedCollection<E>**
```java
public interface SequencedCollection<E> extends Collection<E> {
    // è®¿é—®ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ 
    E getFirst();
    E getLast();
    
    // åœ¨å¼€å¤´å’Œç»“å°¾æ·»åŠ å…ƒç´ 
    void addFirst(E e);
    void addLast(E e);
    
    // ç§»é™¤ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ 
    E removeFirst();
    E removeLast();
    
    // åå‘è§†å›¾
    SequencedCollection<E> reversed();
}
```

**SequencedSet<E>**
```java
public interface SequencedSet<E> extends Set<E>, SequencedCollection<E> {
    SequencedSet<E> reversed();
}
```

**SequencedMap<K,V>**
```java
public interface SequencedMap<K,V> extends Map<K,V> {
    // è®¿é—®ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ¡ç›®
    Map.Entry<K,V> firstEntry();
    Map.Entry<K,V> lastEntry();
    
    // ç§»é™¤ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ¡ç›®
    Map.Entry<K,V> pollFirstEntry();
    Map.Entry<K,V> pollLastEntry();
    
    // åœ¨å¼€å¤´å’Œç»“å°¾æ·»åŠ æ¡ç›®
    V putFirst(K key, V value);
    V putLast(K key, V value);
    
    // åºåˆ—åŒ–è§†å›¾
    SequencedSet<K> sequencedKeySet();
    SequencedCollection<V> sequencedValues();
    SequencedSet<Map.Entry<K,V>> sequencedEntrySet();
    
    // åå‘è§†å›¾
    SequencedMap<K,V> reversed();
}
```

#### ç»Ÿä¸€çš„ API ä½¿ç”¨

```java
// ç°åœ¨æ‰€æœ‰æœ‰åºé›†åˆéƒ½æœ‰ç»Ÿä¸€çš„ API
List<String> list = List.of("first", "middle", "last");
LinkedHashSet<String> set = new LinkedHashSet<>(list);
LinkedHashMap<String, Integer> map = new LinkedHashMap<>();
map.put("first", 1);
map.put("middle", 2);
map.put("last", 3);

// ç»Ÿä¸€çš„è®¿é—®æ–¹å¼
String firstFromList = list.getFirst();    // "first"
String lastFromList = list.getLast();      // "last"

String firstFromSet = set.getFirst();      // "first"
String lastFromSet = set.getLast();        // "last"

var firstFromMap = map.firstEntry();       // first=1
var lastFromMap = map.lastEntry();         // last=3
```

#### åå‘è§†å›¾ - æ ¸å¿ƒç‰¹æ€§

```java
List<String> list = List.of("a", "b", "c", "d");

// è·å–åå‘è§†å›¾
SequencedCollection<String> reversed = list.reversed();

System.out.println("åŸå§‹: " + list);     // [a, b, c, d]
System.out.println("åå‘: " + reversed); // [d, c, b, a]

// åå‘éå†
for (String item : list.reversed()) {
    System.out.println(item); // è¾“å‡º: d, c, b, a
}

// é‡è¦ï¼šåå‘è§†å›¾æ˜¯åŸé›†åˆçš„è§†å›¾ï¼Œä¸æ˜¯å‰¯æœ¬
// å¯¹åå‘è§†å›¾çš„ä¿®æ”¹ä¼šå½±å“åŸé›†åˆ
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. LRU ç¼“å­˜å®ç°**
```java
public class LRUCache<K, V> {
    private final LinkedHashMap<K, V> cache;
    private final int capacity;
    
    public LRUCache(int capacity) {
        this.capacity = capacity;
        this.cache = new LinkedHashMap<>();
    }
    
    public V get(K key) {
        V value = cache.remove(key);
        if (value != null) {
            cache.putLast(key, value); // ç§»åˆ°æœ€åï¼ˆæœ€è¿‘ä½¿ç”¨ï¼‰
        }
        return value;
    }
    
    public void put(K key, V value) {
        cache.remove(key); // å…ˆç§»é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        cache.putLast(key, value); // æ·»åŠ åˆ°æœ€å
        
        if (cache.size() > capacity) {
            cache.pollFirstEntry(); // ç§»é™¤æœ€è€çš„æ¡ç›®
        }
    }
    
    public void printCacheOrder() {
        System.out.println("ä»æ—§åˆ°æ–°: " + cache.sequencedKeySet());
        System.out.println("ä»æ–°åˆ°æ—§: " + cache.sequencedKeySet().reversed());
    }
}
```

**2. é˜Ÿåˆ—æ“ä½œçš„ç»Ÿä¸€**
```java
public class QueueOperations {
    public static <T> void demonstrateQueue(SequencedCollection<T> queue, T... items) {
        // ç»Ÿä¸€çš„é˜Ÿåˆ—æ“ä½œï¼Œæ— è®ºæ˜¯ Listã€Deque è¿˜æ˜¯ LinkedHashSet
        
        // å…¥é˜Ÿæ“ä½œ
        for (T item : items) {
            queue.addLast(item);
        }
        
        System.out.println("é˜Ÿåˆ—çŠ¶æ€: " + queue);
        
        // å‡ºé˜Ÿæ“ä½œ
        while (!queue.isEmpty()) {
            T item = queue.removeFirst();
            System.out.println("å‡ºé˜Ÿ: " + item);
        }
    }
    
    public static void main(String[] args) {
        // å¯ä»¥ç”¨ä»»ä½• SequencedCollection å®ç°
        demonstrateQueue(new ArrayList<>(), "A", "B", "C");
        demonstrateQueue(new LinkedHashSet<>(), "X", "Y", "Z");
        demonstrateQueue(new ArrayDeque<>(), 1, 2, 3);
    }
}
```

**3. å†å²è®°å½•ç®¡ç†**
```java
public class BrowserHistory {
    private final List<String> history = new ArrayList<>();
    private int currentIndex = -1;
    
    public void visit(String url) {
        // ç§»é™¤å½“å‰ä½ç½®ä¹‹åçš„æ‰€æœ‰å†å²
        while (history.size() > currentIndex + 1) {
            history.removeLast();
        }
        
        // æ·»åŠ æ–°é¡µé¢
        history.addLast(url);
        currentIndex = history.size() - 1;
    }
    
    public String back() {
        if (currentIndex > 0) {
            currentIndex--;
            return history.get(currentIndex);
        }
        return null;
    }
    
    public String forward() {
        if (currentIndex < history.size() - 1) {
            currentIndex++;
            return history.get(currentIndex);
        }
        return null;
    }
    
    public void printHistory() {
        System.out.println("å†å²è®°å½•ï¼ˆæœ€æ–°åˆ°æœ€æ—§ï¼‰:");
        for (String url : history.reversed()) {
            String marker = (history.indexOf(url) == currentIndex) ? " <- å½“å‰" : "";
            System.out.println("  " + url + marker);
        }
    }
}
```

#### å®ç°ç±»æ”¯æŒ

**å®ç°äº† SequencedCollection çš„ç±»ï¼š**
- `ArrayList`, `LinkedList`, `Vector`
- `ArrayDeque`, `LinkedHashSet`
- `TreeSet` (åŸºäºæ’åºé¡ºåº)

**å®ç°äº† SequencedMap çš„ç±»ï¼š**
- `LinkedHashMap`
- `TreeMap` (åŸºäºæ’åºé¡ºåº)

#### é‡è¦æ³¨æ„äº‹é¡¹

**1. åå‘è§†å›¾çš„è¡Œä¸º**
```java
List<String> list = new ArrayList<>(List.of("a", "b", "c"));
SequencedCollection<String> reversed = list.reversed();

// ä¿®æ”¹åŸé›†åˆå½±å“åå‘è§†å›¾
list.add("d");
System.out.println(reversed); // [d, c, b, a]

// ä¿®æ”¹åå‘è§†å›¾å½±å“åŸé›†åˆ
reversed.addFirst("e"); // ç­‰åŒäº list.addLast("e")
System.out.println(list); // [a, b, c, d, e]
```

**2. ç©ºé›†åˆçš„å¼‚å¸¸å¤„ç†**
```java
List<String> emptyList = new ArrayList<>();

try {
    emptyList.getFirst(); // æŠ›å‡º NoSuchElementException
} catch (NoSuchElementException e) {
    System.out.println("ç©ºé›†åˆæ— æ³•è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ");
}

try {
    emptyList.getLast(); // æŠ›å‡º NoSuchElementException
} catch (NoSuchElementException e) {
    System.out.println("ç©ºé›†åˆæ— æ³•è·å–æœ€åä¸€ä¸ªå…ƒç´ ");
}
```

**3. ä¸å¯å˜é›†åˆçš„é™åˆ¶**
```java
List<String> immutableList = List.of("a", "b", "c");

// å¯ä»¥è·å–å…ƒç´ 
String first = immutableList.getFirst(); // "a"
String last = immutableList.getLast();   // "c"

// ä½†ä¸èƒ½ä¿®æ”¹
try {
    immutableList.addFirst("x"); // æŠ›å‡º UnsupportedOperationException
} catch (UnsupportedOperationException e) {
    System.out.println("ä¸å¯å˜é›†åˆä¸æ”¯æŒä¿®æ”¹æ“ä½œ");
}
```

#### æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

1. **API ç»Ÿä¸€æ€§**: æ‰€æœ‰æœ‰åºé›†åˆéƒ½æœ‰ä¸€è‡´çš„è®¿é—®æ¥å£
2. **ä»£ç ç®€æ´æ€§**: æ— éœ€å¤æ‚çš„ç´¢å¼•æ“ä½œæˆ–è¿­ä»£å™¨
3. **åå‘æ“ä½œ**: å¤©ç„¶æ”¯æŒåå‘éå†å’Œæ“ä½œ
4. **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
5. **æ€§èƒ½ä¼˜åŒ–**: é¿å…äº†ä¸å¿…è¦çš„æ•°ç»„è½¬æ¢å’Œç´¢å¼•è®¡ç®—

æœ‰åºé›†åˆæ˜¯ Java 21 ä¸­æœ€å®ç”¨çš„æ–°ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒè®©é›†åˆ API æ›´åŠ ä¸€è‡´å’Œç›´è§‚ï¼Œæ˜¾è‘—æå‡äº†å¼€å‘æ•ˆç‡ã€‚

### 14. HTTP å®¢æˆ·ç«¯ (Standard HTTP Client) (Java 11)

*   **æ¼”è¿›**: Java 11 æ­£å¼å¼•å…¥ï¼Œæ›¿ä»£äº†é•¿æœŸä»¥æ¥ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ Apache HttpClientã€OkHttpï¼‰è¿›è¡Œ HTTP é€šä¿¡çš„ç°çŠ¶ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›ç°ä»£åŒ–ã€é«˜æ€§èƒ½çš„ HTTP å®¢æˆ·ç«¯ï¼ŒåŸç”Ÿæ”¯æŒ HTTP/2 å’Œå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼Œå‡å°‘å¤–éƒ¨ä¾èµ–ã€‚

#### æ ¸å¿ƒç‰¹æ€§

**1. åŒæ­¥å’Œå¼‚æ­¥ API**
```java
// åŒæ­¥è¯·æ±‚
HttpClient client = HttpClient.newHttpClient();
HttpRequest request = HttpRequest.newBuilder()
        .uri(URI.create("https://api.example.com/data"))
        .GET()
        .build();

HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
System.out.println("çŠ¶æ€ç : " + response.statusCode());
System.out.println("å“åº”ä½“: " + response.body());

// å¼‚æ­¥è¯·æ±‚
CompletableFuture<HttpResponse<String>> future = client.sendAsync(request, HttpResponse.BodyHandlers.ofString());
future.thenAccept(resp -> {
    System.out.println("å¼‚æ­¥å“åº”: " + resp.body());
});
```

**2. HTTP/2 æ”¯æŒ**
```java
// æ˜ç¡®æŒ‡å®š HTTP/2
HttpClient client = HttpClient.newBuilder()
        .version(HttpClient.Version.HTTP_2)
        .build();

// æˆ–è€…è®©å®¢æˆ·ç«¯è‡ªåŠ¨é€‰æ‹©ç‰ˆæœ¬
HttpClient autoClient = HttpClient.newBuilder()
        .version(HttpClient.Version.HTTP_2) // é¦–é€‰ HTTP/2ï¼Œé™çº§åˆ° HTTP/1.1
        .build();
```

**3. è¯·æ±‚é…ç½®**
```java
HttpRequest request = HttpRequest.newBuilder()
        .uri(URI.create("https://api.example.com/users"))
        .timeout(Duration.ofSeconds(30))
        .header("Content-Type", "application/json")
        .header("Authorization", "Bearer " + token)
        .GET()
        .build();
```

**4. ä¸åŒçš„è¯·æ±‚æ–¹æ³•**
```java
// GET è¯·æ±‚
HttpRequest getRequest = HttpRequest.newBuilder()
        .uri(URI.create("https://api.example.com/users"))
        .GET()
        .build();

// POST è¯·æ±‚
String jsonData = """
        {
            "name": "å¼ ä¸‰",
            "email": "zhangsan@example.com"
        }
        """;

HttpRequest postRequest = HttpRequest.newBuilder()
        .uri(URI.create("https://api.example.com/users"))
        .header("Content-Type", "application/json")
        .POST(HttpRequest.BodyPublishers.ofString(jsonData))
        .build();

// PUT è¯·æ±‚
HttpRequest putRequest = HttpRequest.newBuilder()
        .uri(URI.create("https://api.example.com/users/123"))
        .header("Content-Type", "application/json")
        .PUT(HttpRequest.BodyPublishers.ofString(jsonData))
        .build();

// DELETE è¯·æ±‚
HttpRequest deleteRequest = HttpRequest.newBuilder()
        .uri(URI.create("https://api.example.com/users/123"))
        .DELETE()
        .build();
```

**5. ä¸åŒçš„å“åº”ä½“å¤„ç†**
```java
// å­—ç¬¦ä¸²å“åº”
HttpResponse<String> stringResponse = client.send(request, HttpResponse.BodyHandlers.ofString());

// å­—èŠ‚æ•°ç»„å“åº”
HttpResponse<byte[]> bytesResponse = client.send(request, HttpResponse.BodyHandlers.ofByteArray());

// æ–‡ä»¶å“åº”
HttpResponse<Path> fileResponse = client.send(request, 
    HttpResponse.BodyHandlers.ofFile(Paths.get("download.txt")));

// æµå“åº”
HttpResponse<InputStream> streamResponse = client.send(request, 
    HttpResponse.BodyHandlers.ofInputStream());
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. RESTful API å®¢æˆ·ç«¯**
```java
public class ApiClient {
    private final HttpClient client;
    private final String baseUrl;
    private final String authToken;
    
    public ApiClient(String baseUrl, String authToken) {
        this.client = HttpClient.newBuilder()
                .connectTimeout(Duration.ofSeconds(10))
                .build();
        this.baseUrl = baseUrl;
        this.authToken = authToken;
    }
    
    public CompletableFuture<User> getUser(String userId) {
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(baseUrl + "/users/" + userId))
                .header("Authorization", "Bearer " + authToken)
                .GET()
                .build();
        
        return client.sendAsync(request, HttpResponse.BodyHandlers.ofString())
                .thenApply(response -> {
                    if (response.statusCode() == 200) {
                        return parseUser(response.body());
                    } else {
                        throw new RuntimeException("API é”™è¯¯: " + response.statusCode());
                    }
                });
    }
    
    public CompletableFuture<User> createUser(User user) {
        String jsonData = toJson(user);
        
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(baseUrl + "/users"))
                .header("Content-Type", "application/json")
                .header("Authorization", "Bearer " + authToken)
                .POST(HttpRequest.BodyPublishers.ofString(jsonData))
                .build();
        
        return client.sendAsync(request, HttpResponse.BodyHandlers.ofString())
                .thenApply(response -> parseUser(response.body()));
    }
    
    private User parseUser(String json) {
        // JSON è§£æé€»è¾‘
        return new User();
    }
    
    private String toJson(User user) {
        // JSON åºåˆ—åŒ–é€»è¾‘
        return "{}";
    }
}
```

**2. æ–‡ä»¶ä¸‹è½½**
```java
public class FileDownloader {
    private final HttpClient client;
    
    public FileDownloader() {
        this.client = HttpClient.newBuilder()
                .followRedirects(HttpClient.Redirect.ALWAYS)
                .build();
    }
    
    public CompletableFuture<Path> downloadFile(String url, Path destination) {
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .GET()
                .build();
        
        return client.sendAsync(request, HttpResponse.BodyHandlers.ofFile(destination))
                .thenApply(response -> {
                    if (response.statusCode() == 200) {
                        System.out.println("æ–‡ä»¶ä¸‹è½½æˆåŠŸ: " + destination);
                        return response.body();
                    } else {
                        throw new RuntimeException("ä¸‹è½½å¤±è´¥: " + response.statusCode());
                    }
                });
    }
    
    public void downloadWithProgress(String url, Path destination) {
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .GET()
                .build();
        
        client.sendAsync(request, HttpResponse.BodyHandlers.ofFile(destination))
                .thenAccept(response -> {
                    System.out.println("ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: " + 
                        response.headers().firstValue("content-length").orElse("æœªçŸ¥"));
                });
    }
}
```

**3. æ‰¹é‡å¼‚æ­¥è¯·æ±‚**
```java
public class BatchApiClient {
    private final HttpClient client;
    
    public BatchApiClient() {
        this.client = HttpClient.newBuilder()
                .executor(Executors.newFixedThreadPool(10))
                .build();
    }
    
    public CompletableFuture<List<String>> fetchMultipleUrls(List<String> urls) {
        List<CompletableFuture<String>> futures = urls.stream()
                .map(url -> {
                    HttpRequest request = HttpRequest.newBuilder()
                            .uri(URI.create(url))
                            .GET()
                            .build();
                    
                    return client.sendAsync(request, HttpResponse.BodyHandlers.ofString())
                            .thenApply(HttpResponse::body);
                })
                .toList();
        
        return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
                .thenApply(v -> futures.stream()
                        .map(CompletableFuture::join)
                        .toList());
    }
}
```

#### é”™è¯¯å¤„ç†

**1. çŠ¶æ€ç å¤„ç†**
```java
HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

switch (response.statusCode()) {
    case 200 -> System.out.println("è¯·æ±‚æˆåŠŸ");
    case 404 -> System.out.println("èµ„æºä¸å­˜åœ¨");
    case 500 -> System.out.println("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯");
    default -> System.out.println("å…¶ä»–é”™è¯¯: " + response.statusCode());
}
```

**2. å¼‚å¸¸å¤„ç†**
```java
try {
    HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
    // å¤„ç†å“åº”
} catch (IOException e) {
    // ç½‘ç»œé”™è¯¯ã€è¿æ¥è¶…æ—¶ç­‰
    System.err.println("ç½‘ç»œé”™è¯¯: " + e.getMessage());
} catch (InterruptedException e) {
    // è¯·æ±‚è¢«ä¸­æ–­
    System.err.println("è¯·æ±‚è¢«ä¸­æ–­: " + e.getMessage());
    Thread.currentThread().interrupt();
}
```

**3. è¶…æ—¶å¤„ç†**
```java
HttpClient client = HttpClient.newBuilder()
        .connectTimeout(Duration.ofSeconds(10))
        .build();

HttpRequest request = HttpRequest.newBuilder()
        .uri(URI.create("https://api.example.com/slow-endpoint"))
        .timeout(Duration.ofSeconds(30))
        .GET()
        .build();
```

#### ä¸å…¶ä»– HTTP å®¢æˆ·ç«¯å¯¹æ¯”

| ç‰¹æ€§ | Java HttpClient | Spring WebClient | OkHttp | Apache HttpClient |
|------|----------------|------------------|--------|-------------------|
| **ä¾èµ–** | æ— éœ€å¤–éƒ¨ä¾èµ– | Spring ç”Ÿæ€ä¸€éƒ¨åˆ† | éœ€è¦å¤–éƒ¨ä¾èµ– | éœ€è¦å¤–éƒ¨ä¾èµ– |
| **HTTP/2** | âœ… åŸç”Ÿæ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **å¼‚æ­¥** | âœ… CompletableFuture | âœ… å“åº”å¼ | âœ… å›è°ƒ/å¼‚æ­¥ | âš ï¸ æœ‰é™æ”¯æŒ |
| **JSON å¤„ç†** | âš ï¸ éœ€è¦æ‰‹åŠ¨å¤„ç† | âœ… è‡ªåŠ¨åºåˆ—åŒ– | âš ï¸ éœ€è¦é€‚é…å™¨ | âš ï¸ éœ€è¦æ‰‹åŠ¨å¤„ç† |
| **è¿æ¥æ± ** | âœ… å†…ç½® | âœ… å†…ç½® | âœ… å†…ç½® | âœ… å†…ç½® |
| **æ‹¦æˆªå™¨** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | âœ… å¼ºå¤§çš„æ‹¦æˆªå™¨ | âœ… æ”¯æŒ |

#### åœ¨ Spring é¡¹ç›®ä¸­çš„ä½¿ç”¨å»ºè®®

**1. é€‰æ‹© WebClient çš„åœºæ™¯**
```java
// Spring Boot é¡¹ç›®æ¨èä½¿ç”¨ WebClient
@Service
public class UserService {
    private final WebClient webClient;
    
    public UserService(WebClient.Builder webClientBuilder) {
        this.webClient = webClientBuilder
                .baseUrl("https://api.example.com")
                .build();
    }
    
    public Mono<User> getUser(String id) {
        return webClient.get()
                .uri("/users/{id}", id)
                .retrieve()
                .bodyToMono(User.class);
    }
}
```

**2. é€‰æ‹© HttpClient çš„åœºæ™¯**
```java
// ç‹¬ç«‹å·¥å…·ç±»æˆ–ç®€å• HTTP è°ƒç”¨
@Component
public class HttpUtils {
    private static final HttpClient client = HttpClient.newHttpClient();
    
    public static String get(String url) throws IOException, InterruptedException {
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .GET()
                .build();
        
        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
        return response.body();
    }
}
```

#### æ ¸å¿ƒä¼˜åŠ¿

1. **æ ‡å‡†åŒ–**: æ— éœ€å¤–éƒ¨ä¾èµ–ï¼Œå‡å°‘ä¾èµ–ç®¡ç†å¤æ‚åº¦
2. **ç°ä»£åŒ–**: åŸç”Ÿæ”¯æŒ HTTP/2ã€å¼‚æ­¥ç¼–ç¨‹
3. **é«˜æ€§èƒ½**: JVM å±‚é¢ä¼˜åŒ–ï¼Œè¿æ¥æ± ç®¡ç†
4. **æ˜“ç”¨æ€§**: ç®€æ´çš„ API è®¾è®¡ï¼Œé“¾å¼è°ƒç”¨
5. **ç»´æŠ¤æ€§**: ç”± JDK å›¢é˜Ÿç»´æŠ¤ï¼Œé•¿æœŸæ”¯æŒ

#### é€‚ç”¨åœºæ™¯

**æ¨èä½¿ç”¨ HttpClient**:
- æ–°é¡¹ç›®ä¸”è¿½æ±‚æœ€å°ä¾èµ–
- å¾®æœåŠ¡é—´çš„ç®€å• HTTP è°ƒç”¨
- éœ€è¦ HTTP/2 æ”¯æŒçš„é«˜æ€§èƒ½åœºæ™¯
- ç‹¬ç«‹å·¥å…·æˆ–å‘½ä»¤è¡Œåº”ç”¨

**è€ƒè™‘å…¶ä»–é€‰æ‹©**:
- Spring é¡¹ç›®æ¨è WebClientï¼ˆå“åº”å¼ç¼–ç¨‹ï¼‰
- éœ€è¦å¤æ‚æ‹¦æˆªå™¨åŠŸèƒ½æ—¶è€ƒè™‘ OkHttp
- å·²æœ‰é¡¹ç›®ä¸” Apache HttpClient å·¥ä½œè‰¯å¥½

Java 11 çš„ HttpClient ä¸º Java ç”Ÿæ€ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªç°ä»£åŒ–çš„ã€é«˜æ€§èƒ½çš„ HTTP å®¢æˆ·ç«¯è§£å†³æ–¹æ¡ˆï¼Œè™½ç„¶ä¸èƒ½å®Œå…¨æ›¿ä»£æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“ï¼Œä½†åœ¨è®¸å¤šåœºæ™¯ä¸‹éƒ½æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚

### 15. é›†åˆå·¥å‚æ–¹æ³• (Collection Factory Methods) (Java 9)

*   **æ¼”è¿›**: Java 9 æ­£å¼å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›ç®€æ´ã€ç›´è§‚çš„æ–¹å¼æ¥åˆ›å»ºä¸å¯å˜é›†åˆï¼Œé¿å…ä¼ ç»Ÿæ–¹æ³•çš„å†—é•¿ä»£ç ã€‚

#### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

**1. ä¼ ç»Ÿåˆ›å»ºä¸å¯å˜é›†åˆçš„å¤æ‚æ€§**
```java
// Java 9 ä¹‹å‰ - åˆ›å»ºä¸å¯å˜åˆ—è¡¨
List<String> list = Arrays.asList("apple", "banana", "orange");
List<String> immutableList = Collections.unmodifiableList(list);

// Java 9 ä¹‹å‰ - åˆ›å»ºä¸å¯å˜é›†åˆ
Set<String> set = new HashSet<>();
set.add("red");
set.add("green");
set.add("blue");
Set<String> immutableSet = Collections.unmodifiableSet(set);

// Java 9 ä¹‹å‰ - åˆ›å»ºä¸å¯å˜æ˜ å°„
Map<String, Integer> map = new HashMap<>();
map.put("apple", 1);
map.put("banana", 2);
map.put("orange", 3);
Map<String, Integer> immutableMap = Collections.unmodifiableMap(map);
```

**2. ä»£ç å†—é•¿ä¸”å®¹æ˜“å‡ºé”™**
```java
// ä¼ ç»Ÿæ–¹æ³•çš„é—®é¢˜
List<String> mutableList = Arrays.asList("a", "b", "c");
List<String> immutableList = Collections.unmodifiableList(mutableList);
// é—®é¢˜ï¼šåŸå§‹åˆ—è¡¨ä»ç„¶å¯ä»¥è¢«ä¿®æ”¹ï¼Œå½±å“"ä¸å¯å˜"åˆ—è¡¨

// æ›´å®‰å…¨ä½†æ›´å¤æ‚çš„åšæ³•
List<String> safelist = Collections.unmodifiableList(
    new ArrayList<>(Arrays.asList("a", "b", "c"))
);
```

#### æ–°çš„å·¥å‚æ–¹æ³•

**1. List.of() - åˆ›å»ºä¸å¯å˜åˆ—è¡¨**
```java
// åˆ›å»ºä¸å¯å˜åˆ—è¡¨
List<String> fruits = List.of("apple", "banana", "orange");
List<Integer> numbers = List.of(1, 2, 3, 4, 5);
List<String> empty = List.of();
List<String> single = List.of("single");

// æ”¯æŒæ³›å‹æ¨æ–­
var colors = List.of("red", "green", "blue");

// å…è®¸é‡å¤å…ƒç´ 
List<String> withDuplicates = List.of("a", "b", "a", "c");
```

**2. Set.of() - åˆ›å»ºä¸å¯å˜é›†åˆ**
```java
// åˆ›å»ºä¸å¯å˜é›†åˆ
Set<String> colors = Set.of("red", "green", "blue");
Set<Integer> numbers = Set.of(1, 2, 3, 4, 5);
Set<String> empty = Set.of();
Set<String> single = Set.of("unique");

// é‡å¤å…ƒç´ ä¼šæŠ›å‡ºå¼‚å¸¸
try {
    Set<String> duplicate = Set.of("a", "b", "a"); // IllegalArgumentException
} catch (IllegalArgumentException e) {
    System.out.println("Set ä¸å…è®¸é‡å¤å…ƒç´ ");
}
```

**3. Map.of() - åˆ›å»ºä¸å¯å˜æ˜ å°„**
```java
// åˆ›å»ºä¸å¯å˜æ˜ å°„ï¼ˆæœ€å¤š 10 ä¸ªé”®å€¼å¯¹ï¼‰
Map<String, Integer> ages = Map.of("Alice", 25, "Bob", 30, "Charlie", 35);
Map<String, String> empty = Map.of();
Map<String, String> single = Map.of("key", "value");

// åˆ›å»ºæ›´å¤§çš„æ˜ å°„ä½¿ç”¨ Map.ofEntries()
Map<String, String> countries = Map.ofEntries(
    Map.entry("CN", "China"),
    Map.entry("US", "United States"),
    Map.entry("JP", "Japan"),
    Map.entry("DE", "Germany"),
    Map.entry("FR", "France"),
    Map.entry("UK", "United Kingdom"),
    Map.entry("IT", "Italy"),
    Map.entry("ES", "Spain"),
    Map.entry("RU", "Russia"),
    Map.entry("IN", "India"),
    Map.entry("BR", "Brazil")
);
```

#### æ ¸å¿ƒç‰¹æ€§

**1. çœŸæ­£çš„ä¸å¯å˜æ€§**
```java
List<String> list = List.of("a", "b", "c");
Set<String> set = Set.of("x", "y", "z");
Map<String, Integer> map = Map.of("one", 1, "two", 2);

// æ‰€æœ‰ä¿®æ”¹æ“ä½œéƒ½ä¼šæŠ›å‡º UnsupportedOperationException
try {
    list.add("d");          // æŠ›å‡ºå¼‚å¸¸
    set.remove("x");        // æŠ›å‡ºå¼‚å¸¸
    map.put("three", 3);    // æŠ›å‡ºå¼‚å¸¸
} catch (UnsupportedOperationException e) {
    System.out.println("çœŸæ­£çš„ä¸å¯å˜é›†åˆ");
}
```

**2. æ‹’ç» null å€¼**
```java
// ä»¥ä¸‹ä»£ç éƒ½ä¼šæŠ›å‡º NullPointerException
try {
    List.of("a", null, "c");        // ä¸å…è®¸ null å…ƒç´ 
    Set.of("a", null, "c");         // ä¸å…è®¸ null å…ƒç´ 
    Map.of("key", null);            // ä¸å…è®¸ null å€¼
    Map.of(null, "value");          // ä¸å…è®¸ null é”®
} catch (NullPointerException e) {
    System.out.println("å·¥å‚æ–¹æ³•æ‹’ç» null å€¼");
}
```

**3. æ€§èƒ½ä¼˜åŒ–**
```java
// é’ˆå¯¹ä¸åŒå¤§å°çš„é›†åˆï¼Œä½¿ç”¨ä¸åŒçš„å†…éƒ¨å®ç°
List<String> small = List.of("a");              // å•å…ƒç´ ä¼˜åŒ–å®ç°
List<String> medium = List.of("a", "b", "c");   // å°é›†åˆä¼˜åŒ–å®ç°
List<String> large = List.of(/* å¾ˆå¤šå…ƒç´  */);      // å¤§é›†åˆå®ç°

// å†…å­˜å ç”¨æ›´å°‘ï¼Œè®¿é—®é€Ÿåº¦æ›´å¿«
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. å¸¸é‡å®šä¹‰**
```java
public class Constants {
    public static final List<String> SUPPORTED_LANGUAGES = 
        List.of("Java", "Python", "JavaScript", "Go", "Rust");
    
    public static final Set<String> VALID_STATUSES = 
        Set.of("ACTIVE", "INACTIVE", "PENDING", "SUSPENDED");
    
    public static final Map<String, String> ERROR_MESSAGES = Map.of(
        "INVALID_USER", "ç”¨æˆ·ä¸å­˜åœ¨",
        "INVALID_PASSWORD", "å¯†ç é”™è¯¯",
        "ACCOUNT_LOCKED", "è´¦æˆ·å·²é”å®š"
    );
}
```

**2. æ–¹æ³•è¿”å›å€¼**
```java
public class UserService {
    public List<String> getDefaultPermissions() {
        return List.of("READ", "WRITE", "DELETE");
    }
    
    public Set<String> getSupportedFormats() {
        return Set.of("JSON", "XML", "CSV", "YAML");
    }
    
    public Map<String, Object> getDefaultSettings() {
        return Map.of(
            "theme", "dark",
            "language", "zh-CN",
            "notifications", true,
            "autoSave", true
        );
    }
}
```

**3. æµ‹è¯•æ•°æ®**
```java
@Test
void testUserValidation() {
    // æµ‹è¯•æ•°æ®åˆ›å»ºæ›´åŠ ç®€æ´
    List<String> validEmails = List.of(
        "user@example.com",
        "admin@company.org",
        "test@domain.net"
    );
    
    Set<String> bannedDomains = Set.of(
        "spam.com",
        "fake.org",
        "invalid.net"
    );
    
    Map<String, String> testUsers = Map.of(
        "admin", "admin123",
        "user", "user456",
        "guest", "guest789"
    );
    
    // æµ‹è¯•é€»è¾‘...
}
```

**4. é…ç½®å’Œæ˜ å°„**
```java
public class ApiController {
    private static final Map<String, String> STATUS_CODES = Map.of(
        "SUCCESS", "200",
        "BAD_REQUEST", "400",
        "UNAUTHORIZED", "401",
        "FORBIDDEN", "403",
        "NOT_FOUND", "404",
        "INTERNAL_ERROR", "500"
    );
    
    private static final Set<String> ALLOWED_METHODS = 
        Set.of("GET", "POST", "PUT", "DELETE", "PATCH");
    
    public ResponseEntity<?> handleRequest(String method, String path) {
        if (!ALLOWED_METHODS.contains(method)) {
            return ResponseEntity.status(405).build();
        }
        // å¤„ç†è¯·æ±‚...
    }
}
```

#### é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

**1. å…ƒç´ æ•°é‡é™åˆ¶**
```java
// Map.of() æœ€å¤šæ”¯æŒ 10 ä¸ªé”®å€¼å¯¹
Map<String, String> map = Map.of(
    "k1", "v1", "k2", "v2", "k3", "v3", "k4", "v4", "k5", "v5",
    "k6", "v6", "k7", "v7", "k8", "v8", "k9", "v9", "k10", "v10"
); // è¿™æ˜¯æœ€å¤§é™åˆ¶

// è¶…è¿‡ 10 ä¸ªé”®å€¼å¯¹éœ€è¦ä½¿ç”¨ Map.ofEntries()
Map<String, String> largeMap = Map.ofEntries(
    Map.entry("k1", "v1"),
    Map.entry("k2", "v2"),
    // ... å¯ä»¥æœ‰æ›´å¤šæ¡ç›®
    Map.entry("k15", "v15")
);
```

**2. ç±»å‹æ¨æ–­**
```java
// æ­£ç¡®çš„ç±»å‹æ¨æ–­
var numbers = List.of(1, 2, 3);        // List<Integer>
var strings = Set.of("a", "b", "c");   // Set<String>

// æ··åˆç±»å‹éœ€è¦æ˜¾å¼å£°æ˜
List<Object> mixed = List.of("string", 123, true);
// æˆ–è€…ä½¿ç”¨å…¬å…±çˆ¶ç±»å‹
List<Serializable> serializable = List.of("string", 123);
```

**3. ä¸ä¼ ç»Ÿæ–¹æ³•çš„äº’æ“ä½œæ€§**
```java
// å·¥å‚æ–¹æ³•åˆ›å»ºçš„é›†åˆä¸ä¼ ç»Ÿæ–¹æ³•åˆ›å»ºçš„é›†åˆç›¸ç­‰
List<String> factoryList = List.of("a", "b", "c");
List<String> traditionalList = Collections.unmodifiableList(
    Arrays.asList("a", "b", "c")
);

assert factoryList.equals(traditionalList); // true
assert factoryList.hashCode() == traditionalList.hashCode(); // true

// ä½†å†…éƒ¨å®ç°ä¸åŒ
assert factoryList.getClass() != traditionalList.getClass(); // true
```

#### æ€§èƒ½æ¯”è¾ƒ

**1. åˆ›å»ºæ€§èƒ½**
```java
// å·¥å‚æ–¹æ³•æ›´å¿«
List<String> factory = List.of("a", "b", "c");

// ä¼ ç»Ÿæ–¹æ³•è¾ƒæ…¢
List<String> traditional = Collections.unmodifiableList(
    Arrays.asList("a", "b", "c")
);
```

**2. å†…å­˜ä½¿ç”¨**
```java
// å·¥å‚æ–¹æ³•åˆ›å»ºçš„é›†åˆå†…å­˜å ç”¨æ›´å°‘
// å› ä¸ºä½¿ç”¨äº†é’ˆå¯¹ç‰¹å®šå¤§å°ä¼˜åŒ–çš„å†…éƒ¨å®ç°

// ä¾‹å¦‚ï¼šå•å…ƒç´ åˆ—è¡¨ä½¿ç”¨ç‰¹æ®Šçš„å•å…ƒç´ å®ç°
List<String> single = List.of("single");
// è€Œä¸æ˜¯é€šç”¨çš„ ArrayList å®ç°
```

#### æœ€ä½³å®è·µ

**1. ä¼˜å…ˆä½¿ç”¨å·¥å‚æ–¹æ³•**
```java
// å¥½çš„åšæ³•
public static final List<String> COLORS = List.of("red", "green", "blue");

// é¿å…çš„åšæ³•
public static final List<String> COLORS = Collections.unmodifiableList(
    Arrays.asList("red", "green", "blue")
);
```

**2. æ˜ç¡®è¡¨è¾¾ä¸å¯å˜æ€§**
```java
// æ–¹æ³•ç­¾åæ˜ç¡®è¡¨è¾¾è¿”å›ä¸å¯å˜é›†åˆ
public List<String> getReadOnlyList() {
    return List.of("item1", "item2", "item3");
}

// è€Œä¸æ˜¯è¿”å›å¯å˜é›†åˆ
public List<String> getMutableList() {
    return new ArrayList<>(Arrays.asList("item1", "item2", "item3"));
}
```

**3. åœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨**
```java
public class ImmutableConfig {
    private final List<String> allowedValues;
    private final Map<String, String> properties;
    
    public ImmutableConfig(List<String> values, Map<String, String> props) {
        // åˆ›å»ºé˜²å¾¡æ€§å‰¯æœ¬
        this.allowedValues = List.copyOf(values);
        this.properties = Map.copyOf(props);
    }
    
    // æˆ–è€…ç›´æ¥ä½¿ç”¨å·¥å‚æ–¹æ³•
    public static ImmutableConfig createDefault() {
        return new ImmutableConfig(
            List.of("default1", "default2"),
            Map.of("key1", "value1", "key2", "value2")
        );
    }
}
```

#### ç›¸å…³çš„ copyOf æ–¹æ³•

**Java 10 å¼•å…¥çš„ copyOf æ–¹æ³•**
```java
// ä»ç°æœ‰é›†åˆåˆ›å»ºä¸å¯å˜å‰¯æœ¬
List<String> mutableList = new ArrayList<>();
mutableList.add("a");
mutableList.add("b");

List<String> immutableCopy = List.copyOf(mutableList);
Set<String> immutableSet = Set.copyOf(mutableList);
Map<String, String> sourceMap = new HashMap<>();
Map<String, String> immutableMap = Map.copyOf(sourceMap);

// å¦‚æœæºé›†åˆå·²ç»æ˜¯ä¸å¯å˜çš„ï¼ŒcopyOf ä¼šè¿”å›åŸé›†åˆ
List<String> original = List.of("a", "b", "c");
List<String> copy = List.copyOf(original);
assert original == copy; // trueï¼ŒåŒä¸€ä¸ªå¯¹è±¡
```

#### æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

1. **ä»£ç ç®€æ´**: å¤§å¹…å‡å°‘åˆ›å»ºä¸å¯å˜é›†åˆçš„æ ·æ¿ä»£ç 
2. **æ€§èƒ½ä¼˜å¼‚**: é’ˆå¯¹ä¸åŒå¤§å°çš„é›†åˆè¿›è¡Œä¼˜åŒ–
3. **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œè¿è¡Œæ—¶ç±»å‹ä¸€è‡´
4. **çœŸæ­£ä¸å¯å˜**: æ— æ³•é€šè¿‡ä»»ä½•æ–¹å¼ä¿®æ”¹é›†åˆå†…å®¹
5. **Null å®‰å…¨**: æ‹’ç» null å€¼ï¼Œé¿å… NullPointerException

é›†åˆå·¥å‚æ–¹æ³•æ˜¯ Java 9 ä¸­æœ€å®ç”¨çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒè®©ä¸å¯å˜é›†åˆçš„åˆ›å»ºå˜å¾—ç®€å•è€Œä¼˜é›…ï¼Œæ˜¯ç°ä»£ Java å¼€å‘ä¸­çš„æ ‡å‡†åšæ³•ã€‚

### 16. Stream, Optional, String ç­‰ API å¢å¼º (Java 9+)

*   **æ¼”è¿›**: ä» Java 9 å¼€å§‹ï¼Œå¯¹æ ¸å¿ƒ API è¿›è¡Œäº†æŒç»­çš„å¢å¼ºå’Œæ”¹è¿›ã€‚
*   **æ ¸å¿ƒç†å¿µ**: è®©å¸¸ç”¨çš„ API æ›´åŠ å¼ºå¤§ã€ä¾¿åˆ©å’Œç›´è§‚ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚

#### Stream API å¢å¼º

**1. takeWhile() å’Œ dropWhile() (Java 9)**
```java
// takeWhile - ä»å¤´å¼€å§‹å–å…ƒç´ ï¼Œç›´åˆ°æ¡ä»¶ä¸æ»¡è¶³ä¸ºæ­¢
List<Integer> numbers = List.of(1, 2, 3, 4, 5, 6, 7, 8, 9, 10);
List<Integer> taken = numbers.stream()
        .takeWhile(n -> n <= 5)
        .collect(Collectors.toList());
// ç»“æœ: [1, 2, 3, 4, 5]

// dropWhile - ä»å¤´å¼€å§‹ä¸¢å¼ƒå…ƒç´ ï¼Œç›´åˆ°æ¡ä»¶ä¸æ»¡è¶³ä¸ºæ­¢
List<Integer> dropped = numbers.stream()
        .dropWhile(n -> n <= 5)
        .collect(Collectors.toList());
// ç»“æœ: [6, 7, 8, 9, 10]

// ä¸ filter çš„åŒºåˆ«
List<Integer> filtered = numbers.stream()
        .filter(n -> n > 5)
        .collect(Collectors.toList());
// ç»“æœ: [6, 7, 8, 9, 10] (åŠŸèƒ½ç›¸åŒï¼Œä½†è¯­ä¹‰ä¸åŒ)
```

**åŒºåˆ«è¯´æ˜ï¼š**
- `takeWhile/dropWhile` æ˜¯åŸºäºé¡ºåºçš„ï¼Œé‡åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„å…ƒç´ å°±åœæ­¢
- `filter` æ˜¯åŸºäºæ¡ä»¶çš„ï¼Œä¼šæ£€æŸ¥æ‰€æœ‰å…ƒç´ 

**2. iterate() æ–¹æ³•é‡è½½ (Java 9)**
```java
// ä¼ ç»Ÿçš„ iterate (æ— é™æµï¼Œéœ€è¦ limit)
List<Integer> traditional = Stream.iterate(1, n -> n + 1)
        .limit(5)
        .collect(Collectors.toList());

// æ–°çš„ iterate (å¸¦æ¡ä»¶çš„æœ‰é™æµ)
List<Integer> enhanced = Stream.iterate(1, n -> n <= 10, n -> n + 2)
        .collect(Collectors.toList());
// ç»“æœ: [1, 3, 5, 7, 9]
```

**3. ofNullable() æ–¹æ³• (Java 9)**
```java
// å®‰å…¨å¤„ç†å¯èƒ½ä¸º null çš„å•ä¸ªå…ƒç´ 
String nullableString = null;
String validString = "hello";

long nullCount = Stream.ofNullable(nullableString).count();    // 0
long validCount = Stream.ofNullable(validString).count();      // 1

// å®é™…åº”ç”¨ï¼šè¿‡æ»¤é›†åˆä¸­çš„ null å€¼
List<String> results = Stream.of("a", null, "b", "c")
        .flatMap(Stream::ofNullable)
        .collect(Collectors.toList());
// ç»“æœ: [a, b, c]
```

#### Optional API å¢å¼º

**1. ifPresentOrElse() æ–¹æ³• (Java 9)**
```java
Optional<String> optional = Optional.of("Hello");

// åŒæ—¶å¤„ç†æœ‰å€¼å’Œæ— å€¼çš„æƒ…å†µ
optional.ifPresentOrElse(
    value -> System.out.println("æœ‰å€¼: " + value),
    () -> System.out.println("æ— å€¼æ—¶çš„å¤„ç†")
);
```

**2. or() æ–¹æ³• (Java 9)**
```java
Optional<String> empty = Optional.empty();
Optional<String> backup = Optional.of("backup");

// æä¾›å¤‡é€‰çš„ Optional
Optional<String> result = empty.or(() -> backup);
// ç»“æœ: Optional[backup]
```

**3. stream() æ–¹æ³• (Java 9)**
```java
List<Optional<String>> optionals = List.of(
    Optional.of("a"),
    Optional.empty(),
    Optional.of("b"),
    Optional.of("c")
);

// ä» Optional æµä¸­æå–æœ‰å€¼çš„å…ƒç´ 
List<String> values = optionals.stream()
        .flatMap(Optional::stream)
        .collect(Collectors.toList());
// ç»“æœ: [a, b, c]
```

**4. isEmpty() æ–¹æ³• (Java 11)**
```java
Optional<String> empty = Optional.empty();
Optional<String> present = Optional.of("Hello");

// æ›´ç›´è§‚çš„ç©ºå€¼æ£€æŸ¥
boolean isEmpty = empty.isEmpty();     // true
boolean isPresent = present.isEmpty(); // false

// ä¸ isPresent() ç›¸æ¯”æ›´åŠ ç›´è§‚
if (optional.isEmpty()) {
    // å¤„ç†ç©ºå€¼æƒ…å†µ
}
```

#### String API å¢å¼º

**1. isBlank() æ–¹æ³• (Java 11)**
```java
String empty = "";
String whitespace = "   ";
String content = "hello";

// æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºæˆ–åªåŒ…å«ç©ºç™½å­—ç¬¦
empty.isBlank();      // true
whitespace.isBlank(); // true
content.isBlank();    // false

// ä¸ isEmpty() çš„åŒºåˆ«
whitespace.isEmpty(); // false
whitespace.isBlank(); // true
```

**2. lines() æ–¹æ³• (Java 11)**
```java
String multiline = "line1\nline2\r\nline3\rline4";

// æŒ‰è¡Œåˆ†å‰²ï¼Œè‡ªåŠ¨å¤„ç†ä¸åŒçš„æ¢è¡Œç¬¦
List<String> lines = multiline.lines()
        .collect(Collectors.toList());
// ç»“æœ: [line1, line2, line3, line4]
```

**3. strip() ç³»åˆ—æ–¹æ³• (Java 11)**
```java
String padded = "   hello world   ";

// æ¯” trim() æ›´å¼ºå¤§çš„ç©ºç™½å­—ç¬¦å¤„ç†
String stripped = padded.strip();          // "hello world"
String leading = padded.stripLeading();    // "hello world   "
String trailing = padded.stripTrailing();  // "   hello world"

// ä¸ trim() çš„åŒºåˆ«ï¼šæ”¯æŒ Unicode ç©ºç™½å­—ç¬¦
String unicode = "\u2000hello\u2000";  // Unicode ç©ºæ ¼
String trimmed = unicode.trim();        // å¯èƒ½æ— æ³•æ­£ç¡®å¤„ç†
String stripped = unicode.strip();      // æ­£ç¡®å¤„ç† Unicode ç©ºæ ¼
```

**4. repeat() æ–¹æ³• (Java 11)**
```java
String pattern = "=";
String separator = pattern.repeat(20);    // "===================="

String greeting = "Hello! ";
String repeated = greeting.repeat(3);     // "Hello! Hello! Hello! "
```

**5. transform() æ–¹æ³• (Java 12)**
```java
String text = "  Hello World  ";

// é“¾å¼å˜æ¢ï¼Œå¢å¼ºå¯è¯»æ€§
String transformed = text.transform(String::strip)
                         .transform(String::toLowerCase)
                         .transform(s -> s.replace(" ", "_"));
// ç»“æœ: "hello_world"
```

**6. formatted() æ–¹æ³• (Java 15)**
```java
String name = "Alice";
int age = 30;

// æ›´æµç•…çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–
String formatted = "Name: %s, Age: %d".formatted(name, age);
// ç­‰ä»·äº String.format("Name: %s, Age: %d", name, age)
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. æ—¥å¿—å¤„ç†**
```java
String logData = """
    2024-01-01 10:00:00 INFO Application started
    2024-01-01 10:00:01 DEBUG Loading configuration
    2024-01-01 10:00:02 ERROR Failed to connect to database
    2024-01-01 10:00:03 INFO Retrying connection
    2024-01-01 10:00:04 INFO Database connected successfully
    """;

// æå–é”™è¯¯æ—¥å¿—ï¼Œç›´åˆ°æ•°æ®åº“è¿æ¥æˆåŠŸ
List<String> errorLogs = logData.lines()
        .map(String::strip)
        .filter(line -> !line.isBlank())
        .takeWhile(line -> !line.contains("Database connected"))
        .filter(line -> line.contains("ERROR"))
        .collect(Collectors.toList());
```

**2. é…ç½®å¤„ç†**
```java
Map<String, String> config = Map.of(
    "database.url", "jdbc:mysql://localhost:3306/mydb",
    "database.username", "admin",
    "database.password", "",
    "app.name", "MyApplication"
);

// å®‰å…¨åœ°æ£€æŸ¥é…ç½®é¡¹
Optional<String> dbPassword = Optional.ofNullable(config.get("database.password"))
        .filter(pwd -> !pwd.isBlank());

dbPassword.ifPresentOrElse(
    pwd -> System.out.println("æ•°æ®åº“å¯†ç å·²é…ç½®"),
    () -> System.out.println("è­¦å‘Š: æ•°æ®åº“å¯†ç æœªé…ç½®")
);
```

**3. æ•°æ®éªŒè¯**
```java
List<String> userInputs = List.of(
    "alice@example.com",
    "",
    "   ",
    "bob@test.com",
    "invalid-email",
    "charlie@domain.org"
);

// è¿‡æ»¤å¹¶éªŒè¯é‚®ç®±åœ°å€
List<String> validEmails = userInputs.stream()
        .filter(input -> !input.isBlank())
        .map(String::strip)
        .filter(email -> email.contains("@") && email.contains("."))
        .collect(Collectors.toList());
```

**4. æŠ¥å‘Šç”Ÿæˆ**
```java
List<String> items = List.of("é¡¹ç›®A", "é¡¹ç›®B", "é¡¹ç›®C");

// ä½¿ç”¨ transform å’Œ repeat ç”Ÿæˆæ ¼å¼åŒ–æŠ¥å‘Š
String report = "æŠ¥å‘Šæ ‡é¢˜".transform(title -> 
    "=".repeat(20) + "\n" + 
    title + "\n" + 
    "=".repeat(20) + "\n"
) + items.stream()
    .map(item -> "- " + item)
    .collect(Collectors.joining("\n")) + "\n" +
    "=".repeat(20);
```

**5. æµå¼æ•°æ®å¤„ç†**
```java
// å¤„ç†åˆ†é¡µæ•°æ®ï¼Œç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°
List<String> processedData = dataStream
        .takeWhile(data -> !data.equals("END"))
        .map(String::strip)
        .filter(data -> !data.isBlank())
        .collect(Collectors.toList());
```

#### å…¶ä»–é‡è¦çš„ API å¢å¼º

**1. CompletableFuture å¢å¼º (Java 9+)**
```java
// è¶…æ—¶å¤„ç†
CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
    // é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
    return "result";
}).orTimeout(5, TimeUnit.SECONDS);

// å»¶è¿Ÿæ‰§è¡Œ
CompletableFuture<String> delayed = CompletableFuture
        .delayedExecutor(2, TimeUnit.SECONDS)
        .execute(() -> System.out.println("Delayed execution"));
```

**2. Process API å¢å¼º (Java 9)**
```java
// è·å–å½“å‰è¿›ç¨‹ä¿¡æ¯
ProcessHandle current = ProcessHandle.current();
ProcessHandle.Info info = current.info();

System.out.println("PID: " + current.pid());
System.out.println("å‘½ä»¤: " + info.command().orElse("Unknown"));
System.out.println("ç”¨æˆ·: " + info.user().orElse("Unknown"));
```

#### æœ€ä½³å®è·µ

**1. ä¼˜å…ˆä½¿ç”¨æ–°çš„ API**
```java
// å¥½çš„åšæ³•
String result = input.strip();
if (!input.isBlank()) {
    // å¤„ç†é€»è¾‘
}

// é¿å…çš„åšæ³•
String result = input.trim();
if (!input.isEmpty()) {
    // å¤„ç†é€»è¾‘
}
```

**2. åˆç†ä½¿ç”¨ takeWhile/dropWhile**
```java
// é€‚åˆä½¿ç”¨ takeWhile çš„åœºæ™¯ï¼šæœ‰åºæ•°æ®çš„å‰ç¼€å¤„ç†
List<Integer> scores = List.of(95, 88, 92, 76, 84, 90);
List<Integer> excellentScores = scores.stream()
        .sorted(Comparator.reverseOrder())
        .takeWhile(score -> score >= 90)
        .collect(Collectors.toList());
```

**3. é“¾å¼æ“ä½œçš„å¯è¯»æ€§**
```java
// ä½¿ç”¨ transform æé«˜å¯è¯»æ€§
String result = input
        .transform(String::strip)
        .transform(String::toLowerCase)
        .transform(s -> s.replace(" ", "_"));

// è€Œä¸æ˜¯åµŒå¥—è°ƒç”¨
String result = input.strip().toLowerCase().replace(" ", "_");
```

#### æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

1. **ç®€æ´æ€§**: å‡å°‘æ ·æ¿ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡
2. **ç›´è§‚æ€§**: API è®¾è®¡æ›´åŠ ç›´è§‚ï¼Œæ˜“äºç†è§£å’Œä½¿ç”¨
3. **åŠŸèƒ½æ€§**: æä¾›äº†æ›´å¤šå®ç”¨çš„åŠŸèƒ½ï¼Œè¦†ç›–å¸¸è§ä½¿ç”¨åœºæ™¯
4. **ä¸€è‡´æ€§**: ä¿æŒä¸ç°æœ‰ API çš„ä¸€è‡´æ€§ï¼Œå­¦ä¹ æˆæœ¬ä½
5. **æ€§èƒ½**: å¾ˆå¤šæ–°æ–¹æ³•éƒ½ç»è¿‡æ€§èƒ½ä¼˜åŒ–

è¿™äº› API å¢å¼ºè™½ç„¶çœ‹èµ·æ¥æ˜¯å°çš„æ”¹è¿›ï¼Œä½†åœ¨æ—¥å¸¸å¼€å‘ä¸­èƒ½æ˜¾è‘—æå‡ä»£ç çš„å¯è¯»æ€§å’Œå¼€å‘æ•ˆç‡ï¼Œæ˜¯ç°ä»£ Java å¼€å‘çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚

### 17. Stream èšåˆå™¨ (Stream Gatherers) (Java 24, æ­£å¼)

*   **æ¼”è¿›**: Java 22 å¼•å…¥é¢„è§ˆç‰ˆï¼ŒJava 24 æ­£å¼å‘å¸ƒã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›è‡ªå®šä¹‰ Stream ä¸­é—´æ“ä½œçš„èƒ½åŠ›ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿåˆ›å»ºå¤æ‚çš„ã€æœ‰çŠ¶æ€çš„æµå¤„ç†é€»è¾‘ã€‚

#### æ ¸å¿ƒæ¦‚å¿µ

Stream Gatherers æ˜¯ä¸€ç§æ–°çš„ Stream æ“ä½œç±»å‹ï¼Œå®ƒå…è®¸å¼€å‘è€…åˆ›å»ºè‡ªå®šä¹‰çš„ä¸­é—´æ“ä½œã€‚ä¸ç°æœ‰çš„ `map()`, `filter()`, `reduce()` ç­‰æ“ä½œç›¸æ¯”ï¼ŒGatherers æä¾›äº†æ›´é«˜çš„çµæ´»æ€§å’Œè‡ªå®šä¹‰èƒ½åŠ›ã€‚

```java
// åŸºæœ¬è¯­æ³•
stream.gather(gatherer).collect(collector)

// ç­‰ä»·äºä¼ ç»Ÿçš„
stream.someCustomOperation().collect(collector)
```

#### ä¸ Collector çš„åŒºåˆ«

| ç‰¹æ€§ | Collector | Gatherer |
|------|-----------|----------|
| **ä½œç”¨é˜¶æ®µ** | ç»ˆç»“æ“ä½œ | ä¸­é—´æ“ä½œ |
| **æ•°æ®æµå‘** | å¤šå¯¹ä¸€ | ä¸€å¯¹å¤šæˆ–å¤šå¯¹å¤š |
| **çŠ¶æ€ç®¡ç†** | ç´¯ç§¯çŠ¶æ€ | æµå¼çŠ¶æ€ |
| **ç»„åˆæ€§** | æœ‰é™ | é«˜åº¦å¯ç»„åˆ |
| **æ— é™æµæ”¯æŒ** | ä¸æ”¯æŒ | æ”¯æŒ |

#### å†…ç½® Gatherers

**1. æ»‘åŠ¨çª—å£ (sliding)**
```java
// æ»‘åŠ¨çª—å£å¤„ç†
List<Integer> numbers = List.of(1, 2, 3, 4, 5, 6, 7, 8);

List<List<Integer>> windows = numbers.stream()
        .gather(Gatherers.sliding(3))
        .collect(Collectors.toList());
// ç»“æœ: [[1,2,3], [2,3,4], [3,4,5], [4,5,6], [5,6,7], [6,7,8]]
```

**2. å›ºå®šçª—å£ (windowed)**
```java
// å›ºå®šå¤§å°çª—å£
List<List<Integer>> fixedWindows = numbers.stream()
        .gather(Gatherers.windowed(3))
        .collect(Collectors.toList());
// ç»“æœ: [[1,2,3], [4,5,6], [7,8]]
```

**3. æ‰«æ (scan)**
```java
// ç´¯ç§¯è®¡ç®—
List<Integer> nums = List.of(1, 2, 3, 4, 5);

List<Integer> cumulativeSum = nums.stream()
        .gather(Gatherers.scan(0, Integer::sum))
        .collect(Collectors.toList());
// ç»“æœ: [0, 1, 3, 6, 10, 15]
```

**4. å»é‡ (distinct)**
```java
// åŸºäºè‡ªå®šä¹‰é”®çš„å»é‡
List<Person> people = List.of(
    new Person("Alice", 25),
    new Person("Bob", 30),
    new Person("Alice", 28)  // é‡å¤çš„åå­—
);

List<Person> distinctByName = people.stream()
        .gather(Gatherers.distinct(Person::getName))
        .collect(Collectors.toList());
// ç»“æœ: [Person("Alice", 25), Person("Bob", 30)]
```

#### è‡ªå®šä¹‰ Gatherers

**1. åŸºæœ¬ç»“æ„**
```java
// è‡ªå®šä¹‰ Gatherer çš„åŸºæœ¬ç»“æ„
public static <T, R> Gatherer<T, ?, R> myGatherer() {
    return Gatherer.of(
        supplier,     // çŠ¶æ€åˆå§‹åŒ–
        integrator,   // å…ƒç´ å¤„ç†é€»è¾‘
        finisher      // æœ€ç»ˆå¤„ç†ï¼ˆå¯é€‰ï¼‰
    );
}
```

**2. æ‰¹å¤„ç† Gatherer**
```java
// è‡ªå®šä¹‰æ‰¹å¤„ç† Gatherer
public static <T> Gatherer<T, ?, List<T>> batching(int batchSize) {
    return Gatherer.of(
        // çŠ¶æ€åˆå§‹åŒ–ï¼šåˆ›å»ºä¸€ä¸ª ArrayList æ¥å­˜å‚¨å½“å‰æ‰¹æ¬¡
        ArrayList::new,
        
        // å…ƒç´ å¤„ç†é€»è¾‘
        (batch, element, downstream) -> {
            batch.add(element);
            if (batch.size() == batchSize) {
                // æ‰¹æ¬¡æ»¡äº†ï¼Œå‘é€åˆ°ä¸‹æ¸¸å¹¶æ¸…ç©º
                downstream.push(new ArrayList<>(batch));
                batch.clear();
            }
            return true; // ç»§ç»­å¤„ç†
        },
        
        // æœ€ç»ˆå¤„ç†ï¼šå‘é€å‰©ä½™çš„å…ƒç´ 
        (batch, downstream) -> {
            if (!batch.isEmpty()) {
                downstream.push(batch);
            }
        }
    );
}

// ä½¿ç”¨ç¤ºä¾‹
List<Integer> numbers = List.of(1, 2, 3, 4, 5, 6, 7, 8, 9);
List<List<Integer>> batches = numbers.stream()
        .gather(batching(3))
        .collect(Collectors.toList());
// ç»“æœ: [[1,2,3], [4,5,6], [7,8,9]]
```

**3. ç§»åŠ¨å¹³å‡ Gatherer**
```java
// ç§»åŠ¨å¹³å‡è®¡ç®—
public static Gatherer<Double, ?, Double> movingAverage(int windowSize) {
    return Gatherer.of(
        // çŠ¶æ€ï¼šä½¿ç”¨å¾ªç¯ç¼“å†²åŒºå­˜å‚¨çª—å£æ•°æ®
        () -> new MovingAverageState(windowSize),
        
        // å¤„ç†é€»è¾‘
        (state, element, downstream) -> {
            state.add(element);
            if (state.isFull()) {
                downstream.push(state.getAverage());
            }
            return true;
        }
    );
}

// ä½¿ç”¨ç¤ºä¾‹
List<Double> prices = List.of(100.0, 102.0, 101.0, 103.0, 105.0, 104.0, 106.0);
List<Double> movingAvg = prices.stream()
        .gather(movingAverage(3))
        .collect(Collectors.toList());
// ç»“æœ: [101.0, 102.0, 103.0, 104.0, 105.0]
```

**4. çŠ¶æ€æœº Gatherer**
```java
// çŠ¶æ€æœºå¤„ç†
public static <T> Gatherer<T, ?, StateTransition<T>> stateMachine(
        StateMachine<T> machine) {
    return Gatherer.of(
        // åˆå§‹çŠ¶æ€
        machine::getInitialState,
        
        // çŠ¶æ€è½¬æ¢
        (currentState, input, downstream) -> {
            StateTransition<T> transition = machine.process(currentState, input);
            downstream.push(transition);
            return true;
        }
    );
}

// ä½¿ç”¨ç¤ºä¾‹
List<String> events = List.of("START", "PROCESS", "ERROR", "RETRY", "SUCCESS");
List<StateTransition<String>> transitions = events.stream()
        .gather(stateMachine(new WorkflowStateMachine()))
        .collect(Collectors.toList());
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. æ•°æ®åˆ†æ**
```java
// å®æ—¶æ•°æ®æµåˆ†æ
public class DataAnalyzer {
    // å¼‚å¸¸æ£€æµ‹ Gatherer
    public static Gatherer<Double, ?, Alert> anomalyDetector(double threshold) {
        return Gatherer.of(
            () -> new AnomalyDetectorState(threshold),
            (state, value, downstream) -> {
                if (state.isAnomaly(value)) {
                    downstream.push(new Alert("å¼‚å¸¸å€¼æ£€æµ‹", value));
                }
                state.update(value);
                return true;
            }
        );
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void analyzeData(Stream<Double> dataStream) {
        List<Alert> alerts = dataStream
                .gather(anomalyDetector(2.0))
                .collect(Collectors.toList());
    }
}
```

**2. å®æ—¶æµå¤„ç†**
```java
// äº‹ä»¶çª—å£å¤„ç†
public class EventProcessor {
    public static <T> Gatherer<T, ?, List<T>> timeWindow(Duration duration) {
        return Gatherer.of(
            () -> new TimeWindowState<T>(duration),
            (state, event, downstream) -> {
                state.add(event);
                if (state.shouldFlush()) {
                    downstream.push(state.getAndClearEvents());
                }
                return true;
            }
        );
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void processEvents(Stream<Event> eventStream) {
        eventStream
                .gather(timeWindow(Duration.ofMinutes(5)))
                .forEach(this::processEventBatch);
    }
}
```

**3. æ‰¹é‡æ•°æ®å¤„ç†**
```java
// æ•°æ®åº“æ‰¹é‡æ“ä½œ
public class DatabaseProcessor {
    public static <T> Gatherer<T, ?, Void> batchInsert(
            int batchSize, Consumer<List<T>> insertOperation) {
        return Gatherer.of(
            ArrayList::new,
            (batch, item, downstream) -> {
                batch.add(item);
                if (batch.size() >= batchSize) {
                    insertOperation.accept(new ArrayList<>(batch));
                    batch.clear();
                }
                return true;
            },
            (batch, downstream) -> {
                if (!batch.isEmpty()) {
                    insertOperation.accept(batch);
                }
            }
        );
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void saveUsers(Stream<User> userStream) {
        userStream
                .gather(batchInsert(1000, this::batchInsertUsers))
                .collect(Collectors.toList());
    }
}
```

**4. æ•°æ®è½¬æ¢ç®¡é“**
```java
// ETL å¤„ç†ç®¡é“
public class ETLProcessor {
    public static <T> Gatherer<T, ?, T> validate(Predicate<T> validator) {
        return Gatherer.of(
            () -> null,
            (state, item, downstream) -> {
                if (validator.test(item)) {
                    downstream.push(item);
                } else {
                    // è®°å½•éªŒè¯å¤±è´¥çš„é¡¹ç›®
                    logValidationFailure(item);
                }
                return true;
            }
        );
    }
    
    public static <T, R> Gatherer<T, ?, R> transform(Function<T, R> transformer) {
        return Gatherer.of(
            () -> null,
            (state, item, downstream) -> {
                try {
                    R transformed = transformer.apply(item);
                    downstream.push(transformed);
                } catch (Exception e) {
                    logTransformationError(item, e);
                }
                return true;
            }
        );
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void processData(Stream<RawData> dataStream) {
        List<ProcessedData> results = dataStream
                .gather(validate(this::isValidData))
                .gather(transform(this::transformData))
                .gather(batching(100))
                .flatMap(List::stream)
                .collect(Collectors.toList());
    }
}
```

#### æ€§èƒ½ä¼˜åŒ–

**1. å†…å­˜æ•ˆç‡**
```java
// å†…å­˜é«˜æ•ˆçš„æ»‘åŠ¨çª—å£
public static <T> Gatherer<T, ?, List<T>> efficientSlidingWindow(int size) {
    return Gatherer.of(
        () -> new CircularBuffer<T>(size),  // ä½¿ç”¨å¾ªç¯ç¼“å†²åŒº
        (buffer, element, downstream) -> {
            buffer.add(element);
            if (buffer.isFull()) {
                downstream.push(buffer.toList());
            }
            return true;
        }
    );
}
```

**2. å¹¶è¡Œå¤„ç†æ”¯æŒ**
```java
// æ”¯æŒå¹¶è¡Œå¤„ç†çš„ Gatherer
public static <T> Gatherer<T, ?, T> parallelProcessor(
        Function<T, T> processor, int parallelism) {
    return Gatherer.of(
        () -> new ParallelProcessorState<T>(processor, parallelism),
        (state, item, downstream) -> {
            CompletableFuture<T> future = state.processAsync(item);
            future.thenAccept(downstream::push);
            return true;
        }
    );
}
```

#### ä¸ç°æœ‰ API çš„äº’æ“ä½œ

**1. ä¸ Collector ç»„åˆ**
```java
// Gatherer ä¸ Collector çš„ç»„åˆä½¿ç”¨
Map<String, List<Integer>> groupedBatches = numbers.stream()
        .gather(batching(3))
        .collect(Collectors.groupingBy(
            batch -> "batch_" + batch.size()
        ));
```

**2. ä¸å…¶ä»– Stream æ“ä½œç»„åˆ**
```java
// å¤æ‚çš„å¤„ç†ç®¡é“
List<Double> result = dataStream
        .filter(x -> x > 0)
        .gather(movingAverage(5))
        .map(Math::sqrt)
        .gather(anomalyDetector(2.0))
        .map(Alert::getValue)
        .collect(Collectors.toList());
```

#### æœ€ä½³å®è·µ

**1. çŠ¶æ€ç®¡ç†**
```java
// æ­£ç¡®çš„çŠ¶æ€ç®¡ç†
public static <T> Gatherer<T, ?, T> statefulProcessor() {
    return Gatherer.of(
        // æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„çŠ¶æ€å®ä¾‹
        ProcessorState::new,
        
        // çŠ¶æ€åº”è¯¥æ˜¯çº¿ç¨‹å®‰å…¨çš„æˆ–æ¯ä¸ªå®ä¾‹ç‹¬ç«‹çš„
        (state, item, downstream) -> {
            state.process(item);
            downstream.push(state.getResult());
            return true;
        }
    );
}
```

**2. é”™è¯¯å¤„ç†**
```java
// å¥å£®çš„é”™è¯¯å¤„ç†
public static <T> Gatherer<T, ?, T> resilientProcessor() {
    return Gatherer.of(
        () -> new ProcessorState(),
        (state, item, downstream) -> {
            try {
                T result = state.process(item);
                downstream.push(result);
                return true;
            } catch (Exception e) {
                // è®°å½•é”™è¯¯ä½†ç»§ç»­å¤„ç†
                logError(item, e);
                return true;
            }
        }
    );
}
```

**3. èµ„æºç®¡ç†**
```java
// æ­£ç¡®çš„èµ„æºç®¡ç†
public static <T> Gatherer<T, ?, T> resourceManagedProcessor() {
    return Gatherer.of(
        ResourceState::new,
        (state, item, downstream) -> {
            T result = state.process(item);
            downstream.push(result);
            return true;
        },
        // ç¡®ä¿èµ„æºè¢«æ­£ç¡®é‡Šæ”¾
        (state, downstream) -> {
            state.close();
        }
    );
}
```

#### æ ¸å¿ƒä¼˜åŠ¿

1. **é«˜åº¦å¯å®šåˆ¶**: å¯ä»¥åˆ›å»ºå¤æ‚çš„ã€æœ‰çŠ¶æ€çš„æµå¤„ç†é€»è¾‘
2. **å†…å­˜æ•ˆç‡**: æ”¯æŒæµå¼å¤„ç†ï¼Œä¸éœ€è¦å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜
3. **å¯ç»„åˆæ€§**: å¯ä»¥ä¸å…¶ä»– Stream æ“ä½œæ— ç¼ç»„åˆ
4. **æ— é™æµæ”¯æŒ**: å¯ä»¥å¤„ç†æ— é™æ•°æ®æµ
5. **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
6. **æ€§èƒ½ä¼˜åŒ–**: ä¸“ä¸ºé«˜æ€§èƒ½æµå¤„ç†è®¾è®¡

Stream Gatherers ä¸º Java çš„æµå¤„ç†èƒ½åŠ›å¸¦æ¥äº†é©å‘½æ€§çš„æå‡ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥æ„å»ºæ›´åŠ å¤æ‚å’Œé«˜æ•ˆçš„æ•°æ®å¤„ç†ç®¡é“ã€‚å®ƒæ˜¯ç°ä»£ Java æµå¤„ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç‰¹åˆ«é€‚åˆå¤§æ•°æ®å¤„ç†ã€å®æ—¶åˆ†æå’Œå¤æ‚çš„æ•°æ®è½¬æ¢åœºæ™¯ã€‚

---

[**ğŸ”™ è¿”å›ç›®å½•**](#ğŸ“‹-è¯¦ç»†ç›®å½•)

---

## å››ã€ JVM ä¸åº•å±‚

### 18. æ¨¡å—åŒ–ç³»ç»Ÿ (Project Jigsaw) (Java 9)

*   **æ¼”è¿›**: Java 9 æ­£å¼å¼•å…¥ï¼Œæ˜¯ Java å†å²ä¸Šæœ€é‡è¦çš„æ¶æ„æ”¹è¿›ä¹‹ä¸€ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›æ¨¡å—åŒ–çš„ä»£ç ç»„ç»‡æ–¹å¼ï¼Œå®ç°å¼ºå°è£…ã€å¯é é…ç½®å’Œå¯æ‰©å±•æ€§ã€‚

#### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

**1. ä¼ ç»Ÿ Classpath çš„é—®é¢˜**
 1. ç±»è·¯å¾„åœ°ç‹±ï¼šæ‰€æœ‰JARæ–‡ä»¶å¹³é“ºåœ¨classpathä¸Š
 2. åŒ…å†²çªï¼šå¤šä¸ªJARåŒ…å«ç›¸åŒçš„ç±»ï¼Œä½¿ç”¨"å…ˆæ‰¾åˆ°çš„"è§„åˆ™
 3. è¿è¡Œæ—¶ä¾èµ–é”™è¯¯ï¼šç¼ºå°‘JARåŒ…æ—¶è¿è¡Œæ—¶æ‰å‘ç°
 4. æ— å°è£…æ€§ï¼šæ‰€æœ‰publicç±»éƒ½å¯ä»¥è¢«è®¿é—®
 5. å·¨å¤§çš„è¿è¡Œæ—¶ï¼šå³ä½¿ç®€å•åº”ç”¨ä¹Ÿéœ€è¦å®Œæ•´çš„JRE

**2. ä¾èµ–ç®¡ç†å¤æ‚æ€§**
 ä¼ ç»Ÿçš„ä¾èµ–ç®¡ç†é—®é¢˜
 - ä¼ é€’æ€§ä¾èµ–ä¸æ˜ç¡®
 - ç‰ˆæœ¬å†²çªéš¾ä»¥è§£å†³
 - å¾ªç¯ä¾èµ–æ£€æµ‹å›°éš¾
 - æœªä½¿ç”¨çš„ä¾èµ–éš¾ä»¥æ¸…ç†

#### æ¨¡å—ç³»ç»Ÿæ ¸å¿ƒæ¦‚å¿µ

**1. æ¨¡å—å£°æ˜æ–‡ä»¶ (module-info.java)**
```java
// åŸºæœ¬æ¨¡å—å£°æ˜
module com.example.myapp {
    // ä¾èµ–å£°æ˜
    requires java.base;          // éšå¼ä¾èµ–ï¼Œå¯çœç•¥
    requires java.logging;       // æ˜¾å¼ä¾èµ–
    requires transitive java.sql;  // ä¼ é€’æ€§ä¾èµ–
    
    // å¯¼å‡ºåŒ…
    exports com.example.myapp.api;
    exports com.example.myapp.util to com.example.client;
    
    // å¼€æ”¾åŒ…ç”¨äºåå°„
    opens com.example.myapp.internal to com.fasterxml.jackson.databind;
    opens com.example.myapp.entity;
    
    // æœåŠ¡æä¾›å’Œä½¿ç”¨
    provides com.example.myapp.spi.Service 
        with com.example.myapp.impl.ServiceImpl;
    uses com.example.myapp.spi.Service;
}
```

**2. æ¨¡å—æŒ‡ä»¤è¯¦è§£**

| æŒ‡ä»¤ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| `requires` | å£°æ˜å¯¹å…¶ä»–æ¨¡å—çš„ä¾èµ– | `requires java.logging;` |
| `requires transitive` | ä¼ é€’æ€§ä¾èµ– | `requires transitive java.sql;` |
| `exports` | å¯¼å‡ºåŒ…ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ | `exports com.example.api;` |
| `exports...to` | é™å®šå¯¼å‡ºç»™ç‰¹å®šæ¨¡å— | `exports com.example.internal to com.example.test;` |
| `opens` | å¼€æ”¾åŒ…ç”¨äºåå°„è®¿é—® | `opens com.example.entity;` |
| `opens...to` | é™å®šå¼€æ”¾ç»™ç‰¹å®šæ¨¡å— | `opens com.example.config to spring.core;` |
| `uses` | å£°æ˜ä½¿ç”¨æŸä¸ªæœåŠ¡ | `uses com.example.spi.Service;` |
| `provides...with` | æä¾›æœåŠ¡å®ç° | `provides Service with ServiceImpl;` |

#### æ¨¡å—ç±»å‹

**1. ç³»ç»Ÿæ¨¡å—**
```java
// JDK å†…ç½®æ¨¡å—
java.base          // åŸºç¡€æ¨¡å—ï¼Œæ‰€æœ‰æ¨¡å—éšå¼ä¾èµ–
java.logging       // æ—¥å¿—æ¨¡å—
java.sql           // æ•°æ®åº“æ¨¡å—
java.xml           // XML å¤„ç†æ¨¡å—
java.net.http      // HTTP å®¢æˆ·ç«¯æ¨¡å—
java.desktop       // æ¡Œé¢åº”ç”¨æ¨¡å—
```

**2. åº”ç”¨æ¨¡å—**
```java
// ç”¨æˆ·å®šä¹‰çš„æ¨¡å—
module com.example.service {
    requires java.base;
    requires java.logging;
    
    exports com.example.service.api;
}
```

**3. è‡ªåŠ¨æ¨¡å—**
```java
// å°†ä¼ ç»ŸJARä½œä¸ºæ¨¡å—ä½¿ç”¨
// JARæ–‡ä»¶åï¼šmysql-connector-java-8.0.28.jar
// è‡ªåŠ¨æ¨¡å—åï¼šmysql.connector.java
module com.example.app {
    requires mysql.connector.java;  // è‡ªåŠ¨æ¨¡å—
}
```

**4. æœªå‘½åæ¨¡å—**
```java
// ä¼ ç»Ÿclasspathä¸Šçš„æ‰€æœ‰ç±»
// å½“å‰é¡¹ç›®å°±æ˜¯æœªå‘½åæ¨¡å—
// å¯ä»¥è®¿é—®æ‰€æœ‰å¯¼å‡ºçš„åŒ…å’Œclasspathä¸Šçš„ç±»
```

#### å¼ºå°è£…æœºåˆ¶

**1. åŒ…çº§åˆ«çš„å°è£…**
```java
// æ¨¡å—A
module com.example.modulea {
    exports com.example.modulea.api;        // å…¬å¼€API
    // com.example.modulea.internal ä¸å¯¼å‡ºï¼Œå¤–éƒ¨æ— æ³•è®¿é—®
}

// æ¨¡å—B
module com.example.moduleb {
    requires com.example.modulea;
    
    // å¯ä»¥è®¿é—®
    import com.example.modulea.api.PublicClass;
    
    // ç¼–è¯‘é”™è¯¯ï¼šæ— æ³•è®¿é—®
    // import com.example.modulea.internal.InternalClass;
}
```

**2. åå°„è®¿é—®æ§åˆ¶**
```java
module com.example.entity {
    // å¼€æ”¾ç»™æ¡†æ¶ä½¿ç”¨
    opens com.example.entity.model to 
        com.fasterxml.jackson.databind,
        org.hibernate.orm.core;
    
    // å®Œå…¨å¼€æ”¾
    opens com.example.entity.dto;
}
```

#### æœåŠ¡åŠ è½½æœºåˆ¶

**1. æœåŠ¡æ¥å£å®šä¹‰**
```java
// æœåŠ¡æ¥å£æ¨¡å—
module com.example.service.api {
    exports com.example.service.api;
}

// æœåŠ¡æ¥å£
package com.example.service.api;
public interface DataProcessor {
    void process(String data);
}
```

**2. æœåŠ¡å®ç°**
```java
// æœåŠ¡å®ç°æ¨¡å—
module com.example.service.impl {
    requires com.example.service.api;
    
    provides com.example.service.api.DataProcessor
        with com.example.service.impl.JsonProcessor,
             com.example.service.impl.XmlProcessor;
}
```

**3. æœåŠ¡æ¶ˆè´¹**
```java
// æœåŠ¡æ¶ˆè´¹æ¨¡å—
module com.example.client {
    requires com.example.service.api;
    uses com.example.service.api.DataProcessor;
}

// æœåŠ¡ä½¿ç”¨
ServiceLoader<DataProcessor> loader = ServiceLoader.load(DataProcessor.class);
for (DataProcessor processor : loader) {
    processor.process(data);
}
```

#### ç¼–è¯‘å’Œè¿è¡Œ

**1. æ¨¡å—åŒ–ç¼–è¯‘**
```bash
# é¡¹ç›®ç»“æ„
src/
â”œâ”€â”€ com.example.service/
â”‚   â”œâ”€â”€ module-info.java
â”‚   â””â”€â”€ com/example/service/
â”œâ”€â”€ com.example.client/
â”‚   â”œâ”€â”€ module-info.java
â”‚   â””â”€â”€ com/example/client/

# ç¼–è¯‘
javac -d out \
  --module-source-path src \
  src/com.example.service/module-info.java \
  src/com.example.service/com/example/service/*.java \
  src/com.example.client/module-info.java \
  src/com.example.client/com/example/client/*.java
```

**2. æ¨¡å—åŒ–è¿è¡Œ**
```bash
# è¿è¡Œæ¨¡å—
java --module-path out \
  --module com.example.client/com.example.client.Main

# æ·»åŠ æ¨¡å—åˆ°å¯åŠ¨æ—¶
java --module-path out \
  --add-modules com.example.service \
  --module com.example.client/com.example.client.Main
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. å¾®æœåŠ¡æ¶æ„**
```java
// è®¢å•æœåŠ¡æ¨¡å—
module com.company.order.service {
    requires com.company.common.api;
    requires java.net.http;
    
    exports com.company.order.api;
    
    provides com.company.common.api.Service
        with com.company.order.service.OrderService;
}

// ç”¨æˆ·æœåŠ¡æ¨¡å—
module com.company.user.service {
    requires com.company.common.api;
    requires java.sql;
    
    exports com.company.user.api;
    
    provides com.company.common.api.Service
        with com.company.user.service.UserService;
}
```

**2. åº“çš„æ¨¡å—åŒ–**
```java
// å·¥å…·åº“æ ¸å¿ƒæ¨¡å—
module com.company.utils.core {
    exports com.company.utils.core.string;
    exports com.company.utils.core.collection;
}

// å·¥å…·åº“æ‰©å±•æ¨¡å—
module com.company.utils.json {
    requires com.company.utils.core;
    requires com.fasterxml.jackson.databind;
    
    exports com.company.utils.json;
}
```

**3. æ’ä»¶ç³»ç»Ÿ**
```java
// æ’ä»¶æ¥å£
module com.app.plugin.api {
    exports com.app.plugin.api;
}

// æ’ä»¶å®ç°
module com.app.plugin.image {
    requires com.app.plugin.api;
    
    provides com.app.plugin.api.Plugin
        with com.app.plugin.image.ImagePlugin;
}

// ä¸»åº”ç”¨
module com.app.main {
    requires com.app.plugin.api;
    uses com.app.plugin.api.Plugin;
}
```

#### ä¸ Spring Boot çš„é›†æˆ

**1. Spring Boot æ¨¡å—åŒ–æ”¯æŒ**
```java
// Spring Boot åº”ç”¨æ¨¡å—
module com.example.springapp {
    requires spring.boot;
    requires spring.boot.autoconfigure;
    requires spring.web;
    requires spring.data.jpa;
    
    // å¼€æ”¾ç»™ Spring æ¡†æ¶
    opens com.example.springapp.controller to spring.core;
    opens com.example.springapp.service to spring.core;
    opens com.example.springapp.entity to 
        spring.core,
        org.hibernate.orm.core;
    
    exports com.example.springapp.api;
}
```

**2. è‡ªåŠ¨é…ç½®å¤„ç†**
```java
// Spring Boot éœ€è¦ç‰¹æ®Šå¤„ç†
// 1. å¼€æ”¾åŒ…ç»™ Spring æ¡†æ¶
// 2. å¤„ç†è‡ªåŠ¨é…ç½®çš„åå°„è®¿é—®
// 3. é…ç½®ç±»è·¯å¾„æ‰«æ
```

#### è¿ç§»ç­–ç•¥

**1. è‡ªä¸‹è€Œä¸Šè¿ç§»**
```java
// ç¬¬ä¸€æ­¥ï¼šæ¨¡å—åŒ–ä¾èµ–åº“
module com.company.common {
    exports com.company.common.api;
    exports com.company.common.util;
}

// ç¬¬äºŒæ­¥ï¼šæ¨¡å—åŒ–åº”ç”¨å±‚
module com.company.app {
    requires com.company.common;
    requires java.net.http;
}
```

**2. æ··åˆæ¨¡å¼**
```java
// éƒ¨åˆ†æ¨¡å—åŒ–ï¼šæ–°ä»£ç ä½¿ç”¨æ¨¡å—ï¼Œæ—§ä»£ç ä¿æŒ classpath
java --module-path modules \
     --class-path legacy-libs/*.jar \
     --add-modules com.company.newmodule \
     --module com.company.app/com.company.app.Main
```

**3. è‡ªåŠ¨æ¨¡å—è¿‡æ¸¡**
```java
// å°†ä¼ ç»ŸJARä½œä¸ºè‡ªåŠ¨æ¨¡å—ä½¿ç”¨
module com.company.app {
    requires mysql.connector.java;  // è‡ªåŠ¨æ¨¡å—
    requires spring.boot;           // è‡ªåŠ¨æ¨¡å—
}
```

#### å·¥å…·æ”¯æŒ

**1. jdeps - ä¾èµ–åˆ†æ**
```bash
# åˆ†æJARä¾èµ–
jdeps --class-path libs/*.jar myapp.jar

# ç”Ÿæˆæ¨¡å—ä¿¡æ¯
jdeps --generate-module-info out myapp.jar

# åˆ†ææ¨¡å—ä¾èµ–
jdeps --module-path modules --module com.example.app
```

**2. jlink - è‡ªå®šä¹‰è¿è¡Œæ—¶**
```bash
# åˆ›å»ºè‡ªå®šä¹‰JRE
jlink --module-path modules:$JAVA_HOME/jmods \
      --add-modules com.example.app \
      --output custom-jre

# è¿è¡Œè‡ªå®šä¹‰JRE
./custom-jre/bin/java --module com.example.app/com.example.Main
```

**3. IDE æ”¯æŒ**
- IntelliJ IDEA: å®Œæ•´çš„æ¨¡å—åŒ–æ”¯æŒ
- Eclipse: é€šè¿‡æ’ä»¶æ”¯æŒ
- VS Code: é€šè¿‡æ‰©å±•æ”¯æŒ

#### æœ€ä½³å®è·µ

**1. æ¨¡å—è®¾è®¡åŸåˆ™**
```java
// å•ä¸€èŒè´£ï¼šæ¯ä¸ªæ¨¡å—æœ‰æ˜ç¡®çš„èŒè´£
module com.company.user.service {
    // åªå¤„ç†ç”¨æˆ·ç›¸å…³åŠŸèƒ½
}

// ç¨³å®šæŠ½è±¡ï¼šAPIæ¨¡å—åº”è¯¥ç¨³å®š
module com.company.user.api {
    // åªåŒ…å«æ¥å£å’Œæ•°æ®ä¼ è¾“å¯¹è±¡
}

// æœ€å°ä¾èµ–ï¼šåªä¾èµ–å¿…è¦çš„æ¨¡å—
module com.company.user.impl {
    requires com.company.user.api;
    // é¿å…ä¸å¿…è¦çš„ä¾èµ–
}
```

**2. åŒ…å¯¼å‡ºç­–ç•¥**
```java
module com.company.service {
    // å¯¼å‡º API åŒ…
    exports com.company.service.api;
    
    // æœ‰é€‰æ‹©åœ°å¯¼å‡ºå·¥å…·åŒ…
    exports com.company.service.util to 
        com.company.client,
        com.company.test;
    
    // ä¸å¯¼å‡ºå®ç°åŒ…
    // com.company.service.impl ä¿æŒå†…éƒ¨
}
```

**3. ç‰ˆæœ¬ç®¡ç†**
```java
// ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬
module com.company.service {
    requires com.company.api;  // ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
    
    // é¿å…å¿«ç…§ç‰ˆæœ¬çš„ä¼ é€’ä¾èµ–
    requires transitive com.company.stable.api;
}
```

#### æ€§èƒ½å½±å“

**1. å¯åŠ¨æ—¶é—´**
- æ¨¡å—åŒ–å¯ä»¥å‡å°‘å¯åŠ¨æ—¶é—´
- æ›´å°‘çš„ç±»åŠ è½½å’Œåˆå§‹åŒ–
- æ›´ç²¾ç¡®çš„ä¾èµ–è§£æ

**2. å†…å­˜ä½¿ç”¨**
- å‡å°‘ä¸å¿…è¦çš„ç±»åŠ è½½
- æ›´å¥½çš„å†…å­˜å¸ƒå±€
- è‡ªå®šä¹‰è¿è¡Œæ—¶å‡å°‘å†…å­˜å ç”¨

**3. å®‰å…¨æ€§**
- å¼ºå°è£…æé«˜å®‰å…¨æ€§
- å‡å°‘æ”»å‡»é¢
- æ›´å¥½çš„æƒé™æ§åˆ¶

#### æ ¸å¿ƒä¼˜åŠ¿

1. **å¼ºå°è£…**: æ˜ç¡®çš„æ¨¡å—è¾¹ç•Œå’Œè®¿é—®æ§åˆ¶
2. **å¯é é…ç½®**: ç¼–è¯‘æ—¶ä¾èµ–æ£€æŸ¥
3. **å¯æ‰©å±•æ€§**: æœåŠ¡åŠ è½½æœºåˆ¶æ”¯æŒæ’ä»¶
4. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘è¿è¡Œæ—¶å¤§å°å’Œå¯åŠ¨æ—¶é—´
5. **å®‰å…¨æ€§**: æ›´å¥½çš„å°è£…æ€§å’Œæƒé™æ§åˆ¶

#### æ¨¡å—å¯¼å…¥å£°æ˜ (Java 23 é¢„è§ˆ)

**ä¼ ç»ŸåŒ…å¯¼å…¥çš„ç—›ç‚¹ï¼š**
```java
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;
// ... å½“æ¨¡å—åŒ…å«å‡ åä¸ªåŒ…æ—¶ï¼Œå¯¼å…¥å˜å¾—å†—é•¿
```

**æ¨¡å—å¯¼å…¥å£°æ˜çš„è§£å†³æ–¹æ¡ˆï¼š**
```java
import module java.base;  // ä¸€æ¬¡æ€§å¯¼å…¥æ•´ä¸ªæ¨¡å—çš„æ‰€æœ‰å¯¼å‡ºåŒ…

public class Example {
    public void method() {
        List<String> list = List.of("a", "b");  // ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€é€ä¸ªå¯¼å…¥
        Map<String, Integer> map = Map.of("key", 1);
    }
}
```

**æ¨¡å—å¯¼å…¥çš„ä¼˜åŠ¿ï¼š**
- **ç®€æ´æ€§**ï¼šé¿å…å†—é•¿çš„åŒ…å¯¼å…¥åˆ—è¡¨
- **ä¸€è‡´æ€§**ï¼šç¡®ä¿ä½¿ç”¨æ¨¡å—ä¸­çš„ç›¸å…³ç±»æ—¶ä¿æŒä¸€è‡´
- **ç»´æŠ¤æ€§**ï¼šæ¨¡å—å‡çº§æ—¶å‡å°‘å¯¼å…¥å£°æ˜çš„ç»´æŠ¤å·¥ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**
- ä»…åœ¨ Java 23+ ä½œä¸ºé¢„è§ˆç‰¹æ€§æä¾›
- éœ€è¦å¯ç”¨é¢„è§ˆç‰¹æ€§ï¼š`--enable-preview`
- ä¸èƒ½ä¸é€šé…ç¬¦å¯¼å…¥ï¼ˆ`import java.util.*`ï¼‰æ··ç”¨
- åªèƒ½å¯¼å…¥æ¨¡å—æ˜ç¡®å¯¼å‡ºçš„åŒ…

#### ç¬¬ä¸‰æ–¹åº“çš„æ¨¡å—åŒ–ç°çŠ¶

**âœ… å·²æ”¯æŒæ¨¡å—çš„ä¸»æµåº“ï¼š**

- Spring Framework (5.0+)
- Jackson (2.9+)
- JUnit 5
- SLF4J & Logback

**âš ï¸ å…¼å®¹æ€§è§£å†³æ–¹æ¡ˆï¼š**
```java
module my.app {
    requires spring.boot;           // å·²æ¨¡å—åŒ–çš„åº“
    requires java.sql;              // è‡ªåŠ¨æ¨¡å—ï¼ˆæœªæ¨¡å—åŒ–çš„ JDBC é©±åŠ¨ï¼‰
    requires some.legacy.library;   // é€šè¿‡è‡ªåŠ¨æ¨¡å—æœºåˆ¶ä½¿ç”¨é—ç•™åº“
}
```

#### å®é™…åº”ç”¨å»ºè®®

**ä½•æ—¶ä½¿ç”¨æ¨¡å—ï¼Ÿ**
- âœ… æ–°çš„å¤§å‹é¡¹ç›®ï¼Œç‰¹åˆ«æ˜¯éœ€è¦æ¸…æ™°æ¶æ„è¾¹ç•Œçš„é¡¹ç›®
- âœ… æ„å»ºå¯å¤ç”¨çš„åº“æˆ–æ¡†æ¶
- âœ… å¯¹å®‰å…¨æ€§å’Œå°è£…æ€§è¦æ±‚é«˜çš„ä¼ä¸šåº”ç”¨

**ä½•æ—¶å¯ä»¥ä¸ç”¨æ¨¡å—ï¼Ÿ**
- âœ… ç°æœ‰é¡¹ç›®ï¼ˆè¿ç§»æˆæœ¬é«˜ï¼‰
- âœ… å°å‹é¡¹ç›®æˆ–åŸå‹å¼€å‘
- âœ… å›¢é˜Ÿå¯¹æ¨¡å—ç³»ç»Ÿä¸ç†Ÿæ‚‰çš„æƒ…å†µ

**æ¸è¿›å¼é‡‡ç”¨ç­–ç•¥ï¼š**
```java
// ç¬¬ä¸€æ­¥ï¼šåœ¨ç°æœ‰é¡¹ç›®ä¸­æ·»åŠ  module-info.javaï¼ˆå¯é€‰ï¼‰
module com.example.demo {
    requires spring.boot;
    requires java.sql;
    exports com.example.api;
}

// ç¬¬äºŒæ­¥ï¼šä¿æŒä¼ ç»Ÿå¯¼å…¥æ–¹å¼
import org.springframework.boot.SpringApplication;

// ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®éœ€è¦å°è¯•æ¨¡å—å¯¼å…¥ï¼ˆJava 23+ï¼‰
import module spring.boot.autoconfigure;
```

æ¨¡å—åŒ–ç³»ç»Ÿæ˜¯ Java å¹³å°çš„é‡è¦è¿›æ­¥ï¼ŒJava 23 çš„æ¨¡å—å¯¼å…¥å£°æ˜ä½¿å…¶æ›´åŠ æ˜“ç”¨ã€‚è™½ç„¶å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­ï¼Œä½†ä¸ºå¤§å‹åº”ç”¨æä¾›äº†æ›´å¥½çš„æ¶æ„æ”¯æŒå’Œè¿è¡Œæ—¶ä¼˜åŒ–ã€‚

### 19. æ–°çš„åƒåœ¾æ”¶é›†å™¨ (ZGC & Shenandoah) (Java 15)

* **æ¼”è¿›**: ä¸¤è€…å‡åœ¨ Java 15 æˆä¸ºç”Ÿäº§å¯ç”¨ã€‚
* **æ ¸å¿ƒç†å¿µ**: ç°ä»£çš„ã€å¹¶å‘çš„ã€ä½å»¶è¿Ÿçš„åƒåœ¾æ”¶é›†å™¨ (GC)ã€‚
* **æ ¸å¿ƒä¼˜åŠ¿**: æ—¨åœ¨å°† GC çš„â€œStop-The-Worldâ€ (STW) åœé¡¿æ—¶é—´æ§åˆ¶åœ¨**æ¯«ç§’çº§ç”šè‡³äºšæ¯«ç§’çº§**ï¼Œå¹¶ä¸”è¯¥åœé¡¿æ—¶é—´  **ä¸éšå †å†…å­˜å¤§å°çš„å¢åŠ è€Œæ˜¾è‘—å¢åŠ **ã€‚è¿™è§£å†³äº† G1 ç­‰ä¼ ç»Ÿ GC åœ¨å¤„ç†å¤§å †å†…å­˜æ—¶å¯èƒ½å‡ºç°çš„é•¿æ—¶åœé¡¿é—®é¢˜ã€‚
* **é€‚ç”¨åœºæ™¯**: å¯¹å»¶è¿Ÿæå…¶æ•æ„Ÿã€ä¸”ä½¿ç”¨å¤§å †å†…å­˜ï¼ˆé€šå¸¸ 4GB ä»¥ä¸Šï¼‰çš„åº”ç”¨ã€‚ä¾‹å¦‚ï¼šé‡‘èäº¤æ˜“å¹³å°ã€å®æ—¶æ•°æ®åˆ†æã€å¤§å‹ç”µå•†ç½‘ç«™ã€éœ€è¦ç¨³å®šå“åº”æ—¶é—´çš„å¾®æœåŠ¡ç­‰ã€‚
* **å¦‚ä½•å¯ç”¨**: è¿™æ˜¯é…ç½®å±‚é¢çš„ç‰¹æ€§ï¼Œé€šè¿‡ JVM å¯åŠ¨å‚æ•°å¯ç”¨ã€‚
  * **ZGC**: `java -XX:+UseZGC -jar my-app.jar`
  * **Shenandoah**: `java -XX:+UseShenandoahGC -jar my-app.jar`

### 20. å¤–éƒ¨å‡½æ•°ä¸å†…å­˜ API (Foreign Function & Memory API) (Java 22, æ­£å¼)

*   **æ¼”è¿›**: ç»å†å¤šä¸ªé¢„è§ˆç‰ˆæœ¬åï¼Œåœ¨ Java 22 æˆä¸ºæ­£å¼ç‰¹æ€§ã€‚
*   **æ ¸å¿ƒç†å¿µ**: ä¸º Java ç¨‹åºæä¾›ä¸é Java ä»£ç ï¼ˆå¦‚ C/C++ï¼‰äº¤äº’çš„æ ‡å‡†åŒ–ã€é«˜æ•ˆã€å®‰å…¨çš„æ–¹å¼ã€‚æ›¿ä»£ä¼ ç»Ÿçš„ JNIï¼ˆJava Native Interfaceï¼‰ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **æ€§èƒ½æ›´ä¼˜**: é¿å…äº† JNI çš„å¤§éƒ¨åˆ†å¼€é”€ï¼Œè°ƒç”¨æœ¬åœ°ä»£ç çš„æ€§èƒ½æ¥è¿‘ç›´æ¥è°ƒç”¨ã€‚
    *   **ç±»å‹å®‰å…¨**: åœ¨ç¼–è¯‘æ—¶å°±èƒ½å‘ç°ç±»å‹ä¸åŒ¹é…çš„é”™è¯¯ã€‚
    *   **å†…å­˜ç®¡ç†**: æä¾›ç²¾ç¡®çš„éå †å†…å­˜æ§åˆ¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
    *   **è·¨å¹³å°**: ç»Ÿä¸€çš„ API å¯åœ¨ä¸åŒå¹³å°ä¸Šä½¿ç”¨ã€‚

#### ä¸»è¦ç»„ä»¶

**1. Foreign Function Interface (FFI)**
*   å…è®¸ Java è°ƒç”¨æœ¬åœ°åº“ä¸­çš„å‡½æ•°
*   æ— éœ€ç¼–å†™ JNI ä»£ç ï¼Œç›´æ¥æ˜ å°„æœ¬åœ°å‡½æ•°

**2. Memory API**
*   ç®¡ç†éå †å†…å­˜ï¼ˆoff-heap memoryï¼‰
*   æä¾›å†…å­˜æ®µï¼ˆMemorySegmentï¼‰çš„æ¦‚å¿µ
*   è‡ªåŠ¨å†…å­˜ç®¡ç†å’Œå®‰å…¨è¾¹ç•Œæ£€æŸ¥

#### æ ¸å¿ƒ API ç±»å‹

```java
// ä¸»è¦æ¥å£å’Œç±»
import java.lang.foreign.*;

// 1. MemorySegment - å†…å­˜æ®µ
MemorySegment segment = MemorySegment.allocateNative(1024);

// 2. MemoryLayout - å†…å­˜å¸ƒå±€
MemoryLayout layout = MemoryLayout.structLayout(
    ValueLayout.JAVA_INT.withName("x"),
    ValueLayout.JAVA_INT.withName("y")
);

// 3. Linker - é“¾æ¥å™¨
Linker linker = Linker.nativeLinker();

// 4. FunctionDescriptor - å‡½æ•°æè¿°ç¬¦
FunctionDescriptor descriptor = FunctionDescriptor.of(
    ValueLayout.JAVA_INT,  // è¿”å›ç±»å‹
    ValueLayout.JAVA_INT,  // å‚æ•°ç±»å‹
    ValueLayout.JAVA_INT
);

// 5. SymbolLookup - ç¬¦å·æŸ¥æ‰¾
SymbolLookup lookup = SymbolLookup.loaderLookup();
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. è°ƒç”¨ C æ ‡å‡†åº“å‡½æ•°**
```java
// è°ƒç”¨ C æ ‡å‡†åº“çš„ strlen å‡½æ•°
import java.lang.foreign.*;

public class StringLengthExample {
    public static void main(String[] args) throws Throwable {
        // 1. è·å–é“¾æ¥å™¨
        Linker linker = Linker.nativeLinker();
        
        // 2. æŸ¥æ‰¾ strlen å‡½æ•°
        SymbolLookup stdlib = linker.defaultLookup();
        MemorySegment strlen = stdlib.find("strlen").orElseThrow();
        
        // 3. æè¿°å‡½æ•°ç­¾åï¼šsize_t strlen(const char*)
        FunctionDescriptor descriptor = FunctionDescriptor.of(
            ValueLayout.JAVA_LONG,      // size_t è¿”å›å€¼
            ValueLayout.ADDRESS         // const char* å‚æ•°
        );
        
        // 4. åˆ›å»ºæ–¹æ³•å¥æŸ„
        MethodHandle strlenHandle = linker.downcallHandle(strlen, descriptor);
        
        // 5. åˆ›å»º C å­—ç¬¦ä¸²
        try (Arena arena = Arena.ofConfined()) {
            MemorySegment cString = arena.allocateUtf8String("Hello, FFI!");
            
            // 6. è°ƒç”¨ C å‡½æ•°
            long length = (long) strlenHandle.invoke(cString);
            System.out.println("å­—ç¬¦ä¸²é•¿åº¦: " + length); // è¾“å‡º: 12
        }
    }
}
```

**2. ç»“æ„ä½“æ“ä½œ**
```java
// å¤„ç† C ç»“æ„ä½“
public class StructExample {
    // å®šä¹‰ C ç»“æ„ä½“å¸ƒå±€ï¼šstruct Point { int x; int y; };
    private static final MemoryLayout POINT_LAYOUT = MemoryLayout.structLayout(
        ValueLayout.JAVA_INT.withName("x"),
        ValueLayout.JAVA_INT.withName("y")
    );
    
    public static void main(String[] args) {
        try (Arena arena = Arena.ofConfined()) {
            // åˆ†é…ç»“æ„ä½“å†…å­˜
            MemorySegment point = arena.allocate(POINT_LAYOUT);
            
            // è®¾ç½®å­—æ®µå€¼
            point.set(ValueLayout.JAVA_INT, 0, 10);  // x = 10
            point.set(ValueLayout.JAVA_INT, 4, 20);  // y = 20
            
            // è¯»å–å­—æ®µå€¼
            int x = point.get(ValueLayout.JAVA_INT, 0);
            int y = point.get(ValueLayout.JAVA_INT, 4);
            
            System.out.println("Point: (" + x + ", " + y + ")");
        }
    }
}
```

**3. æ•°ç»„å’ŒæŒ‡é’ˆæ“ä½œ**
```java
// å¤„ç†æ•°ç»„å’ŒæŒ‡é’ˆ
public class ArrayExample {
    public static void main(String[] args) {
        try (Arena arena = Arena.ofConfined()) {
            // åˆ†é… int æ•°ç»„
            int[] javaArray = {1, 2, 3, 4, 5};
            MemorySegment nativeArray = arena.allocateArray(
                ValueLayout.JAVA_INT, 
                javaArray.length
            );
            
            // å¤åˆ¶æ•°æ®åˆ°æœ¬åœ°å†…å­˜
            MemorySegment.copy(javaArray, 0, nativeArray, 
                ValueLayout.JAVA_INT, 0, javaArray.length);
            
            // è¯»å–æœ¬åœ°å†…å­˜æ•°æ®
            for (int i = 0; i < javaArray.length; i++) {
                int value = nativeArray.getAtIndex(ValueLayout.JAVA_INT, i);
                System.out.println("arr[" + i + "] = " + value);
            }
        }
    }
}
```

#### å†…å­˜ç®¡ç†

**Arena æ¨¡å¼**
```java
// ä½¿ç”¨ Arena è¿›è¡Œèµ„æºç®¡ç†
public class MemoryManagementExample {
    public static void managedMemory() {
        // è‡ªåŠ¨èµ„æºç®¡ç†
        try (Arena arena = Arena.ofConfined()) {
            // åœ¨ arena ä¸­åˆ†é…çš„æ‰€æœ‰å†…å­˜ä¼šè‡ªåŠ¨é‡Šæ”¾
            MemorySegment buffer1 = arena.allocate(1024);
            MemorySegment buffer2 = arena.allocate(2048);
            MemorySegment string = arena.allocateUtf8String("Hello");
            
            // ä½¿ç”¨å†…å­˜...
            
        } // arena å…³é—­æ—¶ï¼Œæ‰€æœ‰åˆ†é…çš„å†…å­˜è‡ªåŠ¨é‡Šæ”¾
    }
    
    public static void sharedMemory() {
        // å…±äº« arenaï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
        Arena shared = Arena.ofShared();
        
        try {
            MemorySegment buffer = shared.allocate(1024);
            // ä½¿ç”¨å†…å­˜...
        } finally {
            shared.close(); // æ‰‹åŠ¨å…³é—­
        }
    }
}
```

#### å®‰å…¨æ€§å’Œé™åˆ¶

**1. å†…å­˜å®‰å…¨**
*   å†…å­˜æ®µæœ‰æ˜ç¡®çš„è¾¹ç•Œï¼Œè¶Šç•Œè®¿é—®ä¼šæŠ›å‡ºå¼‚å¸¸
*   Arena å…³é—­åï¼Œç›¸å…³å†…å­˜æ®µå˜ä¸ºæ— æ•ˆ
*   æä¾›äº†å®‰å…¨çš„å†…å­˜è®¿é—®æ£€æŸ¥

**2. è®¿é—®é™åˆ¶**
```java
// éœ€è¦ç‰¹æ®Šçš„æ¨¡å—å£°æ˜æˆ– JVM å‚æ•°
// --enable-native-access=ALL-UNNAMED
// æˆ–åœ¨ module-info.java ä¸­ï¼š
module myapp {
    requires java.base;
    // å¯ç”¨æœ¬åœ°è®¿é—®
}
```

**3. å¹³å°å…¼å®¹æ€§**
*   ä¸åŒå¹³å°ä¸Šçš„æœ¬åœ°åº“éœ€è¦åˆ†åˆ«å¤„ç†
*   Windows(.dll)ã€Linux(.so)ã€macOS(.dylib)

#### ä¸ JNI å¯¹æ¯”

| ç‰¹æ€§ | JNI | Foreign Function API |
|------|-----|----------------------|
| æ€§èƒ½ | ä¸­ç­‰ï¼ˆæœ‰è°ƒç”¨å¼€é”€ï¼‰ | é«˜ï¼ˆæ¥è¿‘æœ¬åœ°è°ƒç”¨ï¼‰ |
| ä»£ç å¤æ‚åº¦ | é«˜ï¼ˆéœ€è¦ C ä»£ç ï¼‰ | ä½ï¼ˆçº¯ Javaï¼‰ |
| ç±»å‹å®‰å…¨ | è¿è¡Œæ—¶æ£€æŸ¥ | ç¼–è¯‘æ—¶æ£€æŸ¥ |
| å†…å­˜ç®¡ç† | æ‰‹åŠ¨ç®¡ç† | è‡ªåŠ¨ç®¡ç† |
| è°ƒè¯•éš¾åº¦ | å›°éš¾ | ç›¸å¯¹å®¹æ˜“ |

#### å®é™…åº”ç”¨é¢†åŸŸ

**1. é«˜æ€§èƒ½è®¡ç®—**
*   è°ƒç”¨ä¼˜åŒ–çš„æ•°å­¦åº“ï¼ˆå¦‚ BLASã€LAPACKï¼‰
*   å›¾åƒå’Œä¿¡å·å¤„ç†åº“

**2. ç³»ç»Ÿç¼–ç¨‹**
*   æ“ä½œç³»ç»Ÿ API è°ƒç”¨
*   ç¡¬ä»¶é©±åŠ¨æ¥å£

**3. é—ç•™ç³»ç»Ÿé›†æˆ**
*   ä¸ç°æœ‰ C/C++ ä»£ç åº“é›†æˆ
*   æ•°æ®åº“åŸç”Ÿé©±åŠ¨

**4. è·¨è¯­è¨€äº’æ“ä½œ**
*   è°ƒç”¨å…¶ä»–è¯­è¨€ç¼–å†™çš„åº“
*   åµŒå…¥å¼è„šæœ¬å¼•æ“é›†æˆ

#### æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨ try-with-resources**ï¼šç¡®ä¿å†…å­˜èµ„æºæ­£ç¡®é‡Šæ”¾
2. **ä½¿ç”¨ Arena ç®¡ç†å†…å­˜**ï¼šé¿å…å†…å­˜æ³„æ¼
3. **ä»”ç»†è®¾è®¡å†…å­˜å¸ƒå±€**ï¼šåŒ¹é…æœ¬åœ°æ•°æ®ç»“æ„
4. **å¤„ç†å¹³å°å·®å¼‚**ï¼šè€ƒè™‘è·¨å¹³å°å…¼å®¹æ€§
5. **å……åˆ†æµ‹è¯•**ï¼šæœ¬åœ°è°ƒç”¨å¯èƒ½å¼•å…¥æ–°çš„é”™è¯¯ç±»å‹
6. **è¯„ä¼°å®‰å…¨æ€§**ï¼šæœ¬åœ°ä»£ç å¯èƒ½ç»•è¿‡ Java å®‰å…¨æœºåˆ¶

Foreign Function & Memory API ä»£è¡¨äº† Java å¹³å°çš„é‡å¤§è¿›æ­¥ï¼Œä¸ºé«˜æ€§èƒ½æœ¬åœ°ä»£ç é›†æˆæä¾›äº†ç°ä»£åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚

### 21. å‘é‡ API (Vector API) (Java 24, ç¬¬ä¹è½®å­µåŒ–)

*   **æ¼”è¿›**: ä» Java 16 å¼€å§‹å­µåŒ–ï¼Œåˆ° Java 24 å·²ç»æ˜¯ç¬¬ä¹è½®å­µåŒ–ã€‚
*   **æ ¸å¿ƒç†å¿µ**: ä¸º Java æä¾›åº•å±‚å‘é‡åŒ–è®¡ç®—èƒ½åŠ›ï¼Œå……åˆ†åˆ©ç”¨ç°ä»£ CPU çš„ SIMDï¼ˆSingle Instruction, Multiple Dataï¼‰æŒ‡ä»¤é›†ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **é«˜æ€§èƒ½**: å•æ¡æŒ‡ä»¤å¤„ç†å¤šä¸ªæ•°æ®ï¼Œæ˜¾è‘—æå‡æ•°å€¼è®¡ç®—æ€§èƒ½ã€‚
    *   **è·¨å¹³å°**: æŠ½è±¡äº†ä¸åŒ CPU æ¶æ„çš„ SIMD æŒ‡ä»¤å·®å¼‚ã€‚
    *   **ç±»å‹å®‰å…¨**: ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥ï¼Œé¿å…åº•å±‚æ±‡ç¼–çš„é”™è¯¯é£é™©ã€‚
    *   **JIT ä¼˜åŒ–**: JVM å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–å‘é‡æ“ä½œã€‚

#### SIMD åŸºç¡€æ¦‚å¿µ

**ä¼ ç»Ÿæ ‡é‡è¿ç®— vs å‘é‡è¿ç®—**
```java
// æ ‡é‡è¿ç®— - é€ä¸ªå¤„ç†
int[] a = {1, 2, 3, 4};
int[] b = {5, 6, 7, 8};
int[] result = new int[4];
for (int i = 0; i < 4; i++) {
    result[i] = a[i] + b[i]; // 4 æ¬¡ç‹¬ç«‹çš„åŠ æ³•æ“ä½œ
}

// å‘é‡è¿ç®— - å¹¶è¡Œå¤„ç†
// ä¸€æ¡æŒ‡ä»¤åŒæ—¶è®¡ç®— 4 ä¸ªåŠ æ³•ï¼š[1,2,3,4] + [5,6,7,8] = [6,8,10,12]
```

#### æ ¸å¿ƒ API æ¦‚è¿°

```java
// ä¸»è¦åŒ…å’Œç±»
import jdk.incubator.vector.*;

// 1. VectorSpecies - å‘é‡ç‰©ç§ï¼ˆå®šä¹‰å‘é‡çš„ç±»å‹å’Œé•¿åº¦ï¼‰
VectorSpecies<Integer> SPECIES = IntVector.SPECIES_256; // 256ä½å‘é‡ï¼Œå¯å®¹çº³8ä¸ªint

// 2. Vector - å‘é‡å®ä¾‹
IntVector vector1 = IntVector.fromArray(SPECIES, array1, 0);
IntVector vector2 = IntVector.fromArray(SPECIES, array2, 0);

// 3. VectorMask - å‘é‡æ©ç ï¼ˆç”¨äºæ¡ä»¶æ“ä½œï¼‰
VectorMask<Integer> mask = vector1.compare(VectorOperators.GT, threshold);

// 4. å‘é‡æ“ä½œ
IntVector result = vector1.add(vector2);
```

#### å®é™…ä»£ç ç¤ºä¾‹

**1. åŸºç¡€å‘é‡åŠ æ³•**
```java
import jdk.incubator.vector.*;

public class VectorAdditionExample {
    // é€‰æ‹©åˆé€‚çš„å‘é‡ç‰©ç§
    private static final VectorSpecies<Integer> SPECIES = IntVector.SPECIES_PREFERRED;
    
    public static void vectorAdd(int[] a, int[] b, int[] result) {
        int i = 0;
        int upperBound = SPECIES.loopBound(a.length);
        
        // å‘é‡åŒ–å¾ªç¯
        for (; i < upperBound; i += SPECIES.length()) {
            // åŠ è½½å‘é‡
            IntVector va = IntVector.fromArray(SPECIES, a, i);
            IntVector vb = IntVector.fromArray(SPECIES, b, i);
            
            // å‘é‡åŠ æ³•
            IntVector vr = va.add(vb);
            
            // å­˜å‚¨ç»“æœ
            vr.intoArray(result, i);
        }
        
        // å¤„ç†å‰©ä½™å…ƒç´ 
        for (; i < a.length; i++) {
            result[i] = a[i] + b[i];
        }
    }
    
    public static void main(String[] args) {
        int[] a = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
        int[] b = {10, 20, 30, 40, 50, 60, 70, 80, 90, 100};
        int[] result = new int[a.length];
        
        vectorAdd(a, b, result);
        System.out.println("ç»“æœ: " + Arrays.toString(result));
    }
}
```

**2. æµ®ç‚¹æ•°å‘é‡æ“ä½œ**
```java
public class FloatVectorExample {
    private static final VectorSpecies<Float> SPECIES = FloatVector.SPECIES_256;
    
    // å‘é‡åŒ–çš„ç‚¹ç§¯è®¡ç®—
    public static float dotProduct(float[] a, float[] b) {
        if (a.length != b.length) {
            throw new IllegalArgumentException("æ•°ç»„é•¿åº¦ä¸åŒ¹é…");
        }
        
        FloatVector sum = FloatVector.zero(SPECIES);
        int i = 0;
        int upperBound = SPECIES.loopBound(a.length);
        
        // å‘é‡åŒ–è®¡ç®—
        for (; i < upperBound; i += SPECIES.length()) {
            FloatVector va = FloatVector.fromArray(SPECIES, a, i);
            FloatVector vb = FloatVector.fromArray(SPECIES, b, i);
            sum = va.fma(vb, sum); // fused multiply-add: va * vb + sum
        }
        
        // å½’çº¦æ±‚å’Œ
        float result = sum.reduceLanes(VectorOperators.ADD);
        
        // å¤„ç†å‰©ä½™å…ƒç´ 
        for (; i < a.length; i++) {
            result += a[i] * b[i];
        }
        
        return result;
    }
    
    public static void main(String[] args) {
        float[] vector1 = {1.0f, 2.0f, 3.0f, 4.0f, 5.0f};
        float[] vector2 = {2.0f, 3.0f, 4.0f, 5.0f, 6.0f};
        
        float result = dotProduct(vector1, vector2);
        System.out.println("ç‚¹ç§¯ç»“æœ: " + result); // 1*2 + 2*3 + 3*4 + 4*5 + 5*6 = 70.0
    }
}
```

**3. æ¡ä»¶æ“ä½œå’Œæ©ç **
```java
public class VectorMaskExample {
    private static final VectorSpecies<Integer> SPECIES = IntVector.SPECIES_256;
    
    // æ¡ä»¶æ€§å‘é‡æ“ä½œï¼šå°†å¤§äºé˜ˆå€¼çš„å…ƒç´ è®¾ä¸º0ï¼Œå…¶ä»–ä¿æŒä¸å˜
    public static void conditionalZero(int[] array, int threshold) {
        int i = 0;
        int upperBound = SPECIES.loopBound(array.length);
        
        for (; i < upperBound; i += SPECIES.length()) {
            IntVector vector = IntVector.fromArray(SPECIES, array, i);
            
            // åˆ›å»ºæ©ç ï¼šæ ‡è®°å¤§äºé˜ˆå€¼çš„å…ƒç´ 
            VectorMask<Integer> mask = vector.compare(VectorOperators.GT, threshold);
            
            // æ¡ä»¶æ€§è®¾ç½®ä¸º0
            IntVector result = vector.blend(IntVector.zero(SPECIES), mask);
            
            result.intoArray(array, i);
        }
        
        // å¤„ç†å‰©ä½™å…ƒç´ 
        for (; i < array.length; i++) {
            if (array[i] > threshold) {
                array[i] = 0;
            }
        }
    }
    
    public static void main(String[] args) {
        int[] data = {1, 5, 10, 15, 3, 8, 12, 6};
        System.out.println("åŸå§‹æ•°æ®: " + Arrays.toString(data));
        
        conditionalZero(data, 7);
        System.out.println("å¤„ç†å: " + Arrays.toString(data)); // [1, 5, 0, 0, 3, 0, 0, 6]
    }
}
```

**4. å¤æ‚æ•°å­¦è¿ç®—**
```java
public class MathVectorExample {
    private static final VectorSpecies<Double> SPECIES = DoubleVector.SPECIES_512;
    
    // å‘é‡åŒ–çš„å¹³æ–¹æ ¹è®¡ç®—
    public static void vectorSqrt(double[] input, double[] output) {
        int i = 0;
        int upperBound = SPECIES.loopBound(input.length);
        
        for (; i < upperBound; i += SPECIES.length()) {
            DoubleVector vector = DoubleVector.fromArray(SPECIES, input, i);
            DoubleVector result = vector.lanewise(VectorOperators.SQRT);
            result.intoArray(output, i);
        }
        
        // å¤„ç†å‰©ä½™å…ƒç´ 
        for (; i < input.length; i++) {
            output[i] = Math.sqrt(input[i]);
        }
    }
    
    // å‘é‡åŒ–çš„æŒ‡æ•°è¿ç®—
    public static void vectorExp(double[] input, double[] output) {
        int i = 0;
        int upperBound = SPECIES.loopBound(input.length);
        
        for (; i < upperBound; i += SPECIES.length()) {
            DoubleVector vector = DoubleVector.fromArray(SPECIES, input, i);
            DoubleVector result = vector.lanewise(VectorOperators.EXP);
            result.intoArray(output, i);
        }
        
        // å¤„ç†å‰©ä½™å…ƒç´ 
        for (; i < input.length; i++) {
            output[i] = Math.exp(input[i]);
        }
    }
    
    public static void main(String[] args) {
        double[] input = {1.0, 4.0, 9.0, 16.0, 25.0};
        double[] sqrtResult = new double[input.length];
        double[] expResult = new double[input.length];
        
        vectorSqrt(input, sqrtResult);
        vectorExp(input, expResult);
        
        System.out.println("åŸå§‹æ•°æ®: " + Arrays.toString(input));
        System.out.println("å¹³æ–¹æ ¹: " + Arrays.toString(sqrtResult));
        System.out.println("æŒ‡æ•°: " + Arrays.toString(expResult));
    }
}
```

#### æ€§èƒ½åŸºå‡†æµ‹è¯•

**æ ‡é‡ vs å‘é‡æ€§èƒ½å¯¹æ¯”**
```java
public class VectorBenchmark {
    private static final int SIZE = 1_000_000;
    private static final VectorSpecies<Float> SPECIES = FloatVector.SPECIES_256;
    
    // æ ‡é‡ç‰ˆæœ¬
    public static void scalarMultiply(float[] a, float[] b, float[] result) {
        for (int i = 0; i < a.length; i++) {
            result[i] = a[i] * b[i];
        }
    }
    
    // å‘é‡ç‰ˆæœ¬
    public static void vectorMultiply(float[] a, float[] b, float[] result) {
        int i = 0;
        int upperBound = SPECIES.loopBound(a.length);
        
        for (; i < upperBound; i += SPECIES.length()) {
            FloatVector va = FloatVector.fromArray(SPECIES, a, i);
            FloatVector vb = FloatVector.fromArray(SPECIES, b, i);
            FloatVector vr = va.mul(vb);
            vr.intoArray(result, i);
        }
        
        for (; i < a.length; i++) {
            result[i] = a[i] * b[i];
        }
    }
    
    public static void benchmark() {
        float[] a = new float[SIZE];
        float[] b = new float[SIZE];
        float[] result = new float[SIZE];
        
        // åˆå§‹åŒ–æ•°æ®
        for (int i = 0; i < SIZE; i++) {
            a[i] = (float) i;
            b[i] = (float) (i + 1);
        }
        
        // é¢„çƒ­
        for (int i = 0; i < 1000; i++) {
            scalarMultiply(a, b, result);
            vectorMultiply(a, b, result);
        }
        
        // æ ‡é‡ç‰ˆæœ¬åŸºå‡†æµ‹è¯•
        long startTime = System.nanoTime();
        for (int i = 0; i < 1000; i++) {
            scalarMultiply(a, b, result);
        }
        long scalarTime = System.nanoTime() - startTime;
        
        // å‘é‡ç‰ˆæœ¬åŸºå‡†æµ‹è¯•
        startTime = System.nanoTime();
        for (int i = 0; i < 1000; i++) {
            vectorMultiply(a, b, result);
        }
        long vectorTime = System.nanoTime() - startTime;
        
        System.out.println("æ ‡é‡ç‰ˆæœ¬è€—æ—¶: " + scalarTime / 1_000_000 + " ms");
        System.out.println("å‘é‡ç‰ˆæœ¬è€—æ—¶: " + vectorTime / 1_000_000 + " ms");
        System.out.println("æ€§èƒ½æå‡: " + (double)scalarTime / vectorTime + "x");
    }
}
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. æœºå™¨å­¦ä¹ **
*   çŸ©é˜µä¹˜æ³•ä¼˜åŒ–
*   ç¥ç»ç½‘ç»œå‰å‘ä¼ æ’­
*   æ¢¯åº¦è®¡ç®—åŠ é€Ÿ

**2. å›¾åƒå¤„ç†**
*   åƒç´ çº§å¹¶è¡Œå¤„ç†
*   æ»¤æ³¢å™¨å·ç§¯è¿ç®—
*   é¢œè‰²ç©ºé—´è½¬æ¢

**3. ç§‘å­¦è®¡ç®—**
*   æ•°å€¼ç§¯åˆ†
*   ç»Ÿè®¡åˆ†æ
*   ä¿¡å·å¤„ç†

**4. é‡‘èè®¡ç®—**
*   è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ
*   æœŸæƒå®šä»·æ¨¡å‹
*   é£é™©è®¡ç®—

#### ä½¿ç”¨æ³¨æ„äº‹é¡¹

**1. ç¡¬ä»¶æ”¯æŒ**
```java
// æ£€æŸ¥ç¡¬ä»¶æ”¯æŒæƒ…å†µ
VectorSpecies<Float> species = FloatVector.SPECIES_PREFERRED;
System.out.println("é¦–é€‰å‘é‡é•¿åº¦: " + species.length());
System.out.println("å‘é‡ä½å®½: " + species.bitSize());
```

**2. å†…å­˜å¯¹é½**
*   ç¡®ä¿æ•°æ®åœ¨å†…å­˜ä¸­æ­£ç¡®å¯¹é½
*   é¿å…è·¨è¶Šç¼“å­˜è¡Œçš„è®¿é—®æ¨¡å¼

**3. æ•°æ®å¸ƒå±€**
*   ä¼˜å…ˆä½¿ç”¨è¿ç»­çš„å†…å­˜å¸ƒå±€
*   è€ƒè™‘æ•°æ®çš„è®¿é—®æ¨¡å¼

**4. æ€§èƒ½æµ‹é‡**
*   ä½¿ç”¨ JMH è¿›è¡Œå‡†ç¡®çš„åŸºå‡†æµ‹è¯•
*   è€ƒè™‘ JIT ç¼–è¯‘çš„é¢„çƒ­æ—¶é—´

#### é™åˆ¶å’ŒæŒ‘æˆ˜

**1. å­µåŒ–çŠ¶æ€**
*   API å¯èƒ½åœ¨æœªæ¥ç‰ˆæœ¬ä¸­å˜åŒ–
*   éœ€è¦ä½¿ç”¨ `--add-modules=jdk.incubator.vector`

**2. å­¦ä¹ æ›²çº¿**
*   éœ€è¦ç†è§£ SIMD æ¦‚å¿µ
*   è°ƒè¯•å¤æ‚åº¦è¾ƒé«˜

**3. é€‚ç”¨æ€§**
*   ä¸æ˜¯æ‰€æœ‰ç®—æ³•éƒ½èƒ½æœ‰æ•ˆå‘é‡åŒ–
*   éœ€è¦è¶³å¤Ÿçš„å¹¶è¡Œåº¦æ‰èƒ½è·å¾—æ”¶ç›Š

#### æœ€ä½³å®è·µ

1. **é€‰æ‹©åˆé€‚çš„å‘é‡é•¿åº¦**ï¼šä½¿ç”¨ `SPECIES_PREFERRED` è·å¾—æœ€ä½³æ€§èƒ½
2. **å¤„ç†è¾¹ç•Œæƒ…å†µ**ï¼šæ­£ç¡®å¤„ç†ä¸èƒ½æ•´é™¤å‘é‡é•¿åº¦çš„æ•°ç»„
3. **å†…å­˜è®¿é—®ä¼˜åŒ–**ï¼šä¿æŒæ•°æ®çš„è¿ç»­è®¿é—®æ¨¡å¼
4. **æ€§èƒ½éªŒè¯**ï¼šé€šè¿‡åŸºå‡†æµ‹è¯•éªŒè¯æ€§èƒ½æå‡
5. **å¯ç»´æŠ¤æ€§**ï¼šä¿æŒä»£ç å¯è¯»æ€§ï¼Œå¿…è¦æ—¶æä¾›æ ‡é‡ç‰ˆæœ¬ä½œä¸ºå¤‡é€‰

Vector API ä»£è¡¨äº† Java åœ¨é«˜æ€§èƒ½æ•°å€¼è®¡ç®—é¢†åŸŸçš„é‡è¦è¿›æ­¥ï¼Œä¸º CPU å¯†é›†å‹åº”ç”¨æä¾›äº†æ¥è¿‘åŸç”Ÿä»£ç çš„æ€§èƒ½ã€‚

### 22. ç±»æ–‡ä»¶ API (Class-File API) (Java 24, æ­£å¼)

*   **æ¼”è¿›**: åœ¨ Java 22 ä½œä¸ºé¢„è§ˆç‰¹æ€§ï¼ŒJava 24 æˆä¸ºæ­£å¼ç‰¹æ€§ã€‚
*   **æ ¸å¿ƒç†å¿µ**: ä¸ºè§£æã€ç”Ÿæˆå’Œè½¬æ¢ Java ç±»æ–‡ä»¶æä¾›æ ‡å‡†åŒ–çš„ APIï¼Œæ›¿ä»£ç¬¬ä¸‰æ–¹åº“å¦‚ ASMã€Javassist ç­‰ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **å®˜æ–¹æ”¯æŒ**: JDK å†…ç½®ï¼Œä¸éœ€è¦é¢å¤–ä¾èµ–ã€‚
    *   **ç±»å‹å®‰å…¨**: å¼ºç±»å‹ APIï¼Œç¼–è¯‘æœŸé”™è¯¯æ£€æµ‹ã€‚
    *   **æ€§èƒ½ä¼˜åŒ–**: ä¸ JVM å†…éƒ¨å®ç°ç´§å¯†é›†æˆã€‚
    *   **ç‰ˆæœ¬å…¼å®¹**: è‡ªåŠ¨å¤„ç†ä¸åŒç‰ˆæœ¬çš„ç±»æ–‡ä»¶æ ¼å¼ã€‚

#### èƒŒæ™¯ä¸åŠ¨æœº

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**
*   ç¬¬ä¸‰æ–¹åº“ï¼ˆASMã€Javassistï¼‰å¢åŠ ä¾èµ–å¤æ‚æ€§
*   ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼Œæ–° Java ç‰ˆæœ¬éœ€è¦åº“æ›´æ–°
*   æ€§èƒ½å¼€é”€å’Œå­¦ä¹ æˆæœ¬
*   ç¼ºä¹å®˜æ–¹æ ‡å‡†åŒ–

**Class-File API çš„è§£å†³æ–¹æ¡ˆ**
*   JDK å†…ç½®ï¼Œé›¶å¤–éƒ¨ä¾èµ–
*   ä¸ JVM æ¼”è¿›åŒæ­¥æ›´æ–°
*   ç»Ÿä¸€çš„ API è®¾è®¡èŒƒå¼
*   æ€§èƒ½ä¼˜åŒ–çš„å†…éƒ¨å®ç°

#### æ ¸å¿ƒ API æ¦‚è¿°

```java
// ä¸»è¦åŒ…å’Œæ¥å£
import java.lang.classfile.*;
import java.lang.classfile.attribute.*;
import java.lang.classfile.constantpool.*;
import java.lang.classfile.instruction.*;

// ä¸»è¦ç»„ä»¶ï¼š
// 1. ClassFile - ç±»æ–‡ä»¶çš„ä¸»è¦å…¥å£ç‚¹
// 2. ClassModel - è¡¨ç¤ºä¸€ä¸ªç±»æ–‡ä»¶çš„æ¨¡å‹
// 3. ClassBuilder - ç”¨äºæ„å»ºç±»æ–‡ä»¶
// 4. CodeModel/CodeBuilder - å¤„ç†æ–¹æ³•å­—èŠ‚ç 
// 5. ConstantPool - å¸¸é‡æ± æ“ä½œ
```

#### åŸºç¡€ç”¨æ³•ç¤ºä¾‹

**1. è¯»å–å’Œåˆ†æç±»æ–‡ä»¶**
```java
import java.lang.classfile.*;
import java.io.*;

public class ClassFileReaderExample {
    public static void analyzeClass(String className) throws IOException {
        // ä»ç±»è·¯å¾„åŠ è½½ç±»æ–‡ä»¶
        try (InputStream is = ClassFileReaderExample.class
                .getResourceAsStream("/" + className.replace('.', '/') + ".class")) {
            
            // è§£æç±»æ–‡ä»¶
            ClassModel classModel = ClassFile.of().parse(is.readAllBytes());
            
            // åŸºæœ¬ä¿¡æ¯
            System.out.println("ç±»å: " + classModel.thisClass().asInternalName());
            System.out.println("è®¿é—®æ ‡å¿—: " + classModel.flags());
            System.out.println("è¶…ç±»: " + classModel.superclass()
                    .map(ce -> ce.asInternalName()).orElse("æ— "));
            
            // æ¥å£ä¿¡æ¯
            System.out.println("å®ç°çš„æ¥å£:");
            classModel.interfaces().forEach(intf -> 
                System.out.println("  - " + intf.asInternalName()));
            
            // å­—æ®µä¿¡æ¯
            System.out.println("å­—æ®µ:");
            classModel.fields().forEach(field -> 
                System.out.println("  - " + field.fieldName().stringValue() + 
                                 " : " + field.fieldType().stringValue()));
            
            // æ–¹æ³•ä¿¡æ¯
            System.out.println("æ–¹æ³•:");
            classModel.methods().forEach(method -> {
                System.out.println("  - " + method.methodName().stringValue() + 
                                 " : " + method.methodType().stringValue());
                
                // åˆ†ææ–¹æ³•å­—èŠ‚ç 
                method.code().ifPresent(codeAttr -> {
                    System.out.println("    æŒ‡ä»¤æ•°é‡: " + codeAttr.elementList().size());
                    System.out.println("    æœ€å¤§æ ˆæ·±åº¦: " + codeAttr.maxStack());
                    System.out.println("    æœ¬åœ°å˜é‡æ§½æ•°: " + codeAttr.maxLocals());
                });
            });
        }
    }
    
    public static void main(String[] args) throws IOException {
        analyzeClass("java.lang.String");
    }
}
```

**2. ç”Ÿæˆç®€å•çš„ç±»**
```java
import java.lang.classfile.*;
import java.lang.constant.*;
import java.lang.classfile.constantpool.*;
import static java.lang.classfile.ClassFile.*;

public class ClassGeneratorExample {
    public static byte[] generateHelloWorldClass() {
        return ClassFile.of().build(
            // ç±»å
            ClassDesc.of("com.example.HelloWorld"),
            
            // ç±»æ„å»ºå™¨
            classBuilder -> {
                // ç±»çš„åŸºæœ¬ä¿¡æ¯
                classBuilder
                    .withFlags(AccessFlag.PUBLIC)
                    .withSuperclass(ClassDesc.of("java.lang.Object"));
                
                // æ·»åŠ é»˜è®¤æ„é€ å‡½æ•°
                classBuilder.withMethod("<init>", MethodTypeDesc.of(
                    CD_void), AccessFlag.PUBLIC, methodBuilder ->
                    methodBuilder.withCode(codeBuilder ->
                        codeBuilder
                            .aload(0) // åŠ è½½ this
                            .invokespecial(ClassDesc.of("java.lang.Object"), 
                                         "<init>", MethodTypeDesc.of(CD_void))
                            .return_()
                    )
                );
                
                // æ·»åŠ  main æ–¹æ³•
                classBuilder.withMethod("main", 
                    MethodTypeDesc.of(CD_void, CD_String.arrayType()),
                    AccessFlag.PUBLIC, AccessFlag.STATIC,
                    methodBuilder ->
                        methodBuilder.withCode(codeBuilder ->
                            codeBuilder
                                .getstatic(ClassDesc.of("java.lang.System"),
                                         "out", ClassDesc.of("java.io.PrintStream"))
                                .ldc("Hello, World!")
                                .invokevirtual(ClassDesc.of("java.io.PrintStream"),
                                             "println", MethodTypeDesc.of(CD_void, CD_String))
                                .return_()
                        )
                );
            }
        );
    }
    
    public static void main(String[] args) throws Exception {
        // ç”Ÿæˆç±»å­—èŠ‚ç 
        byte[] classBytes = generateHelloWorldClass();
        
        // å†™å…¥æ–‡ä»¶
        try (FileOutputStream fos = new FileOutputStream("HelloWorld.class")) {
            fos.write(classBytes);
        }
        
        // åŠ¨æ€åŠ è½½å¹¶æ‰§è¡Œ
        ClassLoader loader = new ClassLoader() {
            @Override
            protected Class<?> findClass(String name) throws ClassNotFoundException {
                if ("com.example.HelloWorld".equals(name)) {
                    return defineClass(name, classBytes, 0, classBytes.length);
                }
                throw new ClassNotFoundException(name);
            }
        };
        
        Class<?> clazz = loader.loadClass("com.example.HelloWorld");
        clazz.getMethod("main", String[].class).invoke(null, (Object) new String[0]);
    }
}
```

**3. å­—èŠ‚ç è½¬æ¢å’Œå¢å¼º**
```java
import java.lang.classfile.*;
import java.lang.classfile.instruction.*;

public class BytecodeTransformExample {
    
    // ä¸ºç±»çš„æ‰€æœ‰æ–¹æ³•æ·»åŠ æ—¥å¿—
    public static byte[] addLoggingToClass(byte[] originalClassBytes) {
        ClassModel originalClass = ClassFile.of().parse(originalClassBytes);
        
        return ClassFile.of().transform(originalClass, (classBuilder, classElement) -> {
            if (classElement instanceof MethodModel method) {
                // è½¬æ¢æ–¹æ³•ï¼Œæ·»åŠ è¿›å…¥å’Œé€€å‡ºæ—¥å¿—
                classBuilder.withMethod(method.methodName().stringValue(),
                    method.methodType(), method.flags().flagsMask(),
                    methodBuilder -> transformMethod(methodBuilder, method));
            } else {
                // å…¶ä»–å…ƒç´ ç›´æ¥å¤åˆ¶
                classBuilder.with(classElement);
            }
        });
    }
    
    private static void transformMethod(MethodBuilder methodBuilder, MethodModel originalMethod) {
        originalMethod.code().ifPresentOrElse(
            originalCode -> {
                methodBuilder.withCode(codeBuilder -> {
                    // æ–¹æ³•å¼€å§‹æ—¶çš„æ—¥å¿—
                    addLogStatement(codeBuilder, "è¿›å…¥æ–¹æ³•: " + 
                        originalMethod.methodName().stringValue());
                    
                    // å¤åˆ¶åŸå§‹å­—èŠ‚ç 
                    originalCode.elementStream().forEach(codeElement -> {
                        if (codeElement instanceof ReturnInstruction) {
                            // åœ¨è¿”å›å‰æ·»åŠ æ—¥å¿—
                            addLogStatement(codeBuilder, "é€€å‡ºæ–¹æ³•: " + 
                                originalMethod.methodName().stringValue());
                        }
                        codeBuilder.with(codeElement);
                    });
                });
            },
            () -> {
                // æŠ½è±¡æ–¹æ³•æˆ–æœ¬åœ°æ–¹æ³•ï¼Œç›´æ¥å¤åˆ¶
                originalMethod.elementStream().forEach(methodBuilder::with);
            }
        );
    }
    
    private static void addLogStatement(CodeBuilder codeBuilder, String message) {
        codeBuilder
            .getstatic(ClassDesc.of("java.lang.System"), "out", 
                      ClassDesc.of("java.io.PrintStream"))
            .ldc(message)
            .invokevirtual(ClassDesc.of("java.io.PrintStream"), "println",
                          MethodTypeDesc.of(CD_void, CD_String));
    }
    
    public static void main(String[] args) throws Exception {
        // è¯»å–åŸå§‹ç±»æ–‡ä»¶
        byte[] originalBytes = ClassGeneratorExample.generateHelloWorldClass();
        
        // æ·»åŠ æ—¥å¿—åŠŸèƒ½
        byte[] enhancedBytes = addLoggingToClass(originalBytes);
        
        // ä¿å­˜å¢å¼ºåçš„ç±»
        try (FileOutputStream fos = new FileOutputStream("HelloWorldWithLogging.class")) {
            fos.write(enhancedBytes);
        }
        
        System.out.println("å¢å¼ºçš„ç±»å·²ç”Ÿæˆåˆ° HelloWorldWithLogging.class");
    }
}
```

#### ä¸ç°æœ‰å·¥å…·çš„å¯¹æ¯”

| ç‰¹æ€§ | ASM | Javassist | Class-File API |
|------|-----|-----------|----------------|
| JDK å†…ç½® | âŒ | âŒ | âœ… |
| å­¦ä¹ æ›²çº¿ | é™¡å³­ | ä¸­ç­‰ | ä¸­ç­‰ |
| æ€§èƒ½ | é«˜ | ä¸­ç­‰ | å¾ˆé«˜ |
| ç±»å‹å®‰å…¨ | ä½ | ä¸­ç­‰ | é«˜ |
| ç‰ˆæœ¬å…¼å®¹ | éœ€æ›´æ–° | éœ€æ›´æ–° | è‡ªåŠ¨ |
| API é£æ ¼ | è®¿é—®è€…æ¨¡å¼ | åå°„å¼ | æ„å»ºè€…æ¨¡å¼ |

#### å®é™…åº”ç”¨é¢†åŸŸ

**1. æ¡†æ¶å¼€å‘**
*   Spring çš„ä»£ç†ç”Ÿæˆ
*   Hibernate çš„å®ä½“å¢å¼º
*   ä¾èµ–æ³¨å…¥å®¹å™¨

**2. å¼€å‘å·¥å…·**
*   IDE çš„ä»£ç åˆ†æ
*   é™æ€åˆ†æå·¥å…·
*   ä»£ç è¦†ç›–ç‡å·¥å…·

**3. æ€§èƒ½ä¼˜åŒ–**
*   JIT ç¼–è¯‘å™¨
*   çƒ­ç‚¹ä»£ç ä¼˜åŒ–
*   å†…å­˜ä½¿ç”¨åˆ†æ

**4. å®‰å…¨å·¥å…·**
*   ä»£ç æ··æ·†
*   æ¶æ„ä»£ç æ£€æµ‹
*   è®¿é—®æ§åˆ¶å¢å¼º

#### æœ€ä½³å®è·µ

1. **åˆç†ä½¿ç”¨è½¬æ¢æ¨¡å¼**ï¼šä¼˜å…ˆä½¿ç”¨ transform è€Œä¸æ˜¯å®Œå…¨é‡å»º
2. **æ³¨æ„æ€§èƒ½å½±å“**ï¼šå­—èŠ‚ç æ“ä½œå¯èƒ½å½±å“å¯åŠ¨æ—¶é—´
3. **ä¿æŒå…¼å®¹æ€§**ï¼šç¡®ä¿ç”Ÿæˆçš„å­—èŠ‚ç ç¬¦åˆ JVM è§„èŒƒ
4. **è°ƒè¯•æ”¯æŒ**ï¼šä¿ç•™è°ƒè¯•ä¿¡æ¯å’Œè¡Œå·æ˜ å°„
5. **æµ‹è¯•è¦†ç›–**ï¼šå……åˆ†æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯è·¯å¾„

Class-File API ä¸º Java å­—èŠ‚ç æ“ä½œæä¾›äº†å®˜æ–¹æ ‡å‡†åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œé¢„æœŸå°†æˆä¸ºå­—èŠ‚ç å·¥å…·çš„æ–°æ ‡å‡†ã€‚

---

[**ğŸ”™ è¿”å›ç›®å½•**](#ğŸ“‹-è¯¦ç»†ç›®å½•)

---

## äº”ã€ å¼€å‘ä½“éªŒä¸å·¥å…·

### 23. JShell: Java REPL å·¥å…· (Java 9)

*   **æ¼”è¿›**: Java 9 æ­£å¼å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: ä¸º Java æä¾›äº¤äº’å¼ç¼–ç¨‹ç¯å¢ƒï¼ˆREPL - Read-Eval-Print Loopï¼‰ï¼Œå…è®¸é€è¡Œæ‰§è¡Œ Java ä»£ç ç‰‡æ®µã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **å¿«é€ŸåŸå‹**: æ— éœ€å®Œæ•´çš„ç±»ç»“æ„å³å¯æµ‹è¯•ä»£ç ç‰‡æ®µã€‚
    *   **å­¦ä¹ å·¥å…·**: éå¸¸é€‚åˆ Java åˆå­¦è€…å’Œå®éªŒæ€§ç¼–ç¨‹ã€‚
    *   **è°ƒè¯•è¾…åŠ©**: å¿«é€ŸéªŒè¯è¡¨è¾¾å¼å’Œæ–¹æ³•è¡Œä¸ºã€‚
    *   **API æ¢ç´¢**: äº¤äº’å¼æ¢ç´¢ Java API å’Œç¬¬ä¸‰æ–¹åº“ã€‚

#### åŸºæœ¬ä½¿ç”¨

**å¯åŠ¨ JShell**
```bash
# å‘½ä»¤è¡Œå¯åŠ¨
jshell

# å¸¦è¯¦ç»†è¾“å‡ºå¯åŠ¨
jshell -v

# åŠ è½½å¤–éƒ¨ classpath
jshell --class-path /path/to/libs/*
```

**åŸºæœ¬æ“ä½œç¤ºä¾‹**
```java
// 1. å˜é‡å£°æ˜å’Œè®¡ç®—
jshell> int x = 10
x ==> 10

jshell> int y = 20
y ==> 20

jshell> int sum = x + y
sum ==> 30

// 2. æ–¹æ³•å®šä¹‰
jshell> int add(int a, int b) {
   ...>     return a + b;
   ...> }
|  created method add(int,int)

jshell> add(5, 7)
$5 ==> 12

// 3. å¯¼å…¥åŒ…
jshell> import java.util.*

jshell> List<String> names = Arrays.asList("Alice", "Bob", "Charlie")
names ==> [Alice, Bob, Charlie]

// 4. æµå¼æ“ä½œ
jshell> names.stream()
   ...>      .filter(name -> name.startsWith("A"))
   ...>      .collect(Collectors.toList())
$8 ==> [Alice]
```

#### é«˜çº§ç‰¹æ€§

**1. å¤šè¡Œç¼–è¾‘å’Œä»£ç å—**
```java
// ç±»å®šä¹‰
jshell> class Person {
   ...>     private String name;
   ...>     private int age;
   ...>     
   ...>     public Person(String name, int age) {
   ...>         this.name = name;
   ...>         this.age = age;
   ...>     }
   ...>     
   ...>     public String toString() {
   ...>         return name + " (" + age + ")";
   ...>     }
   ...> }
|  created class Person

jshell> Person p = new Person("Alice", 25)
p ==> Alice (25)
```

**2. ä»£ç ç‰‡æ®µç®¡ç†**
```java
// æŸ¥çœ‹å·²å®šä¹‰çš„å˜é‡
jshell> /vars
|    int x = 10
|    int y = 20
|    int sum = 30
|    List<String> names = [Alice, Bob, Charlie]
|    Person p = Alice (25)

// æŸ¥çœ‹å·²å®šä¹‰çš„æ–¹æ³•
jshell> /methods
|    int add(int,int)

// æŸ¥çœ‹å†å²è®°å½•
jshell> /history

// ä¿å­˜ä¼šè¯åˆ°æ–‡ä»¶
jshell> /save mycode.jsh

// åŠ è½½æ–‡ä»¶
jshell> /open mycode.jsh
```

**3. å¤–éƒ¨ç¼–è¾‘å™¨é›†æˆ**
```java
// è®¾ç½®å¤–éƒ¨ç¼–è¾‘å™¨
jshell> /set editor vim

// ç¼–è¾‘ä»£ç ç‰‡æ®µ
jshell> /edit add
// æ‰“å¼€å¤–éƒ¨ç¼–è¾‘å™¨ç¼–è¾‘ add æ–¹æ³•
```

#### å®ç”¨å‘½ä»¤å¤§å…¨

```java
// === åŸºç¡€å‘½ä»¤ ===
/help                 // æ˜¾ç¤ºå¸®åŠ©
/exit                 // é€€å‡º JShell
/quit                 // é€€å‡º JShell

// === ä»£ç ç®¡ç† ===
/list                 // æ˜¾ç¤ºå½“å‰ä¼šè¯ä¸­çš„ä»£ç 
/vars                 // æ˜¾ç¤ºå˜é‡
/methods              // æ˜¾ç¤ºæ–¹æ³•
/types                // æ˜¾ç¤ºç±»å‹
/imports              // æ˜¾ç¤ºå¯¼å…¥

// === æ–‡ä»¶æ“ä½œ ===
/save filename        // ä¿å­˜ä¼šè¯
/open filename        // åŠ è½½æ–‡ä»¶
/drop name            // åˆ é™¤å˜é‡/æ–¹æ³•/ç±»

// === ç¯å¢ƒè®¾ç½® ===
/set editor cmd       // è®¾ç½®ç¼–è¾‘å™¨
/set start filename   // è®¾ç½®å¯åŠ¨è„šæœ¬
/set mode verbose     // è®¾ç½®è¯¦ç»†æ¨¡å¼
/set feedback verbose // è®¾ç½®åé¦ˆçº§åˆ«

// === è°ƒè¯•ä¿¡æ¯ ===
/history              // å‘½ä»¤å†å²
/reload               // é‡æ–°åŠ è½½ä¼šè¯
/reset                // é‡ç½® JShell ç¯å¢ƒ
```

#### å®é™…åº”ç”¨åœºæ™¯

**1. ç®—æ³•éªŒè¯**
```java
jshell> // å¿«é€ŸéªŒè¯æ’åºç®—æ³•
jshell> int[] arr = {64, 34, 25, 12, 22, 11, 90}
arr ==> int[7] { 64, 34, 25, 12, 22, 11, 90 }

jshell> // å†’æ³¡æ’åºå®ç°
jshell> void bubbleSort(int[] arr) {
   ...>     int n = arr.length;
   ...>     for (int i = 0; i < n-1; i++) {
   ...>         for (int j = 0; j < n-i-1; j++) {
   ...>             if (arr[j] > arr[j+1]) {
   ...>                 int temp = arr[j];
   ...>                 arr[j] = arr[j+1];
   ...>                 arr[j+1] = temp;
   ...>             }
   ...>         }
   ...>     }
   ...> }

jshell> bubbleSort(arr)
jshell> Arrays.toString(arr)
$12 ==> "[11, 12, 22, 25, 34, 64, 90]"
```

**2. API æ¢ç´¢**
```java
jshell> // æ¢ç´¢ Stream API
jshell> List<Integer> numbers = IntStream.range(1, 10)
   ...>                                   .boxed()
   ...>                                   .collect(Collectors.toList())

jshell> numbers.stream()
   ...>        .filter(n -> n % 2 == 0)
   ...>        .map(n -> n * n)
   ...>        .collect(Collectors.toList())
$15 ==> [4, 16, 36, 64]
```

**3. æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•**
```java
jshell> import java.util.regex.*

jshell> String text = "Java 21 and Spring Boot 3.0"
text ==> "Java 21 and Spring Boot 3.0"

jshell> Pattern pattern = Pattern.compile("\\d+(\\.\\d+)*")
pattern ==> \d+(\.\d+)*

jshell> Matcher matcher = pattern.matcher(text)
matcher ==> java.util.regex.Matcher[pattern=\d+(\.\d+)* region=0,26 lastmatch=]

jshell> while (matcher.find()) {
   ...>     System.out.println("Found: " + matcher.group());
   ...> }
Found: 21
Found: 3.0
```

**4. æ•°æ®åˆ†æ**
```java
jshell> // ç®€å•çš„æ•°æ®åˆ†æ
jshell> double[] scores = {85.5, 92.0, 78.5, 95.0, 88.0, 91.5}
scores ==> double[6] { 85.5, 92.0, 78.5, 95.0, 88.0, 91.5 }

jshell> // è®¡ç®—å¹³å‡åˆ†
jshell> double average = Arrays.stream(scores).average().orElse(0.0)
average ==> 88.41666666666667

jshell> // æ‰¾å‡ºæœ€é«˜åˆ†
jshell> double max = Arrays.stream(scores).max().orElse(0.0)
max ==> 95.0

jshell> // ç»Ÿè®¡åŠæ ¼äººæ•°ï¼ˆå‡è®¾60åˆ†åŠæ ¼ï¼‰
jshell> long passCount = Arrays.stream(scores)
   ...>                           .filter(score -> score >= 60)
   ...>                           .count()
passCount ==> 6
```

#### æ•™å­¦å’Œå­¦ä¹ åº”ç”¨

**1. æ¦‚å¿µæ¼”ç¤º**
```java
// æ¼”ç¤ºé¢å‘å¯¹è±¡æ¦‚å¿µ
jshell> abstract class Animal {
   ...>     protected String name;
   ...>     public Animal(String name) { this.name = name; }
   ...>     public abstract void makeSound();
   ...>     public void sleep() { System.out.println(name + " is sleeping"); }
   ...> }

jshell> class Dog extends Animal {
   ...>     public Dog(String name) { super(name); }
   ...>     public void makeSound() { System.out.println(name + " says Woof!"); }
   ...> }

jshell> Animal dog = new Dog("Buddy")
dog ==> Dog@...

jshell> dog.makeSound()
Buddy says Woof!
```

**2. è®¾è®¡æ¨¡å¼æ¼”ç¤º**
```java
// å¿«é€Ÿæ¼”ç¤ºå•ä¾‹æ¨¡å¼
jshell> class Singleton {
   ...>     private static Singleton instance = null;
   ...>     private Singleton() {}
   ...>     public static Singleton getInstance() {
   ...>         if (instance == null) {
   ...>             instance = new Singleton();
   ...>         }
   ...>         return instance;
   ...>     }
   ...> }

jshell> Singleton s1 = Singleton.getInstance()
jshell> Singleton s2 = Singleton.getInstance()
jshell> s1 == s2
$25 ==> true
```

#### é›†æˆå¼€å‘

**å¯åŠ¨è„šæœ¬ç¤ºä¾‹**
```java
// åˆ›å»º startup.jsh æ–‡ä»¶
import java.util.*;
import java.util.stream.*;
import java.time.*;
import java.math.*;

// å¸¸ç”¨å·¥å…·æ–¹æ³•
void println(Object obj) {
    System.out.println(obj);
}

String now() {
    return LocalDateTime.now().toString();
}

// ä½¿ç”¨å¯åŠ¨è„šæœ¬
// jshell startup.jsh
```

**ä¸ IDE é›†æˆ**
*   IntelliJ IDEA: å†…ç½® JShell æ§åˆ¶å°
*   Eclipse: é€šè¿‡æ’ä»¶æ”¯æŒ
*   VS Code: é€šè¿‡ Java æ‰©å±•æ”¯æŒ

JShell æå¤§åœ°æå‡äº† Java çš„äº¤äº’æ€§å’Œå­¦ä¹ ä½“éªŒï¼Œæ˜¯ç°ä»£ Java å¼€å‘çš„é‡è¦å·¥å…·ã€‚

### 24. å•æ–‡ä»¶æºç ç¨‹åºå¯åŠ¨ (Java 11)

*   **æ¼”è¿›**: Java 11 æ­£å¼å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: å…è®¸ç›´æ¥è¿è¡Œå•ä¸ª `.java` æ–‡ä»¶ï¼Œæ— éœ€å…ˆç¼–è¯‘æˆ `.class` æ–‡ä»¶ï¼Œç®€åŒ–å°å‹ç¨‹åºå’Œè„šæœ¬çš„å¼€å‘æµç¨‹ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **é›¶é…ç½®**: æ— éœ€æ„å»ºå·¥å…·æˆ–å¤æ‚çš„é¡¹ç›®ç»“æ„ã€‚
    *   **å¿«é€ŸåŸå‹**: é€‚åˆç¼–å†™å·¥å…·è„šæœ¬å’Œä¸€æ¬¡æ€§ç¨‹åºã€‚
    *   **å­¦ä¹ å‹å¥½**: é™ä½ Java å­¦ä¹ é—¨æ§›ã€‚
    *   **è„šæœ¬åŒ–**: Java ç¨‹åºå¯ä»¥åƒè„šæœ¬è¯­è¨€ä¸€æ ·ä½¿ç”¨ã€‚

#### åŸºæœ¬ä½¿ç”¨æ–¹æ³•

**ä¼ ç»Ÿæ–¹å¼ vs å•æ–‡ä»¶å¯åŠ¨**
```java
// === ä¼ ç»Ÿæ–¹å¼ ===
// 1. ç¼–å†™ HelloWorld.java
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
    }
}

// 2. ç¼–è¯‘
// javac HelloWorld.java

// 3. è¿è¡Œ
// java HelloWorld

// === å•æ–‡ä»¶å¯åŠ¨æ–¹å¼ ===
// ç›´æ¥è¿è¡Œï¼ˆJava 11+ï¼‰
// java HelloWorld.java
```

**å‘½ä»¤è¯­æ³•**
```bash
# åŸºæœ¬è¯­æ³•
java [OPTIONS] <source-file> [args...]

# ç¤ºä¾‹
java HelloWorld.java
java --class-path /path/to/libs MyScript.java arg1 arg2
java -Dproperty=value Script.java
```

#### å®é™…åº”ç”¨ç¤ºä¾‹

**1. ç³»ç»Ÿå·¥å…·è„šæœ¬**
```java
// FileStats.java - æ–‡ä»¶ç»Ÿè®¡å·¥å…·
import java.nio.file.*;
import java.io.IOException;
import java.util.stream.Stream;

public class FileStats {
    public static void main(String[] args) throws IOException {
        if (args.length == 0) {
            System.out.println("ç”¨æ³•: java FileStats.java <ç›®å½•è·¯å¾„>");
            System.exit(1);
        }
        
        Path directory = Paths.get(args[0]);
        if (!Files.isDirectory(directory)) {
            System.err.println("é”™è¯¯: " + args[0] + " ä¸æ˜¯ä¸€ä¸ªç›®å½•");
            System.exit(1);
        }
        
        try (Stream<Path> files = Files.walk(directory)) {
            var stats = files
                .filter(Files::isRegularFile)
                .collect(java.util.stream.Collectors.groupingBy(
                    FileStats::getFileExtension,
                    java.util.stream.Collectors.counting()
                ));
            
            System.out.println("æ–‡ä»¶ç»Ÿè®¡ - " + directory + ":");
            stats.entrySet().stream()
                .sorted((a, b) -> Long.compare(b.getValue(), a.getValue()))
                .forEach(entry -> 
                    System.out.printf("  %s: %d ä¸ªæ–‡ä»¶\n", 
                        entry.getKey(), entry.getValue()));
                        
            long totalFiles = stats.values().stream()
                .mapToLong(Long::longValue).sum();
            System.out.println("æ€»è®¡: " + totalFiles + " ä¸ªæ–‡ä»¶");
        }
    }
    
    private static String getFileExtension(Path file) {
        String fileName = file.getFileName().toString();
        int lastDot = fileName.lastIndexOf('.');
        return lastDot > 0 ? fileName.substring(lastDot) : "[æ— æ‰©å±•å]";
    }
}

// ä½¿ç”¨: java FileStats.java /path/to/directory
```

**2. ç½‘ç»œå·¥å…·**
```java
// HttpChecker.java - HTTP çŠ¶æ€æ£€æŸ¥å·¥å…·
import java.net.http.*;
import java.net.*;
import java.time.Duration;
import java.io.IOException;

public class HttpChecker {
    public static void main(String[] args) {
        if (args.length == 0) {
            System.out.println("ç”¨æ³•: java HttpChecker.java <URL1> <URL2> ...");
            System.exit(1);
        }
        
        HttpClient client = HttpClient.newBuilder()
            .connectTimeout(Duration.ofSeconds(10))
            .build();
            
        for (String url : args) {
            checkUrl(client, url);
        }
    }
    
    private static void checkUrl(HttpClient client, String url) {
        try {
            HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .timeout(Duration.ofSeconds(30))
                .GET()
                .build();
                
            long startTime = System.currentTimeMillis();
            HttpResponse<String> response = client.send(request, 
                HttpResponse.BodyHandlers.ofString());
            long responseTime = System.currentTimeMillis() - startTime;
            
            System.out.printf("%s - çŠ¶æ€: %d, å“åº”æ—¶é—´: %d ms\n", 
                url, response.statusCode(), responseTime);
                
        } catch (IOException | InterruptedException e) {
            System.err.printf("%s - é”™è¯¯: %s\n", url, e.getMessage());
        }
    }
}

// ä½¿ç”¨: java HttpChecker.java https://google.com https://github.com
```

**3. æ•°æ®å¤„ç†è„šæœ¬**
```java
// CsvAnalyzer.java - CSV æ–‡ä»¶åˆ†æå™¨
import java.nio.file.*;
import java.util.*;
import java.util.stream.*;
import java.io.IOException;

public class CsvAnalyzer {
    public static void main(String[] args) throws IOException {
        if (args.length < 2) {
            System.out.println("ç”¨æ³•: java CsvAnalyzer.java <CSVæ–‡ä»¶> <åˆ—å·>");
            System.exit(1);
        }
        
        String filename = args[0];
        int columnIndex = Integer.parseInt(args[1]) - 1; // è½¬ä¸º0åŸºç´¢å¼•
        
        List<String> lines = Files.readAllLines(Paths.get(filename));
        if (lines.isEmpty()) {
            System.out.println("æ–‡ä»¶ä¸ºç©º");
            return;
        }
        
        // è·³è¿‡æ ‡é¢˜è¡Œï¼Œæå–æŒ‡å®šåˆ—çš„æ•°æ®
        List<Double> values = lines.stream()
            .skip(1) // è·³è¿‡æ ‡é¢˜
            .map(line -> line.split(","))
            .filter(parts -> parts.length > columnIndex)
            .map(parts -> parts[columnIndex].trim())
            .filter(value -> !value.isEmpty())
            .mapToDouble(Double::parseDouble)
            .boxed()
            .collect(Collectors.toList());
            
        if (values.isEmpty()) {
            System.out.println("æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ•°å€¼æ•°æ®");
            return;
        }
        
        // ç»Ÿè®¡åˆ†æ
        DoubleSummaryStatistics stats = values.stream()
            .mapToDouble(Double::doubleValue)
            .summaryStatistics();
            
        System.out.printf("ç¬¬ %d åˆ—æ•°æ®åˆ†æ:\n", Integer.parseInt(args[1]));
        System.out.printf("  æ•°æ®ä¸ªæ•°: %d\n", stats.getCount());
        System.out.printf("  æœ€å°å€¼: %.2f\n", stats.getMin());
        System.out.printf("  æœ€å¤§å€¼: %.2f\n", stats.getMax());
        System.out.printf("  å¹³å‡å€¼: %.2f\n", stats.getAverage());
        System.out.printf("  æ€»å’Œ: %.2f\n", stats.getSum());
        
        // ä¸­ä½æ•°
        Collections.sort(values);
        double median = values.size() % 2 == 0 ?
            (values.get(values.size()/2 - 1) + values.get(values.size()/2)) / 2.0 :
            values.get(values.size()/2);
        System.out.printf("  ä¸­ä½æ•°: %.2f\n", median);
    }
}

// ä½¿ç”¨: java CsvAnalyzer.java data.csv 3
```

**4. æ–‡æœ¬å¤„ç†å·¥å…·**
```java
// TextProcessor.java - æ–‡æœ¬å¤„ç†å·¥å…·
import java.nio.file.*;
import java.util.*;
import java.util.regex.*;
import java.io.IOException;

public class TextProcessor {
    public static void main(String[] args) throws IOException {
        if (args.length < 2) {
            printUsage();
            System.exit(1);
        }
        
        String command = args[0];
        String filename = args[1];
        
        String content = Files.readString(Paths.get(filename));
        
        switch (command.toLowerCase()) {
            case "count" -> countWords(content);
            case "lines" -> countLines(content);
            case "find" -> findPattern(content, args[2]);
            case "replace" -> replacePattern(content, args[2], args[3], filename);
            default -> {
                System.err.println("æœªçŸ¥å‘½ä»¤: " + command);
                printUsage();
            }
        }
    }
    
    private static void printUsage() {
        System.out.println("ç”¨æ³•:");
        System.out.println("  java TextProcessor.java count <æ–‡ä»¶>     - ç»Ÿè®¡å•è¯");
        System.out.println("  java TextProcessor.java lines <æ–‡ä»¶>     - ç»Ÿè®¡è¡Œæ•°");
        System.out.println("  java TextProcessor.java find <æ–‡ä»¶> <æ­£åˆ™>  - æŸ¥æ‰¾æ¨¡å¼");
        System.out.println("  java TextProcessor.java replace <æ–‡ä»¶> <æŸ¥æ‰¾> <æ›¿æ¢> - æ›¿æ¢æ–‡æœ¬");
    }
    
    private static void countWords(String content) {
        String[] words = content.trim().split("\\s+");
        System.out.println("å•è¯æ•°: " + (content.trim().isEmpty() ? 0 : words.length));
        
        Map<String, Integer> wordFreq = new HashMap<>();
        for (String word : words) {
            word = word.toLowerCase().replaceAll("[^a-zA-Z0-9]", "");
            if (!word.isEmpty()) {
                wordFreq.merge(word, 1, Integer::sum);
            }
        }
        
        System.out.println("\né«˜é¢‘è¯æ±‡ (å‰10ä¸ª):");
        wordFreq.entrySet().stream()
            .sorted((a, b) -> b.getValue().compareTo(a.getValue()))
            .limit(10)
            .forEach(entry -> System.out.printf("  %s: %d æ¬¡\n", 
                entry.getKey(), entry.getValue()));
    }
    
    private static void countLines(String content) {
        long lineCount = content.lines().count();
        long nonEmptyLines = content.lines()
            .filter(line -> !line.trim().isEmpty())
            .count();
            
        System.out.println("æ€»è¡Œæ•°: " + lineCount);
        System.out.println("éç©ºè¡Œæ•°: " + nonEmptyLines);
    }
    
    private static void findPattern(String content, String regex) {
        Pattern pattern = Pattern.compile(regex, Pattern.MULTILINE);
        Matcher matcher = pattern.matcher(content);
        
        int count = 0;
        while (matcher.find()) {
            count++;
            System.out.printf("åŒ¹é… %d: %s (ä½ç½®: %d-%d)\n", 
                count, matcher.group(), matcher.start(), matcher.end());
        }
        
        if (count == 0) {
            System.out.println("æœªæ‰¾åˆ°åŒ¹é…é¡¹");
        } else {
            System.out.println("\næ€»è®¡æ‰¾åˆ° " + count + " ä¸ªåŒ¹é…é¡¹");
        }
    }
    
    private static void replacePattern(String content, String find, 
                                     String replace, String filename) throws IOException {
        String newContent = content.replaceAll(find, replace);
        String outputFile = filename + ".new";
        Files.writeString(Paths.get(outputFile), newContent);
        System.out.println("æ›¿æ¢å®Œæˆï¼Œç»“æœä¿å­˜åˆ°: " + outputFile);
    }
}

// ä½¿ç”¨ç¤ºä¾‹:
// java TextProcessor.java count document.txt
// java TextProcessor.java find document.txt "\\b\\w+@\\w+\\.\\w+\\b"
```

#### é«˜çº§ç‰¹æ€§å’Œé™åˆ¶

**æ”¯æŒçš„ç‰¹æ€§**
*   å®Œæ•´çš„ Java è¯­è¨€ç‰¹æ€§
*   å¯¼å…¥å¤–éƒ¨åº“ï¼ˆé€šè¿‡ --class-pathï¼‰
*   JVM å‚æ•°ä¼ é€’
*   ç¨‹åºå‚æ•°ä¼ é€’
*   ç³»ç»Ÿå±æ€§è®¾ç½®

**é™åˆ¶æ¡ä»¶**
*   åªèƒ½åŒ…å«ä¸€ä¸ªå…¬å…±ç±»
*   ç±»åå¿…é¡»ä¸æ–‡ä»¶ååŒ¹é…
*   ä¸æ”¯æŒåŒ…å£°æ˜
*   ç¼–è¯‘æ˜¯ä¸´æ—¶çš„ï¼Œä¸ç”Ÿæˆ .class æ–‡ä»¶

**æ€§èƒ½è€ƒè™‘**
*   é¦–æ¬¡è¿è¡Œéœ€è¦ç¼–è¯‘æ—¶é—´
*   é€‚åˆå°å‹ç¨‹åºå’Œè„šæœ¬
*   ä¸é€‚åˆå¤§å‹åº”ç”¨ç¨‹åº

#### ä¸è„šæœ¬è¯­è¨€çš„å¯¹æ¯”

| ç‰¹æ€§ | Java å•æ–‡ä»¶ | Python | Node.js |
|------|-------------|--------|---------|
| æ€§èƒ½ | é«˜ï¼ˆJVMï¼‰ | ä¸­ç­‰ | é«˜ï¼ˆV8ï¼‰ |
| å¯åŠ¨é€Ÿåº¦ | æ…¢ï¼ˆJVM å¯åŠ¨ï¼‰ | å¿« | å¿« |
| ç±»å‹å®‰å…¨ | å¼ºç±»å‹ | åŠ¨æ€ç±»å‹ | åŠ¨æ€ç±»å‹ |
| ç”Ÿæ€ç³»ç»Ÿ | Java ç”Ÿæ€ | ä¸°å¯Œ | ä¸°å¯Œ |
| å­¦ä¹ æ›²çº¿ | ä¸­ç­‰ | ç®€å• | ç®€å• |

#### å®é™…éƒ¨ç½²å»ºè®®

**1. Shebang æ”¯æŒï¼ˆUnix/Linuxï¼‰**
```java
#!/usr/bin/java --source 11
// MyScript.java
public class MyScript {
    public static void main(String[] args) {
        System.out.println("è¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„ Java è„šæœ¬!");
    }
}
```

```bash
# ä½¿è„šæœ¬å¯æ‰§è¡Œ
chmod +x MyScript.java

# ç›´æ¥è¿è¡Œ
./MyScript.java
```

**2. å®¹å™¨åŒ–éƒ¨ç½²**
```dockerfile
# Dockerfile
FROM openjdk:11-jre-slim
COPY script.java /app/
WORKDIR /app
ENTRYPOINT ["java", "script.java"]
```

**æœ€ä½³å®è·µ**
1. **é€‚åˆåœºæ™¯**: å·¥å…·è„šæœ¬ã€åŸå‹å¼€å‘ã€æ•™å­¦æ¼”ç¤º
2. **é¿å…åœºæ™¯**: å¤§å‹åº”ç”¨ã€ç”Ÿäº§ç¯å¢ƒçš„æ ¸å¿ƒæœåŠ¡
3. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ GraalVM åŸç”Ÿç¼–è¯‘æå‡å¯åŠ¨é€Ÿåº¦
4. **ä»£ç ç»„ç»‡**: ä¿æŒå•æ–‡ä»¶çš„ç®€æ´æ€§ï¼Œå¤æ‚é€»è¾‘è€ƒè™‘ä¼ ç»Ÿé¡¹ç›®ç»“æ„

å•æ–‡ä»¶æºç ç¨‹åºå¯åŠ¨ä¸º Java å¼€å‘å¸¦æ¥äº†è„šæœ¬åŒ–çš„ä¾¿åˆ©æ€§ï¼Œæ˜¯ç°ä»£ Java ç”Ÿæ€ç³»ç»Ÿçš„é‡è¦è¡¥å……ã€‚

### 25. æ›´è¯¦å°½çš„ NullPointerException (Java 14)

*   **æ¼”è¿›**: Java 14 æ­£å¼å¼•å…¥ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›æ›´ç²¾ç¡®ã€æ›´æœ‰ç”¨çš„ NullPointerException é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **ç²¾ç¡®å®šä½**: æ˜ç¡®æŒ‡å‡ºå“ªä¸ªå…·ä½“çš„å¼•ç”¨ä¸º nullã€‚
    *   **è°ƒè¯•åŠ©æ‰‹**: æ˜¾è‘—å‡å°‘è°ƒè¯•æ—¶é—´å’Œå¿ƒæ™ºè´Ÿæ‹…ã€‚
    *   **å­¦ä¹ å‹å¥½**: å¸®åŠ©åˆå­¦è€…ç†è§£é”™è¯¯åŸå› ã€‚
    *   **ç”Ÿäº§å¯ç”¨**: æå‡ç”Ÿäº§ç¯å¢ƒçš„é—®é¢˜è¯Šæ–­æ•ˆç‡ã€‚

#### ä¼ ç»Ÿ vs å¢å¼ºç‰ˆå¯¹æ¯”

**ä¼ ç»Ÿçš„ NullPointerException**
```java
// ä»£ç ç¤ºä¾‹
public class Person {
    private String name;
    private Address address;
    
    // getters and setters...
    
    public void printStreetName() {
        // è¿™è¡Œä»£ç å¯èƒ½æŠ›å‡º NPE
        System.out.println(address.getStreet().getName().toUpperCase());
    }
}

class Address {
    private Street street;
    // ...
}

class Street {
    private String name;
    // ...
}

// ä¼ ç»Ÿé”™è¯¯ä¿¡æ¯ï¼ˆJava 13 åŠä»¥å‰ï¼‰
// Exception in thread "main" java.lang.NullPointerException
//     at Person.printStreetName(Person.java:10)
```

**å¢å¼ºç‰ˆçš„ NullPointerException**
```java
// åŒæ ·çš„ä»£ç ï¼ŒJava 14+ çš„é”™è¯¯ä¿¡æ¯
// Exception in thread "main" java.lang.NullPointerException: 
//     Cannot invoke "Street.getName()" because the return value of 
//     "Address.getStreet()" is null
//     at Person.printStreetName(Person.java:10)
```

#### è¯¦ç»†ç¤ºä¾‹å¯¹æ¯”

**1. æ–¹æ³•è°ƒç”¨é“¾**
```java
public class ChainedCallExample {
    public static void main(String[] args) {
        User user = new User();
        
        // è¿™è¡Œä»£ç ä¼šæŠ›å‡º NPE
        String country = user.getProfile().getAddress().getCountry().toUpperCase();
        System.out.println(country);
    }
}

class User {
    private Profile profile;
    public Profile getProfile() { return profile; } // è¿”å› null
}

class Profile {
    private Address address;
    public Address getAddress() { return address; }
}

class Address {
    private String country;
    public String getCountry() { return country; }
}

// Java 13 åŠä»¥å‰çš„é”™è¯¯ä¿¡æ¯
// java.lang.NullPointerException
//     at ChainedCallExample.main(ChainedCallExample.java:6)

// Java 14+ çš„å¢å¼ºé”™è¯¯ä¿¡æ¯
// java.lang.NullPointerException: Cannot invoke "Profile.getAddress()" 
//     because the return value of "User.getProfile()" is null
//     at ChainedCallExample.main(ChainedCallExample.java:6)
```

**2. æ•°ç»„è®¿é—®**
```java
public class ArrayAccessExample {
    public static void main(String[] args) {
        String[][] matrix = new String[3][];
        
        // è¿™è¡Œä¼šæŠ›å‡º NPE
        int length = matrix[1].length;
        System.out.println(length);
    }
}

// Java 13 åŠä»¥å‰
// java.lang.NullPointerException
//     at ArrayAccessExample.main(ArrayAccessExample.java:6)

// Java 14+
// java.lang.NullPointerException: Cannot read the array length 
//     because "matrix[1]" is null
//     at ArrayAccessExample.main(ArrayAccessExample.java:6)
```

**3. å­—æ®µè®¿é—®**
```java
public class FieldAccessExample {
    private static class Container {
        String value;
    }
    
    public static void main(String[] args) {
        Container container = null;
        
        // è¿™è¡Œä¼šæŠ›å‡º NPE
        System.out.println(container.value);
    }
}

// Java 13 åŠä»¥å‰
// java.lang.NullPointerException
//     at FieldAccessExample.main(FieldAccessExample.java:9)

// Java 14+
// java.lang.NullPointerException: Cannot read field "value" 
//     because "container" is null
//     at FieldAccessExample.main(FieldAccessExample.java:9)
```

**4. æ•°ç»„å…ƒç´ èµ‹å€¼**
```java
public class ArrayAssignmentExample {
    public static void main(String[] args) {
        int[][] matrix = new int[3][];
        
        // è¿™è¡Œä¼šæŠ›å‡º NPE
        matrix[0][1] = 42;
    }
}

// Java 14+ å¢å¼ºé”™è¯¯ä¿¡æ¯
// java.lang.NullPointerException: Cannot store to int array 
//     because "matrix[0]" is null
//     at ArrayAssignmentExample.main(ArrayAssignmentExample.java:6)
```

**5. synchronized è¯­å¥**
```java
public class SynchronizedExample {
    public static void main(String[] args) {
        Object lock = null;
        
        // è¿™è¡Œä¼šæŠ›å‡º NPE
        synchronized (lock) {
            System.out.println("ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ");
        }
    }
}

// Java 14+ å¢å¼ºé”™è¯¯ä¿¡æ¯
// java.lang.NullPointerException: Cannot enter synchronized block 
//     because "lock" is null
//     at SynchronizedExample.main(SynchronizedExample.java:6)
```

#### å¤æ‚åœºæ™¯ç¤ºä¾‹

**æ¶‰åŠæ³›å‹å’Œé›†åˆ**
```java
import java.util.*;

public class ComplexExample {
    public static void main(String[] args) {
        Map<String, List<Person>> groups = new HashMap<>();
        groups.put("team1", null);
        
        // è¿™è¡Œä¼šæŠ›å‡ºè¯¦ç»†çš„ NPE
        int teamSize = groups.get("team1").size();
        System.out.println(teamSize);
    }
    
    static class Person {
        String name;
        Person(String name) { this.name = name; }
    }
}

// Java 14+ å¢å¼ºé”™è¯¯ä¿¡æ¯
// java.lang.NullPointerException: Cannot invoke "java.util.List.size()" 
//     because the return value of "java.util.Map.get(Object)" is null
//     at ComplexExample.main(ComplexExample.java:9)
```

**åµŒå¥—æ–¹æ³•è°ƒç”¨**
```java
public class NestedCallExample {
    public static void main(String[] args) {
        Calculator calc = new Calculator();
        
        // å¤æ‚çš„åµŒå¥—è°ƒç”¨
        double result = calc.getOperations().getAdvanced().sqrt(
            calc.getMemory().recall().getValue()
        );
        System.out.println(result);
    }
    
    static class Calculator {
        public Operations getOperations() { return new Operations(); }
        public Memory getMemory() { return null; } // è¿”å› null
    }
    
    static class Operations {
        public Advanced getAdvanced() { return new Advanced(); }
    }
    
    static class Advanced {
        public double sqrt(double value) { return Math.sqrt(value); }
    }
    
    static class Memory {
        public StoredValue recall() { return new StoredValue(42.0); }
    }
    
    static class StoredValue {
        private double value;
        StoredValue(double value) { this.value = value; }
        public double getValue() { return value; }
    }
}

// Java 14+ å¢å¼ºé”™è¯¯ä¿¡æ¯
// java.lang.NullPointerException: Cannot invoke "NestedCallExample$Memory.recall()" 
//     because the return value of "NestedCallExample$Calculator.getMemory()" is null
//     at NestedCallExample.main(NestedCallExample.java:7)
```

#### å¦‚ä½•å¯ç”¨/ç¦ç”¨

**JVM å‚æ•°æ§åˆ¶**
```bash
# å¯ç”¨è¯¦ç»† NPE ä¿¡æ¯ï¼ˆJava 14+ é»˜è®¤å¯ç”¨ï¼‰
java -XX:+ShowCodeDetailsInExceptionMessages MyClass

# ç¦ç”¨è¯¦ç»† NPE ä¿¡æ¯
java -XX:-ShowCodeDetailsInExceptionMessages MyClass

# æŸ¥çœ‹å½“å‰è®¾ç½®
java -XX:+PrintFlagsFinal | grep ShowCodeDetailsInExceptionMessages
```

#### å®é™…å¼€å‘ä¸­çš„ä»·å€¼

**1. å¿«é€Ÿé—®é¢˜å®šä½**
```java
// åœ¨å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ä¸­å¿«é€Ÿå®šä½é—®é¢˜
public class BusinessLogicExample {
    public void processOrder(Order order) {
        // è¿™é‡Œæœ‰å¾ˆå¤šé“¾å¼è°ƒç”¨
        String customerEmail = order.getCustomer()
                                   .getContactInfo()
                                   .getEmailAddress()
                                   .toLowerCase();
        
        // æœ‰äº†è¯¦ç»†çš„ NPE ä¿¡æ¯ï¼Œèƒ½ç«‹åˆ»çŸ¥é“æ˜¯å“ªä¸€æ­¥å‡ºäº†é—®é¢˜
        sendConfirmationEmail(customerEmail);
    }
}
```

**2. å•å…ƒæµ‹è¯•è°ƒè¯•**
```java
@Test
public void testComplexDataProcessing() {
    DataProcessor processor = new DataProcessor();
    
    // åœ¨æµ‹è¯•ä¸­å¦‚æœå‡ºç° NPEï¼Œç°åœ¨èƒ½æ›´å®¹æ˜“å®šä½é—®é¢˜
    Result result = processor.process(
        mockData.getDataSet()
                .getRecords()
                .stream()
                .filter(record -> record.isValid())
                .collect(Collectors.toList())
    );
    
    assertNotNull(result);
}
```

**3. ç”Ÿäº§é—®é¢˜è¯Šæ–­**
```java
// åœ¨ç”Ÿäº§ç¯å¢ƒçš„æ—¥å¿—ä¸­ï¼Œç°åœ¨èƒ½çœ‹åˆ°æ›´æœ‰ç”¨çš„ä¿¡æ¯
public class ProductionExample {
    public void handleRequest(HttpServletRequest request) {
        try {
            User user = sessionManager.getUser(request.getSession())
                                     .orElseThrow(() -> new UnauthorizedException());
            
            String preference = user.getSettings()
                                   .getDisplaySettings()
                                   .getTheme();
            
            renderPage(preference);
        } catch (NullPointerException e) {
            // ç°åœ¨æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºå…·ä½“æ˜¯å“ªä¸ªå¯¹è±¡ä¸º null
            logger.error("å¤„ç†è¯·æ±‚æ—¶å‡ºé”™: {}", e.getMessage(), e);
            response.sendError(500, "å†…éƒ¨é”™è¯¯");
        }
    }
}
```

#### æ€§èƒ½å½±å“å’Œè€ƒè™‘

**æ€§èƒ½æµ‹è¯•ç»“æœ**
*   æ— æ˜æ˜¾çš„è¿è¡Œæ—¶æ€§èƒ½å½±å“
*   é”™è¯¯ä¿¡æ¯ç”Ÿæˆåªåœ¨æŠ›å‡ºå¼‚å¸¸æ—¶å‘ç”Ÿ
*   å¯¹æ­£å¸¸ä»£ç æ‰§è¡Œæ— å½±å“

**é€‚ç”¨åœºæ™¯**
*   å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒï¼ˆå¼ºçƒˆæ¨èå¯ç”¨ï¼‰
*   ç”Ÿäº§ç¯å¢ƒçš„é—®é¢˜è¯Šæ–­
*   åˆå­¦è€…å­¦ä¹  Java
*   ä»£ç å®¡æŸ¥å’Œè°ƒè¯•

**ä¸é€‚ç”¨åœºæ™¯**
*   å¯¹å®‰å…¨æå…¶æ•æ„Ÿçš„ç¯å¢ƒï¼ˆå¯èƒ½æ³„éœ²ä»£ç ç»“æ„ä¿¡æ¯ï¼‰
*   è¶…é«˜æ€§èƒ½è¦æ±‚çš„åœºæ™¯ï¼ˆå¯è€ƒè™‘ç¦ç”¨ï¼‰

#### æœ€ä½³å®è·µ

1. **å¼€å‘ç¯å¢ƒå§‹ç»ˆå¯ç”¨**: å¯æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡
2. **æ—¥å¿—è®°å½•**: å°†è¯¦ç»†é”™è¯¯ä¿¡æ¯è®°å½•åœ¨æ—¥å¿—ä¸­
3. **é˜²å¾¡å¼ç¼–ç¨‹**: ä»ç„¶éœ€è¦ä¸»åŠ¨è¿›è¡Œ null æ£€æŸ¥
4. **å•å…ƒæµ‹è¯•**: åˆ©ç”¨è¯¦ç»†ä¿¡æ¯ä¼˜åŒ–æµ‹è¯•ç”¨ä¾‹
5. **å›¢é˜Ÿåˆ†äº«**: å‘å›¢é˜Ÿæˆå‘˜ç§‘æ™®è¿™ä¸€ç‰¹æ€§çš„ä»·å€¼

æ›´è¯¦å°½çš„ NullPointerException æ˜¯ Java å¹³å°çš„ä¸€ä¸ªé‡è¦æ”¹è¿›ï¼Œæ˜¾è‘—æå‡äº†å¼€å‘è€…çš„è°ƒè¯•ä½“éªŒã€‚

### 26. é£è¡Œè®°å½•å™¨ (JFR) (Java 11)

*   **æ¼”è¿›**: åœ¨ Java 11 æˆä¸ºæ­£å¼ç‰¹æ€§ï¼Œä¹‹å‰æ˜¯ Oracle JDK çš„å•†ä¸šç‰¹æ€§ã€‚
*   **æ ¸å¿ƒç†å¿µ**: æä¾›ä½å¼€é”€ã€ç”Ÿäº§å¯ç”¨çš„åº”ç”¨ç¨‹åºæ€§èƒ½ç›‘æ§å’Œé—®é¢˜è¯Šæ–­å·¥å…·ã€‚
*   **æ ¸å¿ƒä¼˜åŠ¿**:
    *   **ä½å¼€é”€**: é€šå¸¸ä»…å¢åŠ  1-3% çš„æ€§èƒ½å¼€é”€ã€‚
    *   **ç”Ÿäº§å¯ç”¨**: å¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®‰å…¨ä½¿ç”¨ã€‚
    *   **å…¨é¢ç›‘æ§**: æ¶µç›–å†…å­˜ã€CPUã€I/Oã€é”ç­‰å„ä¸ªæ–¹é¢ã€‚
    *   **å®æ—¶åˆ†æ**: æä¾›å®æ—¶çš„æ€§èƒ½æ•°æ®å’Œé—®é¢˜è­¦å‘Šã€‚

#### JFR çš„æ ¸å¿ƒæ¦‚å¿µ

**äº‹ä»¶ï¼ˆEventsï¼‰**
*   JFR åŸºäºäº‹ä»¶çš„æ•°æ®æ”¶é›†æ¨¡å‹
*   æ¯ä¸ªäº‹ä»¶åŒ…å«æ—¶é—´æˆ³ã€çº¿ç¨‹ä¿¡æ¯å’Œå…·ä½“æ•°æ®
*   å†…ç½®æ•°ç™¾ç§é¢„å®šä¹‰äº‹ä»¶ç±»å‹

**è®°å½•ï¼ˆRecordingï¼‰**
*   ä¸€æ¬¡æ•°æ®æ”¶é›†çš„ä¼šè¯
*   å¯ä»¥è®¾ç½®æ”¶é›†çš„æ—¶é—´ã€äº‹ä»¶ç±»å‹å’Œç­‰çº§
*   æ”¯æŒæŒç»­è®°å½•å’Œå®šæ—¶è®°å½•

**é…ç½®æ–‡ä»¶ï¼ˆProfilesï¼‰**
*   é¢„å®šä¹‰çš„äº‹ä»¶é›†åˆå’Œè®¾ç½®
*   å†…ç½® `default` å’Œ `profile` ä¸¤ç§é…ç½®

#### åŸºæœ¬ä½¿ç”¨æ–¹æ³•

**1. å‘½ä»¤è¡Œå¯åŠ¨ JFR**
```bash
# åŸºæœ¬è®°å½•å‘½ä»¤
java -XX:+FlightRecorder \
     -XX:StartFlightRecording=duration=60s,filename=myapp.jfr \
     MyApplication

# ä½¿ç”¨ç‰¹å®šé…ç½®
java -XX:+FlightRecorder \
     -XX:StartFlightRecording=duration=5m,filename=profiling.jfr,settings=profile \
     MyApplication

# æŒç»­è®°å½•ï¼ˆæ‰‹åŠ¨åœæ­¢ï¼‰
java -XX:+FlightRecorder \
     -XX:StartFlightRecording=filename=continuous.jfr \
     MyApplication
```

**2. ç¨‹åºåŒ–æ§åˆ¶**
```java
import jdk.jfr.*;

public class JfrProgrammaticExample {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºè®°å½•
        Recording recording = new Recording();
        
        // é…ç½®è®°å½•
        recording.setDuration(Duration.ofMinutes(1));
        recording.setDestination(Paths.get("app-recording.jfr"));
        
        // å¯ç”¨ç‰¹å®šäº‹ä»¶
        recording.enable("jdk.GarbageCollection");
        recording.enable("jdk.JavaMonitorEnter");
        recording.enable("jdk.FileRead");
        recording.enable("jdk.FileWrite");
        
        // å¼€å§‹è®°å½•
        recording.start();
        
        // æ¨¡æ‹Ÿä¸€äº›å·¥ä½œè´Ÿè½½
        performBusinessLogic();
        
        // åœæ­¢è®°å½•
        recording.stop();
        
        System.out.println("è®°å½•å·²ä¿å­˜åˆ°: " + recording.getDestination());
    }
    
    private static void performBusinessLogic() throws InterruptedException {
        // æ¨¡æ‹Ÿä¸€äº› CPU å¯†é›†å’Œ I/O å¯†é›†çš„æ“ä½œ
        for (int i = 0; i < 1000; i++) {
            // CPU å¯†é›†æ“ä½œ
            double result = Math.sqrt(Math.random() * 1000000);
            
            // å†…å­˜åˆ†é…
            List<String> tempList = new ArrayList<>();
            for (int j = 0; j < 100; j++) {
                tempList.add("æµ‹è¯•æ•°æ®-" + j);
            }
            
            Thread.sleep(10);
        }
    }
}
```

**3. è‡ªå®šä¹‰äº‹ä»¶**
```java
import jdk.jfr.*;

// å®šä¹‰è‡ªå®šä¹‰äº‹ä»¶
@Name("com.example.UserLogin")
@Label("ç”¨æˆ·ç™»å½•äº‹ä»¶")
@Description("è®°å½•ç”¨æˆ·ç™»å½•ç›¸å…³ä¿¡æ¯")
@Category("Application")
public class UserLoginEvent extends Event {
    @Label("ç”¨æˆ·ID")
    public String userId;
    
    @Label("ç™»å½•æ–¹å¼")
    public String loginMethod;
    
    @Label("æˆåŠŸæ ‡å¿—")
    public boolean success;
    
    @Label("å“åº”æ—¶é—´(ms)")
    public long responseTime;
}

// ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶
public class UserService {
    public boolean authenticateUser(String userId, String password, String method) {
        // åˆ›å»ºäº‹ä»¶å®ä¾‹
        UserLoginEvent event = new UserLoginEvent();
        event.userId = userId;
        event.loginMethod = method;
        event.begin(); // å¼€å§‹è®°å½•æ—¶é—´
        
        long startTime = System.currentTimeMillis();
        
        try {
            // æ¨¡æ‹Ÿè®¤è¯é€»è¾‘
            boolean authenticated = performAuthentication(userId, password);
            
            event.success = authenticated;
            event.responseTime = System.currentTimeMillis() - startTime;
            
            return authenticated;
            
        } finally {
            // æäº¤äº‹ä»¶
            event.commit();
        }
    }
    
    private boolean performAuthentication(String userId, String password) {
        // æ¨¡æ‹Ÿè®¤è¯é€»è¾‘
        try {
            Thread.sleep(50); // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢æ—¶é—´
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return Math.random() > 0.1; // 90% æˆåŠŸç‡
    }
}
```

#### JFR æ•°æ®åˆ†æå·¥å…·

**1. Java Mission Control (JMC)**
```bash
# ä¸‹è½½å¹¶å¯åŠ¨ JMC
# https://jdk.java.net/jmc/
jmc

# æˆ–è€…ä½¿ç”¨ Java 8 è‡ªå¸¦çš„ç‰ˆæœ¬
jmc &
```

**JMC ä¸»è¦åŠŸèƒ½**:
*   æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿
*   CPU ä½¿ç”¨ç‡åˆ†æ
*   å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶åˆ†æ
*   çº¿ç¨‹å’Œé”åˆ†æ
*   I/O æ“ä½œåˆ†æ
*   è‡ªå®šä¹‰äº‹ä»¶è§†å›¾

**2. å‘½ä»¤è¡Œåˆ†æå·¥å…·**
```bash
# ä½¿ç”¨ jfr å‘½ä»¤è¡Œå·¥å…·
# æ‰“å°è®°å½•æ‘˜è¦
jfr print --events CPULoad,GarbageCollection myapp.jfr

# æŒ‰äº‹ä»¶ç±»å‹ç»Ÿè®¡
jfr summary myapp.jfr

# è½¬æ¢ä¸º JSON æ ¼å¼
jfr print --json --events jdk.GarbageCollection myapp.jfr > gc_events.json

# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨äº‹ä»¶ç±»å‹
jfr metadata myapp.jfr
```

#### å¸¸ç”¨ç›‘æ§åœºæ™¯

**1. æ€§èƒ½é—®é¢˜è¯Šæ–­**
```java
// æ¨¡æ‹Ÿæ€§èƒ½é—®é¢˜çš„ä»£ç 
public class PerformanceIssueExample {
    private static final Random random = new Random();
    
    public static void main(String[] args) {
        // å¯åŠ¨ JFR è®°å½•
        startRecording();
        
        // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„æ€§èƒ½é—®é¢˜
        for (int i = 0; i < 1000; i++) {
            if (i % 100 == 0) {
                System.out.println("å¤„ç†è¿›åº¦: " + (i * 100 / 1000) + "%");
            }
            
            // CPU å¯†é›†æ“ä½œ
            performCpuIntensiveTask();
            
            // å†…å­˜åˆ†é…
            createTemporaryObjects();
            
            // I/O æ“ä½œ
            performIoOperation();
            
            // çº¿ç¨‹åŒæ­¥
            performSynchronizedOperation();
        }
    }
    
    private static void startRecording() {
        try {
            Recording recording = new Recording();
            recording.enable("jdk.CPULoad").withPeriod(Duration.ofSeconds(1));
            recording.enable("jdk.GarbageCollection");
            recording.enable("jdk.JavaMonitorEnter");
            recording.enable("jdk.FileRead");
            recording.enable("jdk.FileWrite");
            recording.setDestination(Paths.get("performance-analysis.jfr"));
            recording.start();
            
            // æ³¨å†Œå…³é—­é’©å­
            Runtime.getRuntime().addShutdownHook(new Thread(() -> {
                recording.stop();
                System.out.println("æ€§èƒ½è®°å½•å·²ä¿å­˜åˆ°: performance-analysis.jfr");
            }));
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private static void performCpuIntensiveTask() {
        // æ¨¡æ‹Ÿ CPU å¯†é›†è®¡ç®—
        double result = 0;
        for (int i = 0; i < 10000; i++) {
            result += Math.sqrt(Math.random() * 1000);
        }
    }
    
    private static void createTemporaryObjects() {
        // æ¨¡æ‹Ÿå¤§é‡å¯¹è±¡åˆ›å»º
        List<String> tempData = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            tempData.add("ä¸´æ—¶æ•°æ®-" + i + "-" + System.nanoTime());
        }
        // tempData å°†è¢« GC å›æ”¶
    }
    
    private static void performIoOperation() {
        try {
            // æ¨¡æ‹Ÿæ–‡ä»¶ I/O
            Path tempFile = Files.createTempFile("jfr-test", ".tmp");
            Files.write(tempFile, "test data".getBytes());
            Files.readAllLines(tempFile);
            Files.delete(tempFile);
        } catch (Exception e) {
            // å¿½ç•¥é”™è¯¯
        }
    }
    
    private static final Object lock = new Object();
    
    private static void performSynchronizedOperation() {
        synchronized (lock) {
            try {
                Thread.sleep(1); // æ¨¡æ‹ŸåŒæ­¥æ“ä½œ
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
```

**2. å†…å­˜æ³„éœ²æ£€æµ‹**
```java
@Name("com.example.MemoryLeak")
@Label("å†…å­˜æ³„éœ²æ£€æµ‹")
@Category("Memory")
public class MemoryLeakEvent extends Event {
    @Label("å¯¹è±¡ç±»å‹")
    public String objectType;
    
    @Label("åˆ†é…å¤§å°")
    public long allocationSize;
    
    @Label("å †ä½¿ç”¨ç‡")
    public double heapUsagePercent;
}

public class MemoryLeakDetector {
    private static final List<byte[]> leakyList = new ArrayList<>();
    
    public static void simulateMemoryLeak() {
        MemoryLeakEvent event = new MemoryLeakEvent();
        event.begin();
        
        try {
            // æ¨¡æ‹Ÿå†…å­˜æ³„éœ²
            for (int i = 0; i < 100; i++) {
                byte[] data = new byte[1024 * 1024]; // 1MB
                leakyList.add(data); // æŒç»­æ·»åŠ ï¼Œä¸é‡Šæ”¾
            }
            
            // è®°å½•äº‹ä»¶ä¿¡æ¯
            event.objectType = "byte[]";
            event.allocationSize = leakyList.size() * 1024 * 1024;
            
            MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
            MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
            event.heapUsagePercent = (double) heapUsage.getUsed() / heapUsage.getMax() * 100;
            
        } finally {
            event.commit();
        }
    }
}
```

#### ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

**1. JFR é…ç½®ç­–ç•¥**
```bash
# ä½å¼€é”€é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
java -XX:+FlightRecorder \
     -XX:StartFlightRecording=duration=30m,filename=prod-monitoring.jfr,settings=default \
     -XX:FlightRecorderOptions=disk=true,maxchunksize=10M \
     MyProductionApp

# è¯¦ç»†åˆ†æé…ç½®ï¼ˆé—®é¢˜è¯Šæ–­æ—¶ä½¿ç”¨ï¼‰
java -XX:+FlightRecorder \
     -XX:StartFlightRecording=duration=5m,filename=detailed-analysis.jfr,settings=profile \
     MyProductionApp
```

**2. ç›‘æ§è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# jfr-monitoring.sh

APP_PID=$(pgrep -f "MyProductionApp")
RECORDING_DIR="/var/log/jfr"
DATE_SUFFIX=$(date +"%Y%m%d_%H%M%S")

if [ -z "$APP_PID" ]; then
    echo "æ‰¾ä¸åˆ°åº”ç”¨è¿›ç¨‹"
    exit 1
fi

mkdir -p $RECORDING_DIR

# å¯åŠ¨ 30 åˆ†é’Ÿçš„è®°å½•
jcmd $APP_PID JFR.start name=monitoring_$DATE_SUFFIX \
    duration=30m filename=$RECORDING_DIR/monitoring_$DATE_SUFFIX.jfr \
    settings=default

echo "JFR è®°å½•å·²å¯åŠ¨ï¼Œè®°å½•æ–‡ä»¶: $RECORDING_DIR/monitoring_$DATE_SUFFIX.jfr"

# ç­‰å¾…è®°å½•å®Œæˆ
sleep 1800  # 30 åˆ†é’Ÿ

# ç”Ÿæˆç®€å•çš„åˆ†ææŠ¥å‘Š
jfr summary $RECORDING_DIR/monitoring_$DATE_SUFFIX.jfr > $RECORDING_DIR/summary_$DATE_SUFFIX.txt

echo "ç›‘æ§å®Œæˆï¼ŒæŠ¥å‘Šæ–‡ä»¶: $RECORDING_DIR/summary_$DATE_SUFFIX.txt"
```

**3. è‡ªåŠ¨åŒ–ç›‘æ§å’Œè­¦å‘Š**
```java
public class JfrAlertingSystem {
    public static void main(String[] args) throws Exception {
        // å¯åŠ¨ç›‘æ§è®°å½•
        Recording alertRecording = new Recording();
        alertRecording.enable("jdk.GarbageCollection");
        alertRecording.enable("jdk.CPULoad").withPeriod(Duration.ofSeconds(1));
        alertRecording.enable("jdk.JavaMonitorEnter");
        
        // è®¾ç½®æŒç»­è®°å½•
        alertRecording.setMaxAge(Duration.ofHours(1)); // ä¿æŒ 1 å°æ—¶çš„æ•°æ®
        alertRecording.start();
        
        // å®šæœŸæ£€æŸ¥å’Œè­¦å‘Š
        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
        scheduler.scheduleAtFixedRate(() -> {
            try {
                checkPerformanceMetrics(alertRecording);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, 0, 30, TimeUnit.SECONDS);
        
        // ä¿æŒè¿è¡Œ
        Thread.currentThread().join();
    }
    
    private static void checkPerformanceMetrics(Recording recording) {
        // è¿™é‡Œå¯ä»¥å®ç°å®æ—¶æ•°æ®åˆ†æå’Œè­¦å‘Šé€»è¾‘
        // ä¾‹å¦‚ï¼šGC é¢‘ç¹ã€CPU è¿‡é«˜ã€é”ç«äº‰ç­‰
        System.out.println("æ‰§è¡Œæ€§èƒ½æ£€æŸ¥ - " + new Date());
        
        // å®é™…å®ç°ä¸­ï¼Œå¯ä»¥é€šè¿‡ JFR API è¯»å–å®æ—¶æ•°æ®
        // å¹¶æ ¹æ®é˜ˆå€¼å‘é€è­¦å‘Š
    }
}
```

#### ä¸å…¶ä»–å·¥å…·çš„å¯¹æ¯”

| ç‰¹æ€§ | JFR | JProfiler | YourKit | VisualVM |
|------|-----|-----------|---------|----------|
| å¼€é”€ | æä½(1-3%) | ä¸­ç­‰(5-15%) | ä¸­ç­‰(5-15%) | ä½(2-5%) |
| ç”Ÿäº§ç¯å¢ƒ | âœ“ | âœ— | âœ— | âœ“ |
| è¯¦ç»†ç¨‹åº¦ | é«˜ | éå¸¸é«˜ | éå¸¸é«˜ | ä¸­ç­‰ |
| æ˜“ç”¨æ€§ | ä¸­ç­‰ | é«˜ | é«˜ | é«˜ |
| æˆæœ¬ | å…è´¹ | å•†ä¸š | å•†ä¸š | å…è´¹ |

Java Flight Recorder æ˜¯ç°ä»£ Java åº”ç”¨æ€§èƒ½ç›‘æ§å’Œé—®é¢˜è¯Šæ–­çš„å¼ºå¤§å·¥å…·ï¼Œç‰¹åˆ«é€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

---

[**ğŸ”™ è¿”å›ç›®å½•**](#ğŸ“‹-è¯¦ç»†ç›®å½•) | [**â¬†ï¸ å›åˆ°é¡¶éƒ¨**](#java-æ–°ç‰¹æ€§å®æ“æ‰‹å†Œ-java-8---24)

---

## ğŸ“š ç»“è¯­

è¿™ä»½ Java æ–°ç‰¹æ€§å®æ“æ‰‹å†Œæ¶µç›–äº†ä» Java 8 åˆ° Java 24 çš„ 26 ä¸ªæ ¸å¿ƒç‰¹æ€§ï¼Œæ¯ä¸ªç‰¹æ€§éƒ½åŒ…å«ï¼š

- ğŸ“– **è¯¦å°½çš„ç†è®ºè§£é‡Š**ï¼šèƒŒæ™¯ã€åŠ¨æœºã€æ ¸å¿ƒæ¦‚å¿µ
- ğŸ’» **å®Œæ•´çš„ä»£ç ç¤ºä¾‹**ï¼šå¯ç›´æ¥è¿è¡Œçš„å®é™…ä»£ç 
- âš¡ **æœ€ä½³å®è·µæŒ‡å¯¼**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨å»ºè®®
- ğŸ” **æ·±å…¥åˆ†æå¯¹æ¯”**ï¼šä¸ä¼ ç»Ÿæ–¹æ¡ˆçš„ä¼˜åŠ£å¯¹æ¯”
- ğŸ¯ **å®é™…åº”ç”¨åœºæ™¯**ï¼šçœŸå®ä¸šåŠ¡ä¸­çš„ä½¿ç”¨æ¡ˆä¾‹

å¸Œæœ›è¿™ä»½æ‰‹å†Œèƒ½å¤Ÿæˆä¸ºä½  Java å­¦ä¹ å’Œå¼€å‘è·¯ä¸Šçš„å¾—åŠ›åŠ©æ‰‹ï¼

> **ğŸ’¡ æŒç»­æ›´æ–°**  
> Java å¹³å°æŒç»­æ¼”è¿›ï¼Œæˆ‘ä»¬ä¹Ÿä¼šä¸æ–­æ›´æ–°è¿™ä»½æ–‡æ¡£ï¼ŒåŠ å…¥æœ€æ–°çš„ç‰¹æ€§å’Œæœ€ä½³å®è·µã€‚

**Happy Coding! ğŸš€**